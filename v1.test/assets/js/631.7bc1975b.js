(window.webpackJsonp=window.webpackJsonp||[]).push([[631],{3349:function(t,a,s){"use strict";s.r(a);var e=s(19),n=Object(e.a)({},(function(){var t=this,a=t.$createElement,e=t._self._c||a;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("h1",{attrs:{id:"mavros-offboard-control-example-python"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#mavros-offboard-control-example-python"}},[t._v("#")]),t._v(" MAVROS "),e("em",[t._v("Offboard")]),t._v(" control example (Python)")]),t._v(" "),e("p",[t._v("This tutorial shows the basics of "),e("em",[t._v("OFFBOARD")]),t._v(" control with MAVROS Python, using an Iris quadcopter simulated in "),e("RouterLink",{attrs:{to:"/uk/sim_gazebo_classic/"}},[t._v("Gazebo Classic")]),t._v(". It provides step-by-step instructions demonstrating how to start developing programs to control a vehicle and running the code in simulation.")],1),t._v(" "),e("p",[t._v("At the end of the tutorial, you should see the same behaviour as in the video below, i.e. a slow takeoff to an altitude of 2 meters.")]),t._v(" "),e("div",{staticClass:"custom-block warning"},[e("p",{staticClass:"custom-block-title"},[t._v("WARNING")]),t._v(" "),e("p",[e("em",[t._v("OFFBOARD")]),t._v(" control is dangerous. If you are operating on a real vehicle be sure to have a way of gaining back manual control in case something goes wrong.")])]),t._v(" "),e("div",{staticClass:"custom-block tip"},[e("p",{staticClass:"custom-block-title"},[t._v("TIP")]),t._v(" "),e("p",[t._v("This example uses Python. Other examples in Python can be found here: "),e("a",{attrs:{href:"https://github.com/PX4/PX4-Autopilot/tree/main/integrationtests/python_src/px4_it/mavros",target:"_blank",rel:"noopener noreferrer"}},[t._v("integrationtests/python_src/px4_it/mavros"),e("OutboundLink")],1),t._v(".")])]),t._v(" "),e("p",[e("a",{attrs:{id:"offb_video"}})]),t._v(" "),e("video",{attrs:{width:"100%",autoplay:"true",controls:"true"}},[e("source",{attrs:{src:s(418),type:"video/webm"}})]),t._v(" "),e("h2",{attrs:{id:"creating-the-ros-package"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#creating-the-ros-package"}},[t._v("#")]),t._v(" Creating the ROS Package")]),t._v(" "),e("ol",[e("li",[e("p",[t._v("Open the terminal and go to "),e("code",[t._v("~/catkin_ws/src")]),t._v(" directory")]),t._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[t._v("\n\n")])])])]),t._v(" "),e("li",[e("p",[t._v("In the "),e("code",[t._v("~/catkin_ws/src")]),t._v(" directory create a new package named "),e("code",[t._v("offboard_py")]),t._v(" (in this case) with the "),e("code",[t._v("rospy")]),t._v(" dependency:")]),t._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[t._v("\n")])])])]),t._v(" "),e("li",[e("p",[t._v("Build the new package in the "),e("code",[t._v("~/catkin_ws/")]),t._v(" directory:")]),t._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("..")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Assuming previous directory to be ~/catkin_ws/src")]),t._v("\ncatkin build\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("source")]),t._v(" devel/setup.bash\n")])])])]),t._v(" "),e("li",[e("p",[t._v("You should now be able to cd into the package by using:")]),t._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[t._v("\n")])])])]),t._v(" "),e("li",[e("p",[t._v("To store your Python files, create a new folder called "),e("code",[t._v("/scripts")]),t._v(" on the package:")]),t._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[t._v("\n")])])])])]),t._v(" "),e("h2",{attrs:{id:"code"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#code"}},[t._v("#")]),t._v(" Code")]),t._v(" "),e("p",[t._v("After creating the ROS package and scripts folder you are ready to start your Python script. Inside the scripts folder create the "),e("code",[t._v("offb_node.py")]),t._v(" file and give it executable permissions:")]),t._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[t._v("touch")]),t._v(" offb_node.py\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("chmod")]),t._v(" +x offb_node.py\n")])])]),e("p",[t._v("After that, open "),e("code",[t._v("offb_node.py")]),t._v(" file and paste the following code:")]),t._v(" "),e("div",{staticClass:"language-py extra-class"},[e("pre",{pre:!0,attrs:{class:"language-py"}},[e("code",[e("span",{pre:!0,attrs:{class:"token triple-quoted-string string"}},[t._v('"""\n * File: offb_node.py\n * Stack and tested in Gazebo Classic 9 SITL\n"""')]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#! ")]),t._v("\n\n")])])]),e("h2",{attrs:{id:"пояснення-коду"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#пояснення-коду"}},[t._v("#")]),t._v(" Пояснення коду")]),t._v(" "),e("p",[t._v("The "),e("code",[t._v("mavros_msgs")]),t._v(" package contains all of the custom messages required to operate services and topics provided by the MAVROS package. All services and topics as well as their corresponding message types are documented in the "),e("a",{attrs:{href:"http://wiki.ros.org/mavros",target:"_blank",rel:"noopener noreferrer"}},[t._v("mavros wiki"),e("OutboundLink")],1),t._v(".")]),t._v(" "),e("div",{staticClass:"language-py extra-class"},[e("pre",{pre:!0,attrs:{class:"language-py"}},[e("code",[t._v("\n")])])]),e("p",[t._v("We create a simple callback which will save the current state of the autopilot. This will allow us to check connection, arming and "),e("em",[t._v("OFFBOARD")]),t._v(" flags.:")]),t._v(" "),e("div",{staticClass:"language-py extra-class"},[e("pre",{pre:!0,attrs:{class:"language-py"}},[e("code",[t._v("\n")])])]),e("p",[t._v('We instantiate a publisher to publish the commanded local position and the appropriate clients to request arming and mode change. Note that for your own system, the "mavros" prefix might be different as it will depend on the name given to the node in it\'s launch file.')]),t._v(" "),e("div",{staticClass:"language-py extra-class"},[e("pre",{pre:!0,attrs:{class:"language-py"}},[e("code",[t._v("\n")])])]),e("p",[t._v("PX4 has a timeout of 500ms between two "),e("em",[t._v("OFFBOARD")]),t._v(" commands. If this timeout is exceeded, the commander will fall back to the last mode the vehicle was in before entering "),e("em",[t._v("OFFBOARD")]),t._v(" mode. This is why the publishing rate "),e("strong",[t._v("must")]),t._v(" be faster than 2 Hz to also account for possible latencies. This is also the same reason why it is "),e("strong",[t._v("recommended to enter "),e("em",[t._v("OFFBOARD")]),t._v(" mode from "),e("em",[t._v("Position")]),t._v(" mode")]),t._v(", this way if the vehicle drops out of "),e("em",[t._v("OFFBOARD")]),t._v(" mode it will stop in its tracks and hover.")]),t._v(" "),e("p",[t._v("Here we set the publishing rate appropriately:")]),t._v(" "),e("div",{staticClass:"language-py extra-class"},[e("pre",{pre:!0,attrs:{class:"language-py"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Setpoint publishing MUST be faster than 2Hz")]),t._v("\nrate "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" rospy"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Rate"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("20")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),e("p",[t._v("Before publishing anything, we wait for the connection to be established between MAVROS and the autopilot. This loop should exit as soon as a heartbeat message is received.")]),t._v(" "),e("div",{staticClass:"language-py extra-class"},[e("pre",{pre:!0,attrs:{class:"language-py"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Wait for Flight Controller connection")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("while")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("not")]),t._v(" rospy"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("is_shutdown"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("and")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("not")]),t._v(" current_state"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("connected"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    rate"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("sleep"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),e("p",[t._v("Even though PX4 operates in the aerospace NED coordinate frame, MAVROS translates these coordinates to the standard ENU frame and vice-versa. This is why we set "),e("code",[t._v("z")]),t._v(" to positive 2:")]),t._v(" "),e("div",{staticClass:"language-py extra-class"},[e("pre",{pre:!0,attrs:{class:"language-py"}},[e("code",[t._v("pose "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" PoseStamped"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\npose"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("pose"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("position"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("x "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\npose"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("pose"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("position"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("y "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\npose"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("pose"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("position"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("z "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("\n")])])]),e("p",[t._v("Before entering "),e("em",[t._v("OFFBOARD")]),t._v(" mode, you must have already started streaming setpoints. Otherwise the mode switch will be rejected. Below, "),e("code",[t._v("100")]),t._v(" was chosen as an arbitrary amount.")]),t._v(" "),e("div",{staticClass:"language-py extra-class"},[e("pre",{pre:!0,attrs:{class:"language-py"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Send a few setpoints before starting")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" i "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("range")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("rospy"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("is_shutdown"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("break")]),t._v("\n\n    local_pos_pub"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("publish"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("pose"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    rate"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("sleep"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),e("p",[t._v("We prepare the message request used to set the custom mode to "),e("code",[t._v("OFFBOARD")]),t._v(". A list of "),e("a",{attrs:{href:"http://wiki.ros.org/mavros/CustomModes#PX4_native_flight_stack",target:"_blank",rel:"noopener noreferrer"}},[t._v("supported modes"),e("OutboundLink")],1),t._v(" is available for reference.")]),t._v(" "),e("div",{staticClass:"language-py extra-class"},[e("pre",{pre:!0,attrs:{class:"language-py"}},[e("code",[t._v("offb_set_mode "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" SetModeRequest"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\noffb_set_mode"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("custom_mode "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'OFFBOARD'")]),t._v("\n")])])]),e("p",[t._v("The rest of the code is largely self explanatory. We attempt to switch to "),e("em",[t._v("Offboard")]),t._v(" mode, after which we arm the quad to allow it to fly. We space out the service calls by 5 seconds so to not flood the autopilot with the requests. In the same loop, we continue sending the requested pose at the rate previously defined.")]),t._v(" "),e("div",{staticClass:"language-py extra-class"},[e("pre",{pre:!0,attrs:{class:"language-py"}},[e("code",[t._v("arm_cmd "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" CommandBoolRequest"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\narm_cmd"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("value "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("True")]),t._v("\n\nlast_req "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" rospy"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Time"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("now"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("while")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("not")]),t._v(" rospy"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("is_shutdown"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("current_state"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("mode "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"OFFBOARD"')]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("and")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("rospy"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Time"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("now"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" last_req"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" rospy"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Duration"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("5.0")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("set_mode_client"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("call"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("offb_set_mode"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("mode_sent "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("True")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n            rospy"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("loginfo"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"OFFBOARD enabled"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n        last_req "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" rospy"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Time"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("now"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("not")]),t._v(" current_state"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("armed "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("and")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("rospy"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Time"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("now"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" last_req"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" rospy"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Duration"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("5.0")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n            "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("arming_client"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("call"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("arm_cmd"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("success "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("==")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("True")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n                rospy"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("loginfo"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Vehicle armed"')]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n            last_req "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" rospy"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Time"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("now"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n    local_pos_pub"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("publish"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("pose"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n    rate"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("sleep"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),e("div",{staticClass:"custom-block tip"},[e("p",{staticClass:"custom-block-title"},[t._v("TIP")]),t._v(" "),e("p",[t._v("This code has been simplified to the bare minimum for illustration purposes.\nIn larger systems, it is often useful to create a new thread which will be in charge of periodically publishing the setpoints.")])]),t._v(" "),e("h2",{attrs:{id:"creating-the-ros-launch-file"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#creating-the-ros-launch-file"}},[t._v("#")]),t._v(" Creating the ROS launch file")]),t._v(" "),e("p",[t._v("In your "),e("code",[t._v("offboard_py")]),t._v(" package, create another folder inside the "),e("code",[t._v("~/catkin_ws/src/offboard_py/src")]),t._v(" directory named "),e("code",[t._v("launch")]),t._v(". This is where your launch files for the package will be stored. After that, create your first launch file, in this case we will call it "),e("code",[t._v("start_offb.launch")]),t._v(".")]),t._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[t._v("roscd offboard_py\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" launch\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" launch\n"),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("touch")]),t._v(" start_offb.launch\n")])])]),e("p",[t._v("For the "),e("code",[t._v("start_offb.launch")]),t._v(" copy the following code:")]),t._v(" "),e("div",{staticClass:"language-xml extra-class"},[e("pre",{pre:!0,attrs:{class:"language-xml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token prolog"}},[t._v('<?xml version="1.0"?>')]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token tag"}},[e("span",{pre:!0,attrs:{class:"token tag"}},[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("launch")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("\x3c!-- Include the MAVROS node with SITL and Gazebo --\x3e")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token tag"}},[e("span",{pre:!0,attrs:{class:"token tag"}},[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("include")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("file")]),e("span",{pre:!0,attrs:{class:"token attr-value"}},[e("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("$(find px4)/launch/mavros_posix_sitl.launch"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token tag"}},[e("span",{pre:!0,attrs:{class:"token tag"}},[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("include")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n\n    "),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("\x3c!-- Our node to control the drone --\x3e")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token tag"}},[e("span",{pre:!0,attrs:{class:"token tag"}},[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("node")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("pkg")]),e("span",{pre:!0,attrs:{class:"token attr-value"}},[e("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("offboard_py"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),e("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("type")]),e("span",{pre:!0,attrs:{class:"token attr-value"}},[e("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("offb_node.py"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),e("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("name")]),e("span",{pre:!0,attrs:{class:"token attr-value"}},[e("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("offb_node_py"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),e("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("required")]),e("span",{pre:!0,attrs:{class:"token attr-value"}},[e("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("true"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),e("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("output")]),e("span",{pre:!0,attrs:{class:"token attr-value"}},[e("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("screen"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("/>")])]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token tag"}},[e("span",{pre:!0,attrs:{class:"token tag"}},[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("launch")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])])]),e("p",[t._v("As you can see, the "),e("code",[t._v("mavros_posix_sitl.launch")]),t._v(" file is included. This file is responsible for launching MAVROS, the PX4 SITL, the Gazebo Classic Environment and for spawning a vehicle in a given world (for further information see the file "),e("a",{attrs:{href:"https://github.com/PX4/PX4-Autopilot/blob/main/launch/mavros_posix_sitl.launch",target:"_blank",rel:"noopener noreferrer"}},[t._v("here"),e("OutboundLink")],1),t._v(").")]),t._v(" "),e("div",{staticClass:"custom-block tip"},[e("p",{staticClass:"custom-block-title"},[t._v("TIP")]),t._v(" "),e("p",[t._v("The "),e("code",[t._v("mavros_posix_sitl.launch")]),t._v(" file takes several arguments that can be set according to your preferences such as the vehicle to spawn or the Gazebo Classic world (refer to "),e("a",{attrs:{href:"https://github.com/PX4/PX4-Autopilot/blob/main/launch/mavros_posix_sitl.launch",target:"_blank",rel:"noopener noreferrer"}},[t._v("here"),e("OutboundLink")],1),t._v(") for a complete list).")]),t._v(" "),e("p",[t._v("You can override the default value of these arguments defined in "),e("code",[t._v("mavros_posix_sitl.launch")]),t._v(" by declaring them inside the "),e("em",[t._v("include")]),t._v(" tags. As an example, if you wanted to spawn the vehicle in the "),e("code",[t._v("warehouse.world")]),t._v(", you would write the following:")]),t._v(" "),e("div",{staticClass:"language-xml extra-class"},[e("pre",{pre:!0,attrs:{class:"language-xml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("\x3c!-- Include the MAVROS node with SITL and Gazebo --\x3e")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token tag"}},[e("span",{pre:!0,attrs:{class:"token tag"}},[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("include")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("file")]),e("span",{pre:!0,attrs:{class:"token attr-value"}},[e("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("$(find px4)/launch/mavros_posix_sitl.launch"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token tag"}},[e("span",{pre:!0,attrs:{class:"token tag"}},[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("arg")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("name")]),e("span",{pre:!0,attrs:{class:"token attr-value"}},[e("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("world"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),e("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("default")]),e("span",{pre:!0,attrs:{class:"token attr-value"}},[e("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("$(find mavlink_sitl_gazebo)/worlds/warehouse.world"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("/>")])]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token tag"}},[e("span",{pre:!0,attrs:{class:"token tag"}},[e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("include")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])])])]),t._v(" "),e("h2",{attrs:{id:"launching-your-script"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#launching-your-script"}},[t._v("#")]),t._v(" Launching your script")]),t._v(" "),e("p",[t._v("If everything is done, you should now be able to launch and test your script.")]),t._v(" "),e("p",[t._v("In the terminal write:")]),t._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[t._v("roslaunch offboard_py start_offb.launch\n")])])]),e("p",[t._v("You should now see the PX4 firmware initiating and the Gazebo Classic application running. After the "),e("em",[t._v("OFFBOARD")]),t._v(" mode is set and the vehicle is armed, the behavior shown in the "),e("a",{attrs:{href:"#offb_video"}},[t._v("video")]),t._v(" should be observed.")]),t._v(" "),e("div",{staticClass:"custom-block warning"},[e("p",{staticClass:"custom-block-title"},[t._v("WARNING")]),t._v(" "),e("p",[t._v("It is possible that when running the script an error appears saying:")]),t._v(" "),e("blockquote",[e("p",[t._v("Resource not found: px4 ROS path [0] = ... ...")])]),t._v(" "),e("p",[t._v("This means that PX4 SITL was not included in the path. To solve this add these lines at the end of the "),e("code",[t._v(".bashrc")]),t._v(" file:")]),t._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("source")]),t._v(" ~/PX4-Autopilot/Tools/simulation/gazebo/setup_gazebo.bash ~/PX4-Autopilot ~/PX4-Autopilot/build/px4_sitl_default\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("export")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("ROS_PACKAGE_PATH")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$ROS_PACKAGE_PATH")]),t._v(":~/PX4-Autopilot\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("export")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("ROS_PACKAGE_PATH")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$ROS_PACKAGE_PATH")]),t._v(":~/PX4-Autopilot/Tools/simulation/gazebo-classic/sitl_gazebo-classic\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("export")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("GAZEBO_PLUGIN_PATH")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),e("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$GAZEBO_PLUGIN_PATH")]),t._v(":/usr/lib/x86_64-linux-gnu/gazebo-9/plugins\n")])])]),e("p",[t._v("Now in the terminal, go to the home directory and run the following command to apply the changes above to the current terminal:")]),t._v(" "),e("div",{staticClass:"language-sh extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sh"}},[e("code",[e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("source")]),t._v(" .bashrc\n")])])]),e("p",[t._v("After this step, every time you open a new terminal window you should not have to worry about this error anymore. If it appears again, a simple "),e("code",[t._v("source .bashrc")]),t._v(" should fix it. This solution was obtained from this "),e("a",{attrs:{href:"https://github.com/mzahana/px4_fast_planner/issues/4",target:"_blank",rel:"noopener noreferrer"}},[t._v("issue"),e("OutboundLink")],1),t._v(" thread, where you can get more information about the problem.")])])])}),[],!1,null,null,null);a.default=n.exports},418:function(t,a,s){t.exports=s.p+"assets/media/gazebo_offboard.d8b1cf73.webm"}}]);