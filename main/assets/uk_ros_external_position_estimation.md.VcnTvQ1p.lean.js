import{_ as s}from"./chunks/ekf2_ev_delay_tuning.DPyJAJWg.js";import{_ as n}from"./chunks/ref_frames.YBU277-S.js";import{_ as l,c as r,a8 as o,j as t,a,o as i}from"./chunks/framework.BDnHobkS.js";const O=JSON.parse('{"title":"Використання Vision або Motion Capture систем для Position Estimation","description":"","frontmatter":{},"headers":[],"relativePath":"uk/ros/external_position_estimation.md","filePath":"uk/ros/external_position_estimation.md"}'),d={name:"uk/ros/external_position_estimation.md"},h={class:"MathJax",jax:"SVG",style:{direction:"ltr",position:"relative"}},m={style:{overflow:"visible","min-height":"1px","min-width":"1px","vertical-align":"-0.025ex"},xmlns:"http://www.w3.org/2000/svg",width:"1.294ex",height:"1.025ex",role:"img",focusable:"false",viewBox:"0 -442 572 453","aria-hidden":"true"},p={class:"MathJax",jax:"SVG",style:{direction:"ltr",position:"relative"}},c={style:{overflow:"visible","min-height":"1px","min-width":"1px","vertical-align":"-0.025ex"},xmlns:"http://www.w3.org/2000/svg",width:"1.052ex",height:"1.025ex",role:"img",focusable:"false",viewBox:"0 -442 465 453","aria-hidden":"true"};function f(_,e,g,u,b,k){return i(),r("div",null,[e[13]||(e[13]=o('<h1 id="використання-vision-або-motion-capture-систем-для-position-estimation" tabindex="-1">Використання Vision або Motion Capture систем для Position Estimation <a class="header-anchor" href="#використання-vision-або-motion-capture-систем-для-position-estimation" aria-label="Permalink to &quot;Використання Vision або Motion Capture систем для Position Estimation&quot;">​</a></h1><p>Системи візуальної інерційної одометрії (VIO) та захоплення руху (MoCap) дозволяють транспортним засобам здійснювати навігацію, коли джерело глобального позиціонування недоступне або ненадійне (наприклад, в приміщенні або під час прольоту під мостом. тощо).</p><p>Both VIO and MoCap determine a vehicle&#39;s <em>pose</em> (position and attitude) from &quot;visual&quot; information. Основна відмінність між ними - перспектива кадру:</p><ul><li>VIO uses <em>onboard sensors</em> to get pose data from the vehicle&#39;s perspective (see <a href="https://en.wikipedia.org/wiki/Visual_odometry#Egomotion" target="_blank" rel="noreferrer">egomotion</a>).</li><li>MoCap uses a system of <em>off-board cameras</em> to get vehicle pose data in a 3D space (i.e. it is an external system that tells the vehicle its pose).</li></ul><p>Дані про положення, отримані від обох типів систем, можуть бути використані для оновлення оцінки локального положення автопілота на базі PX4 (відносно локальної точки відліку), а також, за бажанням, можуть бути інтегровані в оцінку положення транспортного засобу. Крім того, якщо зовнішня система позиціонування також забезпечує вимірювання лінійної швидкості, її можна використовувати для покращення оцінки стану (об&#39;єднання вимірювань лінійної швидкості підтримується лише EKF2).</p><p>This topic explains how to configure a PX4-based system to get data from MoCap/VIO systems (either via ROS or some other MAVLink system) and more specifically how to set up MoCap systems like VICON and Optitrack, and vision-based estimation systems like <a href="https://github.com/ethz-asl/rovio" target="_blank" rel="noreferrer">ROVIO</a>, <a href="https://github.com/uzh-rpg/rpg_svo" target="_blank" rel="noreferrer">SVO</a> and <a href="https://github.com/ethz-asl/ethzasl_ptam" target="_blank" rel="noreferrer">PTAM</a>).</p><div class="info custom-block"><p class="custom-block-title">INFO</p><p>The instructions differ depending on whether you are using the EKF2 or LPE estimator.</p></div><h2 id="інтеграція-px4-з-mavlink" tabindex="-1">Інтеграція PX4 з MAVLink <a class="header-anchor" href="#інтеграція-px4-з-mavlink" aria-label="Permalink to &quot;Інтеграція PX4 з MAVLink&quot;">​</a></h2><p>PX4 uses the following MAVLink messages for getting external position information, and maps them to <a href="./../middleware/uorb.html">uORB topics</a>:</p><table tabindex="0"><thead><tr><th>MAVLink</th><th>uORB</th></tr></thead><tbody><tr><td><a href="https://mavlink.io/en/messages/common.html#VISION_POSITION_ESTIMATE" target="_blank" rel="noreferrer">VISION_POSITION_ESTIMATE</a></td><td><code>vehicle_visual_odometry</code></td></tr><tr><td><a href="https://mavlink.io/en/messages/common.html#ODOMETRY" target="_blank" rel="noreferrer">ODOMETRY</a> (<code>frame_id =</code> <a href="https://mavlink.io/en/messages/common.html#MAV_FRAME_LOCAL_FRD" target="_blank" rel="noreferrer">MAV_FRAME_LOCAL_FRD</a>)</td><td><code>vehicle_visual_odometry</code></td></tr><tr><td><a href="https://mavlink.io/en/messages/common.html#ATT_POS_MOCAP" target="_blank" rel="noreferrer">ATT_POS_MOCAP</a></td><td><code>vehicle_mocap_odometry</code></td></tr><tr><td><a href="https://mavlink.io/en/messages/common.html#ODOMETRY" target="_blank" rel="noreferrer">ODOMETRY</a> (<code>frame_id =</code> <a href="https://mavlink.io/en/messages/common.html#MAV_FRAME_MOCAP_NED" target="_blank" rel="noreferrer">MAV_FRAME_MOCAP_NED</a>)</td><td><code>vehicle_mocap_odometry</code></td></tr></tbody></table><p>EKF2 only subscribes to <code>vehicle_visual_odometry</code> topics and can hence only process the first two messages (a MoCap system must generate these messages to work with EKF2). Повідомлення odometry є єдиним повідомленням, яке може також відправляти лінійні швидкості в PX4. Оцінювач LPE підписується на обидві теми, тому може обробляти всі вищезазначені повідомлення.</p><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>EKF2 is the default estimator used by PX4. Він краще протестований і підтримується, ніж LPE, і його слід використовувати за умовчанням.</p></div><p>Повідомлення повинні транслюватися з частотою між 30 Гц (якщо містять коваріанти) і 50 Гц. Якщо частота повідомлень занадто низька, EKF2 не буде обробляти повідомлення з зовнішнього візуального спостереження.</p><p>The following MAVLink &quot;vision&quot; messages are not currently supported by PX4: <a href="https://mavlink.io/en/messages/common.html#GLOBAL_VISION_POSITION_ESTIMATE" target="_blank" rel="noreferrer">GLOBAL_VISION_POSITION_ESTIMATE</a>, <a href="https://mavlink.io/en/messages/common.html#VISION_SPEED_ESTIMATE" target="_blank" rel="noreferrer">VISION_SPEED_ESTIMATE</a>, <a href="https://mavlink.io/en/messages/common.html#VICON_POSITION_ESTIMATE" target="_blank" rel="noreferrer">VICON_POSITION_ESTIMATE</a></p><h2 id="основні-відмінності" tabindex="-1">Основні відмінності <a class="header-anchor" href="#основні-відмінності" aria-label="Permalink to &quot;Основні відмінності&quot;">​</a></h2><p>PX4 uses FRD (X <strong>F</strong>orward, Y <strong>R</strong>ight and Z <strong>D</strong>own) for the local body frame as well for the reference frame. When using the heading of the magnetometer, the PX4 reference frame x axis will be aligned with north, so therefore it is called NED (X <strong>N</strong>orth, Y <strong>E</strong>ast, Z <strong>D</strong>own). Напрямок опорного каркасу оцінювача PX4 та напрямок зовнішньої оцінки положення в більшості випадків не збігаються. Therefore the reference frame of the external pose estimate is named differently, it is called <a href="https://mavlink.io/en/messages/common.html#MAV_FRAME_LOCAL_FRD" target="_blank" rel="noreferrer">MAV_FRAME_LOCAL_FRD</a>.</p><p>Залежно від джерела вашого опорного каркасу, вам потрібно буде застосувати власне перетворення до оцінки положення перед надсиланням повідомлення MAVLink Vision/MoCap. Це необхідно для зміни орієнтації батьківського та дочірнього каркасу оцінки положення так, щоб вона відповідала конвенції PX4. Have a look at the MAVROS <a href="https://github.com/mavlink/mavros/blob/master/mavros_extras/src/plugins/odom.cpp" target="_blank" rel="noreferrer"><em>odom</em> plugin</a> for the necessary transformations.</p><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>ROS users can find more detailed instructions below in <a href="#reference-frames-and-ros">Reference Frames and ROS</a>.</p></div>',18)),t("p",null,[e[4]||(e[4]=a("For example, if using the Optitrack framework the local frame has ")),t("mjx-container",h,[(i(),r("svg",m,e[0]||(e[0]=[o('<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D465" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z" style="stroke-width:3;"></path></g><g data-mml-node="TeXAtom" data-mjx-texclass="ORD" transform="translate(572,0)"></g></g></g>',1)]))),e[1]||(e[1]=t("mjx-assistive-mml",{unselectable:"on",display:"inline",style:{top:"0px",left:"0px",clip:"rect(1px, 1px, 1px, 1px)","-webkit-touch-callout":"none","-webkit-user-select":"none","-khtml-user-select":"none","-moz-user-select":"none","-ms-user-select":"none","user-select":"none",position:"absolute",padding:"1px 0px 0px 0px",border:"0px",display:"block",width:"auto",overflow:"hidden"}},[t("math",{xmlns:"http://www.w3.org/1998/Math/MathML"},[t("mi",null,"x"),t("mrow",{"data-mjx-texclass":"ORD"})])],-1))]),e[5]||(e[5]=a(" and ")),t("mjx-container",p,[(i(),r("svg",c,e[2]||(e[2]=[o('<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D467" d="M347 338Q337 338 294 349T231 360Q211 360 197 356T174 346T162 335T155 324L153 320Q150 317 138 317Q117 317 117 325Q117 330 120 339Q133 378 163 406T229 440Q241 442 246 442Q271 442 291 425T329 392T367 375Q389 375 411 408T434 441Q435 442 449 442H462Q468 436 468 434Q468 430 463 420T449 399T432 377T418 358L411 349Q368 298 275 214T160 106L148 94L163 93Q185 93 227 82T290 71Q328 71 360 90T402 140Q406 149 409 151T424 153Q443 153 443 143Q443 138 442 134Q425 72 376 31T278 -11Q252 -11 232 6T193 40T155 57Q111 57 76 -3Q70 -11 59 -11H54H41Q35 -5 35 -2Q35 13 93 84Q132 129 225 214T340 322Q352 338 347 338Z" style="stroke-width:3;"></path></g><g data-mml-node="TeXAtom" data-mjx-texclass="ORD" transform="translate(465,0)"></g></g></g>',1)]))),e[3]||(e[3]=t("mjx-assistive-mml",{unselectable:"on",display:"inline",style:{top:"0px",left:"0px",clip:"rect(1px, 1px, 1px, 1px)","-webkit-touch-callout":"none","-webkit-user-select":"none","-khtml-user-select":"none","-moz-user-select":"none","-ms-user-select":"none","user-select":"none",position:"absolute",padding:"1px 0px 0px 0px",border:"0px",display:"block",width:"auto",overflow:"hidden"}},[t("math",{xmlns:"http://www.w3.org/1998/Math/MathML"},[t("mi",null,"z"),t("mrow",{"data-mjx-texclass":"ORD"})])],-1))]),e[6]||(e[6]=a(" on the horizontal plane (")),e[7]||(e[7]=t("em",null,"x",-1)),e[8]||(e[8]=a(" front and ")),e[9]||(e[9]=t("em",null,"z",-1)),e[10]||(e[10]=a(" right) while ")),e[11]||(e[11]=t("em",null,"y",-1)),e[12]||(e[12]=a(" axis is vertical and pointing up. Простий трюк полягає в тому, що обмінюються вісіми, щоб отримати конвенцію NED."))]),e[14]||(e[14]=o(`<p>If <code>x_{mav}</code>, <code>y_{mav}</code> and <code>z_{mav}</code> are the coordinates that are sent through MAVLink as position feedback, then we obtain:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>x_{mav} = x_{mocap}</span></span>
<span class="line"><span>y_{mav} = z_{mocap}</span></span>
<span class="line"><span>z_{mav} = - y_{mocap}</span></span></code></pre></div><p>Regarding the orientation, keep the scalar part <em>w</em> of the quaternion the same and swap the vector part <em>x</em>, <em>y</em> and <em>z</em> in the same way. Ви можете застосувати цей трюк у будь-якій системі - якщо вам потрібно отримати рамку NED, подивіться на вивід вашого MoCap та обміняйте вісі відповідно.</p><h2 id="конфігурація-та-налаштування-ekf2" tabindex="-1">Конфігурація та налаштування EKF2 <a class="header-anchor" href="#конфігурація-та-налаштування-ekf2" aria-label="Permalink to &quot;Конфігурація та налаштування EKF2&quot;">​</a></h2><p>Примітка: це короткий огляд. For more detailed information, check the <a href="./../advanced_config/tuning_the_ecl_ekf.html">EKF2 tuning guide</a></p><p>The following parameters must be set to use external position information with EKF2 (these can be set in <em>QGroundControl</em> &gt; <strong>Vehicle Setup &gt; Parameters &gt; EKF2</strong>).</p><table tabindex="0"><thead><tr><th>Параметр</th><th>Налаштування для Зовнішньої Оцінки Положення</th></tr></thead><tbody><tr><td><a href="./../advanced_config/parameter_reference.html#EKF2_EV_CTRL">EKF2_EV_CTRL</a></td><td>Set <em>horizontal position fusion</em>, <em>vertical vision fusion</em>, <em>velocity fusion</em>, and <em>yaw fusion</em>, according to your desired fusion model.</td></tr><tr><td><a href="./../advanced_config/parameter_reference.html#EKF2_HGT_REF">EKF2_HGT_REF</a></td><td>Set to <em>Vision</em> to use the vision as the reference source for altitude estimation.</td></tr><tr><td><a href="./../advanced_config/parameter_reference.html#EKF2_EV_DELAY">EKF2_EV_DELAY</a></td><td>Встановіть різницю між міткою часу вимірювання та &quot;фактичним&quot; часом захоплення. For more information see <a href="#tuning-EKF2_EV_DELAY">below</a>.</td></tr><tr><td><a href="./../advanced_config/parameter_reference.html#EKF2_EV_POS_X">EKF2_EV_POS_X</a>, <a href="./../advanced_config/parameter_reference.html#EKF2_EV_POS_Y">EKF2_EV_POS_Y</a>, <a href="./../advanced_config/parameter_reference.html#EKF2_EV_POS_Z">EKF2_EV_POS_Z</a></td><td>Встановіть положення візійного датчика (або маркерів MoCap) відносно тіла робота.</td></tr></tbody></table><p>You can also disable GNSS, baro and range finder fusion using <a href="./../advanced_config/parameter_reference.html#EKF2_GPS_CTRL">EKF2_GPS_CTRL</a>, <a href="./../advanced_config/parameter_reference.html#EKF2_BARO_CTRL">EKF2_BARO_CTRL</a> and <a href="./../advanced_config/parameter_reference.html#EKF2_RNG_CTRL">EKF2_RNG_CTRL</a>, respectively.</p><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>Reboot the flight controller in order for parameter changes to take effect.</p></div><p><a id="tuning-EKF2_EV_DELAY"></a></p><h4 id="налаштування-ekf2-ev-delay" tabindex="-1">Налаштування EKF2_EV_DELAY <a class="header-anchor" href="#налаштування-ekf2-ev-delay" aria-label="Permalink to &quot;Налаштування EKF2_EV_DELAY&quot;">​</a></h4><p><a href="./../advanced_config/parameter_reference.html#EKF2_EV_DELAY">EKF2_EV_DELAY</a> is the <em>Vision Position Estimator delay relative to IMU measurements</em>.</p><p>Іншими словами, це різниця між міткою часу системи комп&#39;ютерного зору та &quot;фактичним&quot; часом захоплення, який був би зафіксований годинником IMU (&quot;базовим годинником&quot; для EKF2).</p><p>Технічно цей параметр можна встановити на 0, якщо між комп&#39;ютерами MoCap і (наприклад) ROS є правильне маркування часу (не тільки час прибуття) і синхронізація часу (наприклад, NTP). In reality, this needs some empirical tuning since delays in the entire MoCap-&gt;PX4 chain are very setup-specific. Рідко коли система налаштована з повністю синхронізованим ланцюжком!</p><p>Приблизну оцінку затримки можна отримати з логів, перевіривши зсув між частотами IMU та EV. To enable logging of EV rates set bit 7 (Computer Vision and Avoidance) of <a href="./../advanced_config/parameter_reference.html#SDLOG_PROFILE">SDLOG_PROFILE</a>.</p><p><img src="`+s+'" alt="ekf2evdelay log"></p><div class="info custom-block"><p class="custom-block-title">INFO</p><p>A plot of external data vs. onboard estimate (as above) can be generated using <a href="./../log/flight_log_analysis.html#flightplot">FlightPlot</a> or similar flight analysis tools. At time of writing (July 2021) neither <a href="./../log/flight_log_analysis.html#flight-review-online-tool">Flight Review</a> nor <a href="./../log/flight_log_analysis.html#mavgcl">MAVGCL</a> support this functionality.</p></div><p>Значення можна додатково налаштувати, змінюючи параметр, щоб знайти значення, яке дає найнижчі інновації EKF під час динамічних маневрів.</p><h2 id="lpe-конфігурація-налаштування" tabindex="-1">LPE Конфігурація/Налаштування <a class="header-anchor" href="#lpe-конфігурація-налаштування" aria-label="Permalink to &quot;LPE Конфігурація/Налаштування&quot;">​</a></h2><p>You will first need to <a href="./../advanced/switching_state_estimators.html">switch to the LPE estimator</a> by setting the following parameters: <a href="./../advanced_config/parameter_reference.html#LPE_EN">LPE_EN</a> (1), <a href="./../advanced_config/parameter_reference.html#EKF2_EN">EKF2_EN</a> (0), <a href="./../advanced_config/parameter_reference.html#ATT_EN">ATT_EN</a> (0).</p><div class="info custom-block"><p class="custom-block-title">INFO</p><p>If targeting <code>px4_fmu-v2</code> hardware you will also need to use a firmware version that includes the LPE module (firmware for other FMU-series hardware includes both LPE and EKF). The LPE version can be found in the zip file for each PX4 release or it can be built from source using the build command <code>make px4_fmu-v2_lpe</code>. See <a href="./../dev_setup/building_px4.html">Building the Code</a> for more details.</p></div><h3 id="увімкнення-зовнішнього-введення-позиціі" tabindex="-1">Увімкнення зовнішнього введення позиції <a class="header-anchor" href="#увімкнення-зовнішнього-введення-позиціі" aria-label="Permalink to &quot;Увімкнення зовнішнього введення позиції&quot;">​</a></h3><p>The following parameters must be set to use external position information with LPE (these can be set in <em>QGroundControl</em> &gt; <strong>Vehicle Setup &gt; Parameters &gt; Local Position Estimator</strong>).</p><table tabindex="0"><thead><tr><th>Параметр</th><th>Налаштування для Зовнішньої Оцінки Положення</th></tr></thead><tbody><tr><td><a href="./../advanced_config/parameter_reference.html#LPE_FUSION">LPE_FUSION</a></td><td>Vision integration is enabled if <em>fuse vision position</em> is checked (it is enabled by default).</td></tr><tr><td><a href="./../advanced_config/parameter_reference.html#ATT_EXT_HDG_M">ATT_EXT_HDG_M</a></td><td>Встановіть значення 1 або 2, щоб увімкнути інтеграцію зовнішніх заголовків. Встановлення значення 1 призведе до використання зору, тоді як 2 увімкне використання заголовків MoCap.</td></tr></tbody></table><h3 id="вимкнення-barometer-fusion" tabindex="-1">Вимкнення Barometer Fusion <a class="header-anchor" href="#вимкнення-barometer-fusion" aria-label="Permalink to &quot;Вимкнення Barometer Fusion&quot;">​</a></h3><p>Якщо високоточна висота вже доступна з інформації VIO або MoCap, може бути корисно вимкнути корекцію баро в LPE, щоб зменшити дрейф по осі Z.</p><p>This can be done by in <em>QGroundControl</em> by unchecking the <em>fuse baro</em> option in the <a href="./../advanced_config/parameter_reference.html#LPE_FUSION">LPE_FUSION</a> parameter.</p><h3 id="параметри-налаштування-шуму" tabindex="-1">Параметри налаштування шуму <a class="header-anchor" href="#параметри-налаштування-шуму" aria-label="Permalink to &quot;Параметри налаштування шуму&quot;">​</a></h3><p>If your vision or MoCap data is highly accurate, and you just want the estimator to track it tightly, you should reduce the standard deviation parameters: <a href="./../advanced_config/parameter_reference.html#LPE_VIS_XY">LPE_VIS_XY</a> and <a href="./../advanced_config/parameter_reference.html#LPE_VIS_Z">LPE_VIS_Z</a> (for VIO) or <a href="./../advanced_config/parameter_reference.html#LPE_VIC_P">LPE_VIC_P</a> (for MoCap). Зменшення їх призведе до того, що оцінювач буде більше довіряти вхідній оцінці положення. Можливо, вам доведеться встановити їх нижче допустимого мінімуму та ввімкнути примусове збереження.</p><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>If performance is still poor, try increasing the <a href="./../advanced_config/parameter_reference.html#LPE_PN_V">LPE_PN_V</a> parameter. Це змусить оцінювача більше довіряти вимірюванням під час оцінювання швидкості.</p></div><h2 id="увімкнення-автоматичних-режимів-з-локальним-розташуванням" tabindex="-1">Увімкнення автоматичних режимів з локальним розташуванням <a class="header-anchor" href="#увімкнення-автоматичних-режимів-з-локальним-розташуванням" aria-label="Permalink to &quot;Увімкнення автоматичних режимів з локальним розташуванням&quot;">​</a></h2><p>All PX4 automatic flight modes (such as <a href="./../flight_modes_mc/mission.html">Mission</a>, <a href="./../flight_modes_mc/return.html">Return</a>, <a href="./../flight_modes_mc/land.html">Land</a>, <a href="./../flight_modes_mc/land.html">Hold</a>, <a href="./../flight_modes_mc/orbit.html">Orbit</a>)) require a <em>global</em> position estimate, which would normally come from a GPS/GNSS system.</p><p>Systems that only have a <em>local</em> position estimate (from MOCAP, VIO, or similar) can use the <a href="https://mavlink.io/en/messages/common.html#SET_GPS_GLOBAL_ORIGIN" target="_blank" rel="noreferrer">SET_GPS_GLOBAL_ORIGIN</a> MAVLink message to set the origin of the EKF to a particular global location. Після цього EKF надасть оцінку глобального положення на основі походження та локального положення у просторі.</p><p>Це може бути використано при плануванні та виконанні місій у приміщенні, для встановлення місцевої точки повернення тощо.</p><h2 id="робота-з-ros" tabindex="-1">Робота з ROS <a class="header-anchor" href="#робота-з-ros" aria-label="Permalink to &quot;Робота з ROS&quot;">​</a></h2><p>ROS is not <em>required</em> for supplying external pose information, but is highly recommended as it already comes with good integrations with VIO and MoCap systems. PX4 вже мають бути налаштовані як вище.</p><h3 id="отримання-даних-про-позицію-в-ros" tabindex="-1">Отримання даних про позицію в ROS <a class="header-anchor" href="#отримання-даних-про-позицію-в-ros" aria-label="Permalink to &quot;Отримання даних про позицію в ROS&quot;">​</a></h3><p>Системи VIO та MoCap мають різні способи отримання даних про положення, а також власні налаштування та теми.</p><p>The setup for specific systems is covered <a href="#setup_specific_systems">below</a>. Для інших систем зверніться до документації з налаштування виробника.</p><p><a id="relaying_pose_data_to_px4"></a></p><h3 id="передача-даних-про-позицію-до-px4" tabindex="-1">Передача даних про позицію до PX4 <a class="header-anchor" href="#передача-даних-про-позицію-до-px4" aria-label="Permalink to &quot;Передача даних про позицію до PX4&quot;">​</a></h3><p>MAVROS має плагіни для передачі візуальної оцінки з системи VIO або MoCap за допомогою наступних пайплайнів:</p><table tabindex="0"><thead><tr><th>ROS</th><th>MAVLink</th><th>uORB</th></tr></thead><tbody><tr><td>/mavros/vision_pose/pose</td><td><a href="https://mavlink.io/en/messages/common.html#VISION_POSITION_ESTIMATE" target="_blank" rel="noreferrer">VISION_POSITION_ESTIMATE</a></td><td><code>vehicle_visual_odometry</code></td></tr><tr><td>/mavros/odometry/out (<code>frame_id = odom</code>, <code>child_frame_id = base_link</code>)</td><td><a href="https://mavlink.io/en/messages/common.html#ODOMETRY" target="_blank" rel="noreferrer">ODOMETRY</a> (<code>frame_id =</code> <a href="https://mavlink.io/en/messages/common.html#MAV_FRAME_LOCAL_FRD" target="_blank" rel="noreferrer">MAV_FRAME_LOCAL_FRD</a>)</td><td><code>vehicle_visual_odometry</code></td></tr><tr><td>/mavros/mocap/pose</td><td><a href="https://mavlink.io/en/messages/common.html#ATT_POS_MOCAP" target="_blank" rel="noreferrer">ATT_POS_MOCAP</a></td><td><code>vehicle_mocap_odometry</code></td></tr><tr><td>/mavros/odometry/out (<code>frame_id = odom</code>, <code>child_frame_id = base_link</code>)</td><td><a href="https://mavlink.io/en/messages/common.html#ODOMETRY" target="_blank" rel="noreferrer">ODOMETRY</a> (<code>frame_id =</code> <a href="https://mavlink.io/en/messages/common.html#MAV_FRAME_LOCAL_FRD" target="_blank" rel="noreferrer">MAV_FRAME_LOCAL_FRD</a>)</td><td><code>vehicle_mocap_odometry</code></td></tr></tbody></table><p>Ви можете використовувати будь-який з наведених вище пайплайнів за допомогою LPE.</p><p>Якщо ви працюєте з EKF2, підтримуються лише &quot;vision&quot; пайплайни. To use MoCap data with EKF2 you will have to <a href="http://wiki.ros.org/roslaunch/XML/remap" target="_blank" rel="noreferrer">remap</a> the pose topic that you get from MoCap:</p><ul><li>MoCap ROS topics of type <code>geometry_msgs/PoseStamped</code> or <code>geometry_msgs/PoseWithCovarianceStamped</code> must be remapped to <code>/mavros/vision_pose/pose</code>. The <code>geometry_msgs/PoseStamped</code> topic is most common as MoCap doesn&#39;t usually have associated covariances to the data.</li><li>If you get data through a <code>nav_msgs/Odometry</code> ROS message then you will need to remap it to <code>/mavros/odometry/out</code>, making sure to update the <code>frame_id</code> and <code>child_frame_id</code> accordingly.</li><li>The odometry frames <code>frame_id = odom</code>, <code>child_frame_id = base_link</code> can be changed by updating the file in <code>mavros/launch/px4_config.yaml</code>. However, the current version of mavros (<code>1.3.0</code>) needs to be able to use the tf tree to find a transform from <code>frame_id</code> to the hardcoded frame <code>odom_ned</code>. The same applies to the <code>child_frame_id</code>, which needs to be connected in the tf tree to the hardcoded frame <code>base_link_frd</code>. If you are using mavros <code>1.2.0</code> and you didn&#39;t update the file <code>mavros/launch/px4_config.yaml</code>, then you can safely use the odometry frames <code>frame_id = odom</code>, <code>child_frame_id = base_link</code> without much worry.</li><li>Note that if you are sending odometry data to px4 using <code>child_frame_id = base_link</code>, then you need to make sure that the <code>twist</code> portion of the <code>nav_msgs/Odometry</code> message is <strong>expressed in body frame</strong>, <strong>not in inertial frame!!!!!</strong>.</li></ul><h3 id="референсні-системи-координат-та-ros" tabindex="-1">Референсні системи координат та ROS <a class="header-anchor" href="#референсні-системи-координат-та-ros" aria-label="Permalink to &quot;Референсні системи координат та ROS&quot;">​</a></h3><p>Локальна/світова та світова системи координат, що використовуються в ROS та PX4, відрізняються.</p><table tabindex="0"><thead><tr><th>Frame</th><th>PX4</th><th>ROS</th></tr></thead><tbody><tr><td>Body</td><td>FRD (X <strong>F</strong>orward, Y <strong>R</strong>ight, Z <strong>D</strong>own)</td><td>FLU (X <strong>F</strong>orward, Y <strong>L</strong>eft, Z <strong>U</strong>p), usually named <code>base_link</code></td></tr><tr><td>World</td><td>FRD or NED (X <strong>N</strong>orth, Y <strong>E</strong>ast, Z <strong>D</strong>own)</td><td>FLU or ENU (X <strong>E</strong>ast, Y <strong>N</strong>orth, Z <strong>U</strong>p), with the naming being <code>odom</code> or <code>map</code></td></tr></tbody></table><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>See <a href="http://www.ros.org/reps/rep-0105.html" target="_blank" rel="noreferrer">REP105: Coordinate Frames for Mobile Platforms</a> for more information about ROS frames.</p></div><p>Обидві системи координат показані на зображенні нижче (FRD зліва / FLU справа).</p><p><img src="'+n+`" alt="Reference frames"></p><p>З EKF2 при використанні зовнішньої оцінки напрямку магнітного північ може бути або ігноруватися, або зміщення напрямку до магнітного північного може бути розраховано та скомпенсовано. Depending on your choice the yaw angle is given with respect to either magnetic north or local <em>x</em>.</p><div class="info custom-block"><p class="custom-block-title">INFO</p><p>When creating the rigid body in the MoCap software, remember to first align the robot&#39;s local <em>x</em> axis with the world <em>x</em> axis otherwise the yaw estimate will have an offset. Це може призупинити правильну роботу злиття зовнішньої оцінки позиції. Кут крену повинен дорівнювати нулю, коли тіло та опорна система вирівнюються.</p></div><p>Використовуючи MAVROS, ця операція є простою. ROS використовує фрейми ENU як конвенцію, тому зворотний зв&#39;язок щодо позиції повинен бути наданий в ENU. If you have an Optitrack system you can use <a href="https://github.com/ros-drivers/mocap_optitrack" target="_blank" rel="noreferrer">mocap_optitrack</a> node which streams the object pose on a ROS topic already in ENU. With a remapping you can directly publish it on <code>mocap_pose_estimate</code> as it is without any transformation and MAVROS will take care of NED conversions.</p><p>Плагін MAVROS відомий тим, що спрощує роботу з координатними рамками. Він використовує пакет tf ROS. Ваш зовнішній система позиціонування може мати зовсім іншу конвенцію рамки, яка не відповідає конвенції PX4. Корпусна рама зовнішньої оцінки позиції може залежати від того, як ви встановите корпусну раму в програмному забезпеченні MOCAP або від того, як ви встановите сенсор VIO на дрона. Плагін відомостей MAVROS потребує знання, як дитяча рамка зовнішньої позиції орієнтована відносно рамки тіла FRD або FLU повітряного судна, відомої за допомогою MAVROS. Отже, вам потрібно додати зовнішню позу тіла до дерева tf. Це можна зробити, включивши адаптовану версію наступного рядка до вашого ROS-файлу запуску.</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>  &lt;node pkg=&quot;tf&quot; type=&quot;static_transform_publisher&quot; name=&quot;tf_baseLink_externalPoseChildFrame&quot;</span></span>
<span class="line"><span>        args=&quot;0 0 0 &lt;yaw&gt; &lt;pitch&gt; &lt;roll&gt; base_link &lt;external_pose_child_frame&gt; 1000&quot;/&gt;</span></span></code></pre></div><p>Make sure that you change the values of yaw, pitch and roll such that it properly attaches the external pose&#39;s body frame to the <code>base_link</code> or <code>base_link_frd</code>. Have a look at the <a href="http://wiki.ros.org/tf#static_transform_publisher" target="_blank" rel="noreferrer">tf package</a> for further help on how to specify the transformation between the frames. Ви можете використовувати rviz, щоб перевірити, чи ви правильно прикріпили рамку. The name of the <code>external_pose_child_frame</code> has to match the child_frame_id of your <code>nav_msgs/Odometry</code> message. Те ж саме стосується і для опорної рамки зовнішньої позиції. You have to attach the reference frame of the external pose as child to either the <code>odom</code> or <code>odom_frd</code> frame. Адаптуйте тому відповідно кодовий рядок.</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>  &lt;node pkg=&quot;tf&quot; type=&quot;static_transform_publisher&quot; name=&quot;tf_odom_externalPoseParentFrame&quot;</span></span>
<span class="line"><span>        args=&quot;0 0 0 &lt;yaw&gt; &lt;pitch&gt; &lt;roll&gt; odom &lt;external_pose_parent_frame&gt; 1000&quot;/&gt;</span></span></code></pre></div><p>If the reference frame has the z axis pointing upwards you can attached it without any rotation (yaw=0, pitch=0, roll=0) to the <code>odom</code> frame. The name of <code>external_pose_parent_frame</code> has to match the frame_id of the odometry message.</p><div class="info custom-block"><p class="custom-block-title">INFO</p><p>When using the MAVROS <em>odom</em> plugin, it is important that no other node is publishing a transform between the external pose&#39;s reference and child frame. This might break the <em>tf</em> tree.</p></div><p><a id="setup_specific_systems"></a></p><h2 id="конкретні-налаштування-системи" tabindex="-1">Конкретні налаштування системи <a class="header-anchor" href="#конкретні-налаштування-системи" aria-label="Permalink to &quot;Конкретні налаштування системи&quot;">​</a></h2><h3 id="optitrack-mocap" tabindex="-1">OptiTrack MoCap <a class="header-anchor" href="#optitrack-mocap" aria-label="Permalink to &quot;OptiTrack MoCap&quot;">​</a></h3><p>The following steps explain how to feed position estimates from an <a href="https://optitrack.com/motion-capture-robotics/" target="_blank" rel="noreferrer">OptiTrack</a> system to PX4. Припускається, що система MoCap налаштована. See <a href="https://www.youtube.com/watch?v=cNZaFEghTBU" target="_blank" rel="noreferrer">this video</a> for a tutorial on the calibration process.</p><h4 id="steps-on-the-motive-mocap-software" tabindex="-1">Steps on the <em>Motive</em> MoCap software <a class="header-anchor" href="#steps-on-the-motive-mocap-software" aria-label="Permalink to &quot;Steps on the _Motive_ MoCap software&quot;">​</a></h4><ul><li>Align your robot&#39;s forward direction with the <a href="https://v20.wiki.optitrack.com/index.php?title=Template:Coordinate_System" target="_blank" rel="noreferrer">system +x-axis</a></li><li><a href="https://www.youtube.com/watch?v=1e6Qqxqe-k0" target="_blank" rel="noreferrer">Define a rigid body in the Motive software</a>. Give the robot a name that does not contain spaces, e.g. <code>robot1</code> instead of <code>Rigidbody 1</code></li><li><a href="https://www.youtube.com/watch?v=yYRNG58zPFo" target="_blank" rel="noreferrer">Enable Frame Broadacst and VRPN streaming</a></li><li>Встановіть вісь Up на ось Z (за замовчуванням - Y)</li></ul><h4 id="отримання-даних-про-позицію-в-ros-1" tabindex="-1">Отримання даних про позицію в ROS <a class="header-anchor" href="#отримання-даних-про-позицію-в-ros-1" aria-label="Permalink to &quot;Отримання даних про позицію в ROS&quot;">​</a></h4><ul><li>Install the <code>vrpn_client_ros</code> package</li><li>Ви можете отримати позу кожного жорсткого тіла на окрему тему, запустивши<div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">roslaunch</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> vrpn_client_ros</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> sample.launch</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> server:=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">mocap</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> machine</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> i</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">p</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span></span></code></pre></div></li></ul><p>If you named the rigidbody as <code>robot1</code>, you will get a topic like <code>/vrpn_client_node/robot1/pose</code></p><h4 id="передача-перенаправлення-даних-про-позу" tabindex="-1">Передача / перенаправлення даних про позу <a class="header-anchor" href="#передача-перенаправлення-даних-про-позу" aria-label="Permalink to &quot;Передача / перенаправлення даних про позу&quot;">​</a></h4><p>MAVROS provides a plugin to relay pose data published on <code>/mavros/vision_pose/pose</code> to PX4. Assuming that MAVROS is running, you just need to <strong>remap</strong> the pose topic that you get from MoCap <code>/vrpn_client_node/&lt;rigid_body_name&gt;/pose</code> directly to <code>/mavros/vision_pose/pose</code>. Note that there is also a <code>mocap</code> topic that MAVROS provides to feed <code>ATT_POS_MOCAP</code> to PX4, but it is not applicable for EKF2. Однак, це застосовується з LPE.</p><div class="info custom-block"><p class="custom-block-title">INFO</p><p>Remapping pose topics is covered above <a href="#relaying_pose_data_to_px4">Relaying pose data to PX4</a> (<code>/vrpn_client_node/&lt;rigid_body_name&gt;/pose</code> is of type <code>geometry_msgs/PoseStamped</code>).</p></div><p>Припускаючи, що ви налаштували параметри EKF2, як описано вище, PX4 тепер встановлений і об&#39;єднує дані MoCap.</p><p>Ви тепер готові перейти до першого політ.</p><h2 id="першии-політ" tabindex="-1">Перший політ <a class="header-anchor" href="#першии-політ" aria-label="Permalink to &quot;Перший політ&quot;">​</a></h2><p>Після налаштування однієї з (специфічних) систем, описаних вище, ви повинні бути готові до тесту. Інструкції нижче показують, як це зробити для систем MoCap та VIO</p><h3 id="перевірте-зовнішню-оцінку" tabindex="-1">Перевірте зовнішню оцінку <a class="header-anchor" href="#перевірте-зовнішню-оцінку" aria-label="Permalink to &quot;Перевірте зовнішню оцінку&quot;">​</a></h3><p>Перед першим польотом обов&#39;язково виконайте наступні перевірки:</p><ul><li>Set the PX4 parameter <code>MAV_ODOM_LP</code> to 1. PX4 will then stream back the received external pose as MAVLink <a href="https://mavlink.io/en/messages/common.html#ODOMETRY" target="_blank" rel="noreferrer">ODOMETRY</a> messages.</li><li>You can check these MAVLink messages with the <em>QGroundControl</em> <a href="https://docs.qgroundcontrol.com/master/en/qgc-user-guide/analyze_view/mavlink_inspector.html" target="_blank" rel="noreferrer">MAVLink Inspector</a> In order to do this, yaw the vehicle until the quaternion of the <code>ODOMETRY</code> message is very close to a unit quaternion. (w=1, x=y=z=0)</li><li>На цьому етапі корпус виробу зорієнтований у відповідності з ориєнтацією відносно зовнішньої системи координат. Якщо вам не вдається отримати кватерніон, близький до одиничного, без обертання або нахилу вашого літака, це, ймовірно, означає, що ваша рама все ще має зміщення нахилу або кочування. У цьому випадку не продовжуйте і перевірте знову свої координатні рамки.</li><li>Після зорієнтування ви можете підняти літак з землі, і ви маєте бачити, як координата z позиції зменшується. Переміщення засобу в напрямку вперед повинно збільшити координату X. Під час руху транспортного засобу вправо слід збільшувати координату y. У разі, якщо ви також надсилаєте лінійні швидкості зовнішньої системи позиціонування, вам також слід перевірити лінійні швидкості. Check that the linear velocities are in expressed in the <em>FRD</em> body frame reference frame.</li><li>Set the PX4 parameter <code>MAV_ODOM_LP</code> back to 0. PX4 припинить передавати це повідомлення назад.</li></ul><p>Якщо ці кроки є послідовними, ви можете спробувати свій перший польот.</p><p>Покладіть робота на землю і почніть передавати зворотний зв&#39;язок MoCap. Потягніть палицю газу вниз і зберметизуйте двигуни.</p><p>На цьому етапі, зліва палиця на найнижчому положенні, перейдіть у режим позиціонного контролю. Ви повинні побачити зелену лампочку. Зелена лампочка свідчить про те, що доступний зворотний зв&#39;язок позиції, і позиційний контроль активований.</p><p>Помістіть лівий джойстик в середину, це зона мертвої зони. З цим значенням палиці робот підтримує свою висоту; підняття палиці збільшить висоту посилки, тоді як зниження значення зменшить її. Те ж саме для правої палиці по x та y.</p><p>Збільште значення лівої палиці, і робот злетить, поверніть його назад у середину праворуч після цього. Перевірте, чи він може утримати своє положення.</p><p>If it works, you may want to set up an <a href="./offboard_control.html">offboard</a> experiment by sending position-setpoint from a remote ground station.</p>`,86))])}const w=l(d,[["render",f]]);export{O as __pageData,w as default};
