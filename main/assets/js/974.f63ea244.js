(window.webpackJsonp=window.webpackJsonp||[]).push([[974],{1868:function(t,s,a){"use strict";a.r(s);var e=a(19),n=Object(e.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"simulation-debugging"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#simulation-debugging"}},[t._v("#")]),t._v(" Simulation Debugging")]),t._v(" "),a("p",[t._v("As the simulation is running on the host machine, all the desktop development tools are available.")]),t._v(" "),a("h2",{attrs:{id:"clang-address-sanitizer-mac-os-linux"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#clang-address-sanitizer-mac-os-linux"}},[t._v("#")]),t._v(" CLANG Address Sanitizer (Mac OS, Linux)")]),t._v(" "),a("p",[t._v("The Clang address sanitizer can help to find alignment (bus) errors and other memory faults like segmentation faults. The command below sets the right compile options.")]),t._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("make")]),t._v(" clean "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# only required on first address sanitizer run after a normal build")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("PX4_ASAN")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("make")]),t._v(" px4_sitl jmavsim\n")])])]),a("h2",{attrs:{id:"valgrind"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#valgrind"}},[t._v("#")]),t._v(" Valgrind")]),t._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[t._v("brew "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" valgrind\n")])])]),a("p",[t._v("or")]),t._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("apt-get")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" valgrind\n")])])]),a("p",[t._v("To use valgrind during the SITL simulation:")]),t._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("make")]),t._v(" px4_sitl_default jmavsim___valgrind\n")])])]),a("h2",{attrs:{id:"start-combinations"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#start-combinations"}},[t._v("#")]),t._v(" Start combinations")]),t._v(" "),a("p",[t._v("SITL can be launched with and without debugger attached and with either jMAVSim or Gazebo Classic as simulation backend.\nThis results in the start options below:")]),t._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("make")]),t._v(" px4_sitl_default jmavsim\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("make")]),t._v(" px4_sitl_default jmavsim___gdb\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("make")]),t._v(" px4_sitl_default jmavsim___lldb\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("make")]),t._v(" px4_sitl_default gazebo-classic\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("make")]),t._v(" px4_sitl_default gazebo-classic___gdb\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("make")]),t._v(" px4_sitl_default gazebo-classic___lldb\n")])])]),a("p",[t._v("where the last parameter is the <viewer_model_debugger> triplet (using three underscores implies the default 'iris' model).\nThis will start the debugger and launch the SITL application.\nIn order to break into the debugger shell and halt the execution, hit "),a("code",[t._v("CTRL-C")]),t._v(":")]),t._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[t._v("Process "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("16529")]),t._v(" stopped\n* thread "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#1: tid = 0x114e6d, 0x00007fff90f4430a libsystem_kernel.dylib`__read_nocancel + 10, name = 'px4', queue = 'com.apple.main-thread', stop reason = signal SIGSTOP")]),t._v("\n    frame "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#0: 0x00007fff90f4430a libsystem_kernel.dylib`__read_nocancel + 10")]),t._v("\nlibsystem_kernel.dylib`__read_nocancel:\n-"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("  0x7fff90f4430a "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("+1"),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[t._v("0")]),t._v(">")]),t._v(": jae    0x7fff90f44314            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("+2"),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[t._v("0")]),t._v(">")]),t._v("\n    0x7fff90f4430c "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("+1"),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[t._v("2")]),t._v(">")]),t._v(": movq   %rax, %rdi\n    0x7fff90f4430f "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("+1"),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[t._v("5")]),t._v(">")]),t._v(": jmp    0x7fff90f3fc53            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" cerror_nocancel\n    0x7fff90f44314 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("+2"),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[t._v("0")]),t._v(">")]),t._v(": retq\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("lldb"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" \n")])])]),a("p",[t._v("In order to not have the DriverFrameworks scheduling interfere with the debugging session "),a("code",[t._v("SIGCONT")]),t._v(" should be masked in LLDB and GDB:")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("lldb"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" process handle SIGCONT -n "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v(" -p "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v(" -s "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v("\n")])])]),a("p",[t._v("Or in the case of GDB:")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("(gdb) handle SIGCONT noprint nostop\n")])])]),a("p",[t._v("After that the lldb or gdb shells behave like normal sessions, please refer to the LLDB / GDB documentation.")]),t._v(" "),a("p",[t._v("The last parameter, the <viewer_model_debugger> triplet, is actually passed to make in the build directory, so")]),t._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("make")]),t._v(" px4_sitl_default jmavsim___gdb\n")])])]),a("p",[t._v("is equivalent with")]),t._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("make")]),t._v(" px4_sitl_default\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Configure with cmake")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("make")]),t._v(" -C build/px4_sitl_default jmavsim___gdb\n")])])]),a("p",[t._v("A full list of the available make targets in the build directory can be obtained with:")]),t._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("make")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("help")]),t._v("\n")])])]),a("p",[t._v("but for your convenience, a list with just the <viewer_model_debugger> triplets\nis printed with the command")]),t._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("make")]),t._v(" list_vmd_make_targets\n")])])]),a("h2",{attrs:{id:"attaching-gdb-to-running-sitl"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#attaching-gdb-to-running-sitl"}},[t._v("#")]),t._v(" Attaching GDB to running SITL")]),t._v(" "),a("p",[t._v("You can also start your simulation, and "),a("em",[t._v("then")]),t._v(" attach "),a("code",[t._v("gdb")]),t._v(":")]),t._v(" "),a("ol",[a("li",[a("p",[t._v("In one terminal screen enter the command to start your simulation:")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("make")]),t._v(" px4_sitl_default gazebo\n")])])]),a("p",[t._v("As the script runs, note the "),a("strong",[t._v("SITL COMMAND:")]),t._v(' output text located right above the large "PX4" text.\nIt will list the location of your px4 bin file for later use.')]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("SITL COMMAND: "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"<px4 bin file>"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"<build dir>"')]),t._v("/etc\n\n______  __   __    ___ \n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" ___ "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v(" / /   /   "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("_/ /  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v(" V /   / /"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("  __/   /   "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("  / /_"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("     / /^"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("___  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("_"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("     "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("/   "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("/     "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("_/\n\npx4 starting.\n\nINFO  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("px4"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" startup script: /bin/sh etc/init.d-posix/rcS "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\nINFO  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("init"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" found model autostart "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("file")]),t._v(" as "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("SYS_AUTOSTART")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10015")]),t._v("\n")])])])]),t._v(" "),a("li",[a("p",[t._v("Open another terminal and type:")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("ps")]),t._v(" -a\n")])])]),a("p",[t._v('You will want to note the PID of the process named "PX4"')]),t._v(" "),a("p",[t._v("(In this example it is 14149)")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("atlas:~/px4/main/PX4-Autopilot$ "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("ps")]),t._v(" -a\n    PID TTY          TIME CMD\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1796")]),t._v(" tty2     00:01:59 Xorg\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1836")]),t._v(" tty2     00:00:00 gnome-session-b\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("14027")]),t._v(" pts/1    00:00:00 "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("make")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("14077")]),t._v(" pts/1    00:00:00 "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("sh")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("14078")]),t._v(" pts/1    00:00:00 cmake\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("14079")]),t._v(" pts/1    00:00:00 ninja\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("14090")]),t._v(" pts/1    00:00:00 "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("sh")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("14091")]),t._v(" pts/1    00:00:00 "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("bash")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("14095")]),t._v(" pts/1    00:01:23 gzserver\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("14149")]),t._v(" pts/1    00:02:48 px4\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("14808")]),t._v(" pts/2    00:00:00 "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("ps")]),t._v("\n")])])])]),t._v(" "),a("li",[a("p",[t._v("Then type in the same window")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" gdb "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("px4 bin "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("file")]),t._v(" path "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("from step "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" here"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])])]),a("p",[t._v("For example,")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" gdb /home/atlas/px4/base/PX4-Autopilot/build/px4_sitl_default/bin/px4\n")])])]),a("p",[t._v("Now, you can attach to the PX4 instance by entering the PID noted in step 2.")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("attach "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("PID on px4"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])])]),a("p",[t._v("You should now have a GDB interface to debug with.")])])]),t._v(" "),a("h2",{attrs:{id:"compiler-optimization"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#compiler-optimization"}},[t._v("#")]),t._v(" Compiler optimization")]),t._v(" "),a("p",[t._v("It is possible to suppress compiler optimization for given executables and/or\nmodules (as added by cmake with "),a("code",[t._v("add_executable")]),t._v(" or "),a("code",[t._v("add_library")]),t._v(") when configuring\nfor "),a("code",[t._v("posix_sitl_*")]),t._v(". This can be handy when it is necessary to step through code\nwith a debugger or print variables that would otherwise be optimized out.")]),t._v(" "),a("p",[t._v("To do so, set the environment variable "),a("code",[t._v("PX4_NO_OPTIMIZATION")]),t._v(" to be a semi-colon separated list of regular expressions that match the targets that need to be compiled without optimization.\nThis environment variable is ignored when the configuration isn't "),a("code",[t._v("posix_sitl_*")]),t._v(".")]),t._v(" "),a("p",[t._v("For example,")]),t._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("export")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("PX4_NO_OPTIMIZATION")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'px4;^modules__uORB;^modules__systemlib$'")]),t._v("\n")])])]),a("p",[t._v("would suppress optimization of the targets: platforms__posix__px4_layer, modules__systemlib, modules__uORB, examples__px4_simple_app, modules__uORB__uORB_tests and px4.")]),t._v(" "),a("p",[t._v("The targets that can be matched with these regular expressions can be\nprinted with the command:")]),t._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("make")]),t._v(" -C build/posix_sitl_* list_cmake_targets\n")])])])])}),[],!1,null,null,null);s.default=n.exports}}]);