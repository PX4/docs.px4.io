import{_ as i,c as a,a8 as t,o as e}from"./chunks/framework.BDnHobkS.js";const c=JSON.parse('{"title":"Повідомлення MAVLink","description":"","frontmatter":{},"headers":[],"relativePath":"uk/middleware/mavlink.md","filePath":"uk/middleware/mavlink.md"}'),n={name:"uk/middleware/mavlink.md"};function l(h,s,p,k,r,o){return e(),a("div",null,s[0]||(s[0]=[t(`<h1 id="повідомлення-mavlink" tabindex="-1">Повідомлення MAVLink <a class="header-anchor" href="#повідомлення-mavlink" aria-label="Permalink to &quot;Повідомлення MAVLink&quot;">​</a></h1><p><a href="https://mavlink.io/en/" target="_blank" rel="noreferrer">MAVLink</a> is a very lightweight messaging protocol that has been designed for the drone ecosystem.</p><p>PX4 uses <em>MAVLink</em> to communicate with ground stations and MAVLink SDKs, such as <em>QGroundControl</em> and <a href="https://mavsdk.mavlink.io/" target="_blank" rel="noreferrer">MAVSDK</a>, and as the integration mechanism for connecting to drone components outside of the flight controller: companion computers, MAVLink enabled cameras, and so on.</p><p>Ця тема надає короткий огляд основних концепцій MAVLink, таких як повідомлення, команди та мікросервіси. Він також надає інструкції посібника про те, як ви можете додати підтримку PX4 для:</p><ul><li>Потокових повідомлень MAVLink</li><li>Обробка вхідних повідомлень MAVLink та запис до теми uORB.</li></ul><div class="info custom-block"><p class="custom-block-title">INFO</p><p>The topic does not cover <em>command</em> handling and sending, or how to implement your own microservices.</p></div><h2 id="огляд-mavlink" tabindex="-1">Огляд MAVLink <a class="header-anchor" href="#огляд-mavlink" aria-label="Permalink to &quot;Огляд MAVLink&quot;">​</a></h2><p>MAVLink - це легкий протокол, який був розроблений для ефективної відправки повідомлень по ненадійним радіоканалах з низькою пропускною здатністю.</p><p><em>Messages</em> are simplest and most &quot;fundamental&quot; definition in MAVLink, consisting of a name (e.g. <a href="https://mavlink.io/en/messages/common.html#ATTITUDE" target="_blank" rel="noreferrer">ATTITUDE</a>), id, and fields containing relevant data. Вони навмисно легкі, мають обмежений розмір і не мають семантики для повторного надсилання та підтвердження. Окремі повідомлення зазвичай використовуються для потокової передачі телеметрії або інформації про стан, а також для надсилання команд, які не потребують підтвердження - наприклад, команд уставки, що надсилаються з високою швидкістю.</p><p>The <a href="https://mavlink.io/en/services/command.html" target="_blank" rel="noreferrer">Command Protocol</a> is a higher level protocol for sending commands that may need acknowledgement. Specific commands are defined as values of the <a href="https://mavlink.io/en/messages/common.html#mav_commands" target="_blank" rel="noreferrer">MAV_CMD</a> enumeration, such as the takeoff command <a href="https://mavlink.io/en/messages/common.html#MAV_CMD_NAV_TAKEOFF" target="_blank" rel="noreferrer">MAV_CMD_NAV_TAKEOFF</a>, and include up to 7 numeric &quot;param&quot; values. The protocol sends a command by packaging the parameter values in a <code>COMMAND_INT</code> or <code>COMMAND_LONG</code> message, and waits for an acknowledgement with a result in a <code>COMMAND_ACK</code>. Якщо команда не буде отримана, вона буде повторно надіслана автоматично. Note that <a href="https://mavlink.io/en/messages/common.html#mav_commands" target="_blank" rel="noreferrer">MAV_CMD</a> definitions are also used to define mission actions, and that not all definitions are supported for use in commands/missions on PX4.</p><p><a href="https://mavlink.io/en/services/" target="_blank" rel="noreferrer">Microservices</a> are other higher level protocols built on top of MAVLink messages. Вони використовуються для передачі інформації, яку неможливо надіслати одним повідомленням, а також для забезпечення таких функцій, як надійний зв&#39;язок. Описаний вище командний протокол є одним з таких сервісів. Others include the <a href="https://mavlink.io/en/services/ftp.html" target="_blank" rel="noreferrer">File Transfer Protocol</a>, <a href="https://mavlink.io/en/services/camera.html" target="_blank" rel="noreferrer">Camera Protocol</a> and <a href="https://mavlink.io/en/services/mission.html" target="_blank" rel="noreferrer">Mission Protocol</a>.</p><p>MAVLink messages, commands and enumerations are defined in <a href="https://mavlink.io/en/guide/define_xml_element.html" target="_blank" rel="noreferrer">XML definition files</a>. Інструментарій MAVLink включає в себе генератори коду, які створюють з цих визначень специфічні для мови програмування бібліотеки для надсилання та отримання повідомлень. Зверніть увагу, що більшість згенерованих бібліотек не створюють код для реалізації мікросервісів.</p><p>The MAVLink project standardizes a number of messages, commands, enumerations, and microservices, for exchanging data using the following definition files (note that higher level files <em>include</em> the definitions of the files below them):</p><ul><li><a href="https://mavlink.io/en/messages/development.html" target="_blank" rel="noreferrer">development.xml</a> — Definitions that are proposed to be part of the standard. The definitions move to <code>common.xml</code> if accepted following testing.</li><li><a href="https://mavlink.io/en/messages/common.html" target="_blank" rel="noreferrer">common.xml</a> — A &quot;library&quot; of definitions meeting many common UAV use cases. Вони підтримуються багатьма польотними стеками, наземними станціями та периферійними пристроями MAVLink. Польотні стеки, які використовують ці визначення, з більшою ймовірністю будуть взаємодіяти.</li><li><a href="https://mavlink.io/en/messages/standard.html" target="_blank" rel="noreferrer">standard.xml</a> — Definitions that are actually standard. Вони присутні на переважній більшості польотних стеків і реалізовані однаково.</li><li><a href="https://mavlink.io/en/messages/minimal.html" target="_blank" rel="noreferrer">minimal.xml</a> — Definitions required by a minimal MAVLink implementation.</li></ul><p>The project also hosts <a href="https://mavlink.io/en/messages/#dialects" target="_blank" rel="noreferrer">dialect XML definitions</a>, which contain MAVLink definitions that are specific to a flight stack or other stakeholder.</p><p>Протокол покладається на те, що кожна сторона комунікації має спільне визначення того, які повідомлення надсилаються. Це означає, що для того, щоб взаємодіяти, обидва кінці комунікації повинні використовувати бібліотеки, створені на основі одного і того ж визначення XML.</p><h2 id="px4-та-mavlink" tabindex="-1">PX4 та MAVLink <a class="header-anchor" href="#px4-та-mavlink" aria-label="Permalink to &quot;PX4 та MAVLink&quot;">​</a></h2><p>PX4 releases build <code>common.xml</code> MAVLink definitions by default, for the greatest compatibility with MAVLink ground stations, libraries, and external components such as MAVLink cameras. In the <code>main</code> branch, these are included from <code>development.xml</code> on SITL, and <code>common.xml</code> for other boards.</p><div class="info custom-block"><p class="custom-block-title">INFO</p><p>To be part of a PX4 release, any MAVLink definitions that you use must be in <code>common.xml</code> (or included files such as <code>standard.xml</code> and <code>minimal.xml</code>). During development you can use definitions in <code>development.xml</code>. You will need to work with the <a href="https://mavlink.io/en/contributing/contributing.html" target="_blank" rel="noreferrer">MAVLink team</a> to define and contribute these definitions.</p></div><p>PX4 includes the <a href="https://github.com/mavlink/mavlink" target="_blank" rel="noreferrer">mavlink/mavlink</a> repo as a submodule under <a href="https://github.com/PX4/PX4-Autopilot/tree/main/src/modules/mavlink" target="_blank" rel="noreferrer">/src/modules/mavlink</a>. This contains XML definition files in <a href="https://github.com/mavlink/mavlink/blob/master/message_definitions/v1.0/" target="_blank" rel="noreferrer">/mavlink/messages/1.0/</a>.</p><p>Інструментарій збірки генерує заголовні файли MAVLink 2 C під час збірки. The XML file for which headers files are generated may be defined in the <a href="./../hardware/porting_guide_config.html#px4-board-configuration-kconfig">PX4 kconfig board configuration</a> on a per-board basis, using the variable <code>CONFIG_MAVLINK_DIALECT</code>:</p><ul><li>For SITL <code>CONFIG_MAVLINK_DIALECT</code> is set to <code>development</code> in <a href="https://github.com/PX4/PX4-Autopilot/blob/main/boards/px4/sitl/default.px4board#L36" target="_blank" rel="noreferrer">boards/px4/sitl/default.px4board</a>. You can change this to any other definition file, but the file must include <code>common.xml</code>.</li><li>For other boards <code>CONFIG_MAVLINK_DIALECT</code> is not set by default, and PX4 builds the definitions in <code>common.xml</code> (these are build into the <a href="./../modules/modules_communication.html#mavlink">mavlink module</a> by default — search for <code>menuconfig MAVLINK_DIALECT</code> in <a href="https://github.com/PX4/PX4-Autopilot/blob/main/src/modules/mavlink/Kconfig#L10" target="_blank" rel="noreferrer">src/modules/mavlink/Kconfig</a>).</li></ul><p>The files are generated into the build directory: <code>/build/&lt;build target&gt;/mavlink/</code>.</p><h2 id="спеціальні-повідомлення-mavlink" tabindex="-1">Спеціальні повідомлення MAVLink <a class="header-anchor" href="#спеціальні-повідомлення-mavlink" aria-label="Permalink to &quot;Спеціальні повідомлення MAVLink&quot;">​</a></h2><p>Користувацьке повідомлення MAVLink - це повідомлення, якого немає у визначеннях за замовчуванням, включених до PX4.</p><div class="info custom-block"><p class="custom-block-title">INFO</p><p>If you use a custom definition you will need maintain the definition in PX4, your ground station, and any other SDKs that communicate with it. Загалом, щоб зменшити тягар обслуговування, слід використовувати (або доповнювати) стандартні визначення, якщо це можливо.</p></div><p>Користувацькі визначення можна додати до нового файлу діалекту у тому самому каталозі, що й стандартні визначення XML. For example, create <code>PX4-Autopilot/src/modules/mavlink/mavlink/message_definitions/v1.0/custom_messages.xml</code>, and set <code>CONFIG_MAVLINK_DIALECT</code> to build the new file for SITL. This dialect file should include <code>development.xml</code> so that all the standard definitions are also included.</p><p>For initial prototyping, or if you intend your message to be &quot;standard&quot;, you can also add your messages to <code>common.xml</code> (or <code>development.xml</code>). Це спрощує збірку, оскільки вам не потрібно модифікувати вже зібраний діалект.</p><p>The MAVLink developer guide explains how to define new messages in <a href="https://mavlink.io/en/guide/define_xml_element.html" target="_blank" rel="noreferrer">How to Define MAVLink Messages &amp; Enums</a>.</p><p>You can check that your new messages are built by inspecting the headers generated in the build directory (<code>/build/&lt;build target&gt;/mavlink/</code>). Якщо ваші повідомлення не збираються, вони можуть бути неправильно відформатовані або використовувати конфліктуючі ідентифікатори. Перевірте журнал збірки для отримання інформації.</p><p>Після того, як повідомлення створено, ви можете передавати, отримувати або використовувати його в інший спосіб, як описано в наступних розділах.</p><div class="info custom-block"><p class="custom-block-title">INFO</p><p>The <a href="https://mavlink.io/en/getting_started/" target="_blank" rel="noreferrer">MAVLink Developer guide</a> has more information about using the MAVLink toolchain.</p></div><h2 id="потокові-повідомлення-mavlink" tabindex="-1">Потокові повідомлення MAVLink <a class="header-anchor" href="#потокові-повідомлення-mavlink" aria-label="Permalink to &quot;Потокові повідомлення MAVLink&quot;">​</a></h2><p>MAVLink messages are streamed using a streaming class, derived from <code>MavlinkStream</code>, that has been added to the PX4 stream list. Клас має фреймворкові методи, які ви реалізуєте, щоб PX4 міг отримати потрібну йому інформацію зі згенерованого визначення повідомлення MAVLink. It also has a <code>send()</code> method that is called each time the message needs to be sent — you override this to copy information from a uORB subscription to the MAVLink message object that is to be sent.</p><p>Цей посібник демонструє, як транслювати повідомлення uORB як повідомлення MAVLink, і застосовується як до стандартних, так і до користувацьких повідомлень.</p><h3 id="передумови" tabindex="-1">Передумови <a class="header-anchor" href="#передумови" aria-label="Permalink to &quot;Передумови&quot;">​</a></h3><p>Generally you will already have a <a href="./../middleware/uorb.html">uORB</a> message that contains information you&#39;d like to stream and a definition of a MAVLink message that you&#39;d like to stream it with.</p><p>For this example we&#39;re going to assume that you want to stream the (existing) <a href="./../msg_docs/BatteryStatus.html">BatteryStatus</a> uORB message to a new MAVLink battery status message, which we will name <code>BATTERY_STATUS_DEMO</code>.</p><p>Copy this <code>BATTERY_STATUS_DEMO</code> message into the message section of <code>development.xml</code> in your PX4 source code, which will be located at: <code>\\src\\modules\\mavlink\\mavlink\\message_definitions\\v1.0\\development.xml</code>.</p><div class="language-xml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">xml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">message</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;11514&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;BATTERY_STATUS_DEMO&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">description</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;Simple demo battery.&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">description</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">field</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;uint8_t&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;id&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> instance</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;true&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;Battery ID&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">field</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">field</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;int16_t&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;temperature&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> units</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;cdegC&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> invalid</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;INT16_MAX&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;Temperature of the whole battery pack (not internal electronics). INT16_MAX field not provided.&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">field</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">field</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;uint8_t&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;percent_remaining&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> units</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;%&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> invalid</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;UINT8_MAX&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;Remaining battery energy. Values: [0-100], UINT8_MAX: field not provided.&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">field</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    &lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">message</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span></code></pre></div><div class="info custom-block"><p class="custom-block-title">INFO</p><p>Note that this is a cut-down version of the not-yet-implemented <a href="https://mavlink.io/en/messages/development.html#BATTERY_STATUS_V2" target="_blank" rel="noreferrer">BATTERY_STATUS_V2</a> message with randomly chosen unused id of <code>11514</code>. Here we&#39;ve put the message in <code>development.xml</code>, which is fine for testing and if the message is intended to eventually be part of the standard message set, but you might also put a <a href="#custom-mavlink-messages">custom message</a> in its own dialect file.</p></div><p>Build PX4 for SITL and confirm that the associated message is generated in <code>/build/px4_sitl_default/mavlink/development/mavlink_msg_battery_status_demo.h</code>.</p><p>Because <code>BatteryStatus</code> already exists you will not need to do anything to create or build it.</p><h3 id="об-явлення-класу-потокового-відтворення" tabindex="-1">Об&#39;явлення класу потокового відтворення <a class="header-anchor" href="#об-явлення-класу-потокового-відтворення" aria-label="Permalink to &quot;Об&#39;явлення класу потокового відтворення&quot;">​</a></h3><p>First create a file named <code>BATTERY_STATUS_DEMO.hpp</code> for your streaming class (named after the message to stream) inside the <a href="https://github.com/PX4/PX4-Autopilot/tree/main/src/modules/mavlink/streams" target="_blank" rel="noreferrer">/src/modules/mavlink/streams</a> directory.</p><p>Додайте заголовки для повідомлень uORB у верхню частину файлу (необхідні заголовки MAVLink вже мають бути доступними):</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#include</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &lt;uORB/topics/battery_status.h&gt;</span></span></code></pre></div><div class="info custom-block"><p class="custom-block-title">INFO</p><p>The uORB topic&#39;s snake-case header file is generated from the CamelCase uORB filename at build time.</p></div><p>Потім скопіюйте визначення класу трансляції нижче у файл:</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> MavlinkStreamBatteryStatusDemo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> : </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> MavlinkStream</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    static</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> MavlinkStream</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">new_instance</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Mavlink</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">mavlink</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> new</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> MavlinkStreamBatteryStatusDemo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(mavlink);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> char</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get_name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> MavlinkStreamBatteryStatusDemo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get_name_static</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> char</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get_name_static</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;BATTERY_STATUS_DEMO&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> uint16_t</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> get_id_static</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> MAVLINK_MSG_ID_BATTERY_STATUS_DEMO;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    uint16_t</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> get_id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> get_id_static</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    unsigned</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> get_size</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> MAVLINK_MSG_ID_BATTERY_STATUS_DEMO_LEN </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> MAVLINK_NUM_NON_PAYLOAD_BYTES;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">private:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    //Subscription to array of uORB battery status instances</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    uORB</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::SubscriptionMultiArray</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">battery_status_s, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">battery_status_s</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::MAX_INSTANCES</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> _battery_status_subs{</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ORB_ID</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::battery_status};</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // SubscriptionMultiArray subscription is needed because battery has multiple instances.</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // uORB::Subscription is used to subscribe to a single-instance topic</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    /* do not allow top copying this class */</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    MavlinkStreamBatteryStatusDemo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">MavlinkStreamBatteryStatusDemo</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    MavlinkStreamBatteryStatusDemo</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> operator</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> MavlinkStreamBatteryStatusDemo</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">protected:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    explicit</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> MavlinkStreamBatteryStatusDemo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Mavlink</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">mavlink</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) : </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">MavlinkStream</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(mavlink)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	bool</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> send</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">override</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">		bool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> updated </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		// Loop through _battery_status_subs (subscription to array of BatteryStatus instances)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">		for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">auto</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">battery_sub : _battery_status_subs) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            // battery_status_s is a struct that can hold the battery object topic</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			battery_status_s battery_status;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">			// Update battery_status and publish only if the status has changed</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">			if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (battery_sub.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">update</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">battery_status)) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                // mavlink_battery_status_demo_t is the MAVLink message object</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">				mavlink_battery_status_demo_t</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> bat_msg{};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">				bat_msg.id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> battery_status.id </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">				bat_msg.percent_remaining </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (battery_status.connected) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">?</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> roundf</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(battery_status.remaining </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 100.</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">f</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">				// check if temperature valid</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">				if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (battery_status.connected </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> PX4_ISFINITE</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(battery_status.temperature)) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">					bat_msg.temperature </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> battery_status.temperature </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 100.</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">f</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">				} </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">else</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">					bat_msg.temperature </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> INT16_MAX;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">				}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                //Send the message</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">				mavlink_msg_battery_status_demo_send_struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(_mavlink-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get_channel</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(), </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">bat_msg);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">				updated </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">			}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">		return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> updated;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span></code></pre></div><p>Most streaming classes are very similar (see examples in <a href="https://github.com/PX4/PX4-Autopilot/tree/main/src/modules/mavlink/streams" target="_blank" rel="noreferrer">/src/modules/mavlink/streams</a>):</p><ul><li><p>The streaming class derives from <a href="https://github.com/PX4/PX4-Autopilot/blob/main/src/modules/mavlink/mavlink_stream.h" target="_blank" rel="noreferrer"><code>MavlinkStream</code></a> and is named using the pattern <code>MavlinkStream&lt;CamelCaseMessageName&gt;</code>.</p></li><li><p>The <code>public</code> definitions are &quot;near-boilerplate&quot;, allowing PX4 to get an instance of the class (<code>new_instance()</code>), and then to use it to fetch the name, id, and size of the message from the MAVLink headers (<code>get_name()</code>, <code>get_name_static()</code>, <code>get_id_static()</code>, <code>get_id()</code>, <code>get_size()</code>). Для ваших власних потокових класів їх можна просто скопіювати і змінити, щоб вони відповідали значенням для вашого повідомлення MAVLink.</p></li><li><p>The <code>private</code> definitions subscribe to the uORB topics that need to be published. У цьому випадку тема uORB має кілька екземплярів: по одному для кожної батареї. We use <code>uORB::SubscriptionMultiArray</code> to get an array of battery status subscriptions.</p><p>Тут ми також визначаємо конструктори, щоб уникнути копіювання визначення.</p></li><li><p>The <code>protected</code> section is where the important work takes place!</p><p>Here we override the <code>send()</code> method, copying values from the subscribed uORB topic(s) into appropriate fields in the MAVLink message, and then send the message.</p><p>In this particular example we have an array of uORB instances <code>_battery_status_subs</code> (because we have multiple batteries). We iterate the array and use <code>update()</code> on each subscription to check if the associated battery instance has changed (and update a structure with the current data). This allows us to send the MAVLink message <em>only</em> if the associated battery uORB topic has changed:</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Struct to hold current topic data.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">battery_status_s battery_status;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// update() populates battery_status and returns true if the status has changed</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (battery_sub.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">update</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">battery_status)) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   // Use battery_status to populate message and send</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>If wanted to send a MAVLink message whether or not the data changed, we could instead use <code>copy()</code> as shown:</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">battery_status_s battery_status;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">battery_sub.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">copy</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">battery_status);</span></span></code></pre></div><div class="info custom-block"><p class="custom-block-title">INFO</p><p>For a single-instance topic like <a href="./../msg_docs/VehicleStatus.html">VehicleStatus</a> we would subscribe like this:</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Create subscription _vehicle_status_sub</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">uORB</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::Subscription _vehicle_status_sub{</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ORB_ID</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(vehicle_status)};</span></span></code></pre></div><p>І ми можемо використовувати отриману підписку так само, з оновленням або копіюванням.</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">vehicle_status_s vehicle_status{};</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // vehicle_status_s is the definition of the uORB topic</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (_vehicle_status_sub.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">update</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">vehicle_status)) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  // Use the vehicle_status as it has been updated.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div></div></li></ul><p>:::</p><p>Next we include our new class in <a href="https://github.com/PX4/PX4-Autopilot/blob/main/src/modules/mavlink/mavlink_messages.cpp#L2193" target="_blank" rel="noreferrer">mavlink_messages.cpp</a>. Додайте рядок нижче до частини файлу, де включені всі інші потоки:</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#include</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;streams/BATTERY_STATUS_DEMO.hpp&quot;</span></span></code></pre></div><p>Finally append the stream class to the <code>streams_list</code> at the bottom of <a href="https://github.com/PX4/PX4-Autopilot/blob/main/src/modules/mavlink/mavlink_messages.cpp" target="_blank" rel="noreferrer">mavlink_messages.cpp</a></p><div class="language-C vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">C</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">StreamListItem </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">streams_list</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">[]</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">...</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#if</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> defined</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">BATTERY_STATUS_DEMO_HPP</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    create_stream_list_item</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">MavlinkStreamBatteryStatusDemo</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(),</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#endif</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // BATTERY_STATUS_DEMO_HPP</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p>Клас тепер доступний для потокової передачі, але за замовчуванням не буде транслюватися. Ми розглянемо це в наступних розділах.</p><h3 id="трансляція-за-замовчуванням" tabindex="-1">Трансляція за замовчуванням <a class="header-anchor" href="#трансляція-за-замовчуванням" aria-label="Permalink to &quot;Трансляція за замовчуванням&quot;">​</a></h3><p>The easiest way to stream your messages by default (as part of a build) is to add them to <a href="https://github.com/PX4/PX4-Autopilot/blob/main/src/modules/mavlink/mavlink_main.cpp" target="_blank" rel="noreferrer">mavlink_main.cpp</a> in the appropriate message group.</p><p>Якщо ви виконаєте пошук у файлі, то знайдете групи повідомлень, визначені в інструкції switch:</p><ul><li><code>MAVLINK_MODE_NORMAL</code>: Streamed to a GCS.</li><li><code>MAVLINK_MODE_ONBOARD</code>: Streamed to a companion computer on a fast link, such as Ethernet</li><li><code>MAVLINK_MODE_ONBOARD_LOW_BANDWIDTH</code>: Streamed to a companion computer for re-routing to a reduced-traffic link, such as a GCS.</li><li><code>MAVLINK_MODE_GIMBAL</code>: Streamed to a gimbal</li><li><code>MAVLINK_MODE_EXTVISION</code>: Streamed to an external vision system</li><li><code>MAVLINK_MODE_EXTVISIONMIN</code>: Streamed to an external vision system on a slower link</li><li><code>MAVLINK_MODE_OSD</code>: Streamed to an OSD, such as an FPV headset.</li><li><code>MAVLINK_MODE_CUSTOM</code>: Stream nothing by default. Використовується при налаштуванні потокового передавання за допомогою MAVLink.</li><li><code>MAVLINK_MODE_MAGIC</code>: Same as <code>MAVLINK_MODE_CUSTOM</code></li><li><code>MAVLINK_MODE_CONFIG</code>: Streaming over USB with higher rates than <code>MAVLINK_MODE_NORMAL</code>.</li><li><code>MAVLINK_MODE_MINIMAL</code>: Stream a minimal set of messages. Зазвичай використовується для поганого зв&#39;язку телеметрії.</li><li><code>MAVLINK_MODE_IRIDIUM</code>: Streamed to an iridium satellite phone</li></ul><p>Normally you&#39;ll be testing on a GCS, so you could just add the message to the <code>MAVLINK_MODE_NORMAL</code> case using the <code>configure_stream_local()</code> method. Наприклад, для трансляції CA_TRAJECTORY з частотою 5 Гц:</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	case</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> MAVLINK_MODE_CONFIG:</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // USB</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		// Note: streams requiring low latency come first</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">		...</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">		configure_stream_local</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;BATTERY_STATUS_DEMO&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">5.0</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">f</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        ...</span></span></code></pre></div><p>It is also possible to add a stream by calling the <a href="./../modules/modules_communication.html#mavlink">mavlink</a> module with the <code>stream</code> argument in a <a href="./../concept/system_startup.html">startup script</a>. For example, you might add the following line to <a href="https://github.com/PX4/PX4-Autopilot/blob/main/ROMFS/px4fmu_common/init.d-posix/px4-rc.mavlink" target="_blank" rel="noreferrer">/ROMFS/px4fmu_common/init.d-posix/px4-rc.mavlink</a> in order to stream <code>BATTERY_STATUS_DEMO</code> at 50Hz on UDP port <code>14556</code> (<code>-r</code> configures the streaming rate and <code>-u</code> identifies the MAVLink channel on UDP port 14556).</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mavlink</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> stream</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -r</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 50</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> BATTERY_STATUS_DEMO</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -u</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 14556</span></span></code></pre></div><h3 id="транслювання-за-запитом" tabindex="-1">Транслювання за запитом <a class="header-anchor" href="#транслювання-за-запитом" aria-label="Permalink to &quot;Транслювання за запитом&quot;">​</a></h3><p>Деякі повідомлення потрібні лише один раз, при підключенні певного обладнання або за інших обставин. Щоб уникнути перевантаження каналів зв&#39;язку непотрібними повідомленнями, ви можете не передавати всі повідомлення за замовчуванням, навіть з низькою швидкістю.</p><p>If you needed, a GCS or other MAVLink API can request that particular messages are streamed at a particular rate using <a href="https://mavlink.io/en/messages/common.html#MAV_CMD_SET_MESSAGE_INTERVAL" target="_blank" rel="noreferrer">MAV_CMD_SET_MESSAGE_INTERVAL</a>. A particular message can be requested just once using <a href="https://mavlink.io/en/messages/common.html#MAV_CMD_REQUEST_MESSAGE" target="_blank" rel="noreferrer">MAV_CMD_REQUEST_MESSAGE</a>.</p><h2 id="отримання-повідомлень-mavlink" tabindex="-1">Отримання повідомлень MAVLink <a class="header-anchor" href="#отримання-повідомлень-mavlink" aria-label="Permalink to &quot;Отримання повідомлень MAVLink&quot;">​</a></h2><p>Цей розділ пояснює, як отримати повідомлення через MAVLink та опублікувати його в uORB.</p><p>It assumes that we are receiving the <code>BATTERY_STATUS_DEMO</code> message and we want to update the (existing) <a href="./../msg_docs/BatteryStatus.html">BatteryStatus uORB message</a> with the contained information. Це той тип реалізації, який ви надаєте для підтримки інтеграції батареї MAVLink з PX4.</p><p>Add the headers for the uORB topic to publish to in <a href="https://github.com/PX4/PX4-Autopilot/blob/main/src/modules/mavlink/mavlink_receiver.h#L77" target="_blank" rel="noreferrer">mavlink_receiver.h</a>:</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#include</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &lt;uORB/topics/battery_status.h&gt;</span></span></code></pre></div><p>Add a function signature for a function that handles the incoming MAVLink message in the <code>MavlinkReceiver</code> class in <a href="https://github.com/PX4/PX4-Autopilot/blob/main/src/modules/mavlink/mavlink_receiver.h#L126" target="_blank" rel="noreferrer">mavlink_receiver.h</a></p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> handle_message_battery_status_demo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">mavlink_message_t</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">msg</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><p>Normally you would add a uORB publisher for the uORB topic to publish in the <code>MavlinkReceiver</code> class in <a href="https://github.com/PX4/PX4-Autopilot/blob/main/src/modules/mavlink/mavlink_receiver.h#L296" target="_blank" rel="noreferrer">mavlink_receiver.h</a>. In this case the <a href="./../msg_docs/BatteryStatus.html">BatteryStatus</a> uORB topic already exists:</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">uORB</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::Publication</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">battery_status_s</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> _battery_pub{</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ORB_ID</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(battery_status)};</span></span></code></pre></div><p>This creates a publication to a single uORB topic instance, which by default will be the <em>first</em> instance.</p><div class="info custom-block"><p class="custom-block-title">INFO</p><p>This implementation won&#39;t work on multi-battery systems, because several batteries might be publishing data to the first instance of the topic, and there is no way to differentiate them. To support multiple batteries we&#39;d need to use <code>PublicationMulti</code> and map the MAVLink message instance IDs to specific uORB topic instances.</p></div><p>Implement the <code>handle_message_battery_status_demo</code> function in <a href="https://github.com/PX4/PX4-Autopilot/blob/main/src/modules/mavlink/mavlink_receiver.cpp" target="_blank" rel="noreferrer">mavlink_receiver.cpp</a>.</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">void</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">MavlinkReceiver</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">handle_message_battery_status_demo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">mavlink_message_t</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">msg)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">	if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ((msg-&gt;sysid </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> mavlink_system.sysid) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">||</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (msg-&gt;compid </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> mavlink_system.compid)) {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">		// ignore battery status coming from other systems or from the autopilot itself</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">		return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">	// external battery measurements</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">	mavlink_battery_status_t</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> battery_mavlink;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">	mavlink_msg_battery_status_decode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(msg, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">battery_mavlink);</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	battery_status_s battery_status{};</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	battery_status.timestamp </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> hrt_absolute_time</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	battery_status.remaining </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">float</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)battery_mavlink.battery_remaining </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 100.0</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">f</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	battery_status.temperature </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">float</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)battery_mavlink.temperature;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	battery_status.connected </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">	_battery_pub.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">publish</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(battery_status);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><div class="info custom-block"><p class="custom-block-title">INFO</p><p>Above we only write to the battery fields that are defined in the topic. На практиці ви оновлювали б всі поля або з дійсними, або з недійсними значеннями: це було скорочено для стислості.</p></div><p>and finally make sure it is called in <a href="https://github.com/PX4/PX4-Autopilot/blob/main/src/modules/mavlink/mavlink_receiver.cpp#L228" target="_blank" rel="noreferrer">MavlinkReceiver::handle_message()</a></p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">MavlinkReceiver</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">handle_message</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">mavlink_message_t</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">msg)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    switch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (msg-&gt;msgid) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        ...</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    case</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> MAVLINK_MSG_ID_BATTERY_STATUS_DEMO:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        handle_message_battery_status_demo</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(msg);</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> }</span></span></code></pre></div><h2 id="альтернатива-створення-користувацьких-повідомлень-mavlink" tabindex="-1">Альтернатива створення користувацьких повідомлень MAVLink <a class="header-anchor" href="#альтернатива-створення-користувацьких-повідомлень-mavlink" aria-label="Permalink to &quot;Альтернатива створення користувацьких повідомлень MAVLink&quot;">​</a></h2><p>Іноді існує потреба в довільному повідомленні MAVLink з вмістом, який не повністю визначений.</p><p>Наприклад, при використанні MAVLink для інтерфейсу PX4 з вбудованим пристроєм, повідомлення, якими обмінюються автопілот і пристрій, можуть пройти кілька ітерацій, перш ніж вони будуть стабілізовані. У цьому випадку відновлення заголовків MAVLink може зайняти багато часу і призвести до помилок, а також переконатися, що обидва пристрої використовують одну і ту ж версію протоколу.</p><p>Альтернативним - і тимчасовим - рішенням є перепризначення налагоджувальних повідомлень. Instead of creating a custom MAVLink message <code>CA_TRAJECTORY</code>, you can send a message <code>DEBUG_VECT</code> with the string key <code>CA_TRAJ</code> and data in the <code>x</code>, <code>y</code> and <code>z</code> fields. See <a href="./../debug/debug_values.html">this tutorial</a> for an example usage of debug messages.</p><div class="info custom-block"><p class="custom-block-title">INFO</p><p>This solution is not efficient as it sends character string over the network and involves comparison of strings. Це повинно використовуватися лише для розробки!</p></div><h2 id="тестування" tabindex="-1">Тестування <a class="header-anchor" href="#тестування" aria-label="Permalink to &quot;Тестування&quot;">​</a></h2><p>Як перший крок і під час відлагодження, зазвичай ви просто хочете переконатися, що всі створені вами повідомлення надсилаються/отримуються так, як ви очікуєте.</p><p>You should should first use the <code>uorb top [&lt;message_name&gt;]</code> command to verify in real-time that your message is published and the rate (see <a href="./../middleware/uorb.html#uorb-top-command">uORB Messaging</a>). This approach can also be used to test incoming messages that publish a uORB topic (for other messages you might use <code>printf</code> in your code and test in SITL).</p><p>Існує кілька підходів для перегляду трафіку MAVLink:</p><ul><li><p>Create a <a href="https://mavlink.io/en/guide/wireshark.html" target="_blank" rel="noreferrer">Wireshark MAVLink plugin</a> for your dialect. This allows you to inspect MAVLink traffic on an IP interface - for example between <em>QGroundControl</em> or MAVSDK and your real or simulated version of PX4.</p><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>It is much easier to generate a wireshark plugin and inspect traffic in Wireshark, than to rebuild QGroundControl with your dialect and use MAVLink Inspector.</p></div></li></ul><p>:::</p><ul><li><p><a href="./../dev_log/logging.html">Log uORB topics</a> associate with your MAVLink message.</p></li><li><p>View received messages in the QGroundControl <a href="https://docs.qgroundcontrol.com/master/en/qgc-user-guide/analyze_view/mavlink_inspector.html" target="_blank" rel="noreferrer">MAVLink Inspector</a>. You will need to rebuild QGroundControl with the custom message definitions, <a href="#updating-qgroundcontrol">as described below</a></p></li></ul><h3 id="встановити-швидкість-передачі-за-допомогою-оболонки" tabindex="-1">Встановити швидкість передачі за допомогою оболонки <a class="header-anchor" href="#встановити-швидкість-передачі-за-допомогою-оболонки" aria-label="Permalink to &quot;Встановити швидкість передачі за допомогою оболонки&quot;">​</a></h3><p>Для тестування іноді корисно збільшити швидкість передачі окремих тем під час виконання (наприклад, для перевірки в QGC). This can be achieved using by calling the <a href="./../modules/modules_communication.html#mavlink">mavlink</a> module through the <a href="https://docs.qgroundcontrol.com/master/en/qgc-user-guide/analyze_view/mavlink_console.html" target="_blank" rel="noreferrer">QGC MAVLink console</a> (or some other shell):</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mavlink</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> stream</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -u</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">port</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> numbe</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">r</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -s</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">mavlink</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> topic</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> nam</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -r</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">rat</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span></span></code></pre></div><p>You can get the port number with <code>mavlink status</code> which will output (amongst others) <code>transport protocol: UDP (&lt;port number&gt;)</code>. Прикладом може бути:</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mavlink</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> stream</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -u</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 14556</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> CA_TRAJECTORY</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -r</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 300</span></span></code></pre></div><h2 id="оновлення-наземних-станціи" tabindex="-1">Оновлення наземних станцій <a class="header-anchor" href="#оновлення-наземних-станціи" aria-label="Permalink to &quot;Оновлення наземних станцій&quot;">​</a></h2><p>Зрештою, ви захочете використовувати ваш новий інтерфейс MAVLink, надавши відповідну наземну станцію або реалізацію MAVSDK.</p><p>Важливо пам&#39;ятати, що MAVLink вимагає, щоб ви використовували версію бібліотеки, яка побудована за тим самим визначенням (XML-файл). Отже, якщо ви створили власне повідомлення у PX4, ви не зможете його використати, доки не зберете QGC або MAVSDK з тим самим визначенням.</p><h3 id="оновлення-qgroundcontrol" tabindex="-1">Оновлення QGroundControl <a class="header-anchor" href="#оновлення-qgroundcontrol" aria-label="Permalink to &quot;Оновлення QGroundControl&quot;">​</a></h3><p>You will need to <a href="https://docs.qgroundcontrol.com/master/en/qgc-dev-guide/getting_started/index.html" target="_blank" rel="noreferrer">Build QGroundControl</a> including a pre-built C library that contains your custom messages.</p><p>QGC uses a pre-built C library that must be located at <a href="https://github.com/mavlink/qgroundcontrol/tree/master/libs/mavlink/include/mavlink" target="_blank" rel="noreferrer">/qgroundcontrol/libs/mavlink/include/mavlink</a> in the QGC source.</p><p>By default this is pre-included as a submodule from <a href="https://github.com/mavlink/c_library_v2" target="_blank" rel="noreferrer">https://github.com/mavlink/c_library_v2</a> but you can <a href="https://mavlink.io/en/getting_started/generate_libraries.html" target="_blank" rel="noreferrer">generate your own MAVLink Libraries</a>.</p><p>QGC uses the all.xml dialect by default, which includes <strong>common.xml</strong>. Ви можете додавати свої повідомлення як у файлі, так і у власному діалекті. However if you use your own dialect then it should include ArduPilotMega.xml (or it will miss all the existing messages), and you will need to change the dialect used by setting it in <a href="https://github.com/mavlink/qgroundcontrol/blob/master/QGCExternalLibs.pri#L52" target="_blank" rel="noreferrer"><code>MAVLINK_CONF</code></a> when running <em>qmake</em>.</p><h3 id="оновлення-mavsdk" tabindex="-1">Оновлення MAVSDK <a class="header-anchor" href="#оновлення-mavsdk" aria-label="Permalink to &quot;Оновлення MAVSDK&quot;">​</a></h3><p>See the MAVSDK docs for information about how to work with <a href="https://mavsdk.mavlink.io/main/en/cpp/guide/build.html" target="_blank" rel="noreferrer">MAVLink headers and dialects</a>.</p>`,112)]))}const g=i(n,[["render",l]]);export{c as __pageData,g as default};
