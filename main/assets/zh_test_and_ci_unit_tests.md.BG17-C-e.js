import{_ as e,c as a,j as s,a as i,a8 as n,o as l}from"./chunks/framework.BDnHobkS.js";const g=JSON.parse('{"title":"单元测试","description":"","frontmatter":{},"headers":[],"relativePath":"zh/test_and_ci/unit_tests.md","filePath":"zh/test_and_ci/unit_tests.md"}'),p={name:"zh/test_and_ci/unit_tests.md"};function h(r,t,o,d,k,c){return l(),a("div",null,t[0]||(t[0]=[s("h1",{id:"单元测试",tabindex:"-1"},[i("单元测试 "),s("a",{class:"header-anchor",href:"#单元测试","aria-label":'Permalink to "单元测试"'},"​")],-1),s("p",null,"我们鼓励开发人员在开发的每个模块时编写单元测试，包括添加新功能，修复错误和重构。",-1),s("p",null,"或者，也可以直接从 bash 运行完整的单元测试：",-1),s("ol",null,[s("li",null,[i("Unit tests with "),s("a",{href:"https://github.com/google/googletest/blob/main/docs/primer.md",target:"_blank",rel:"noreferrer"},"Google Test"),i(' ("GTest") - tests that have minimal, internal-only dependencies')]),s("li",null,[i("在 "),s("strong",{"x-id":"1"},"test_[description].cpp"),i(" 中包括基本 unittest-class"),s("code",null,"&lt;unit_test.h&gt;"),i(" 以及为新功能编写测试所需的所有文件。")]),s("li",null,"软件在环(SITL)单元测试。 这些测试需要运行在完整的SITL环境中， 运行起来更慢，更难调试，所以建议尽可能使用GTest代替。")],-1),n(`<h2 id="编写测试" tabindex="-1">编写测试 <a class="header-anchor" href="#编写测试" aria-label="Permalink to &quot;编写测试&quot;">​</a></h2><p><strong>Tip</strong>: In general, if you need access to advanced GTest utilities, data structures from the STL or need to link to <code>parameters</code> or <code>uorb</code> libraries you should use the functional tests instead.</p><p>创建新的单元测试步骤如下：</p><ol><li>单元测试分成三个部分：设置、运行、检查结果。 每个单元测试都应该测试一个特定行为或设置案例，如果测试失败，则很明显你的测试代码有错误。 请尽可能遵循这些标准。</li><li>Copy and rename the example unit test <a href="https://github.com/PX4/PX4-Autopilot/blob/main/src/modules/mc_att_control/AttitudeControl/AttitudeControlTest.cpp" target="_blank" rel="noreferrer">AttitudeControlTest</a> to the directory the code to be tested is in.</li><li>Add the new file to the directory&#39;s <code>CMakeLists.txt</code>. It should look something like <code>px4_add_unit_gtest(SRC MyNewUnitTest.cpp LINKLIBS &lt;library_to_be_tested&gt;)</code></li><li>添加你想要的测试功能。 这包括了添加所需的头文件、新测试(每个测试都应该有单独的名称)，并加入相关逻辑，运行测试代码并验证其行为是否符合预期。</li><li>If additional library dependencies are required, they should also be added to the CMakeLists after the <code>LINKLIBS</code> as shown above.</li></ol><p>Tests can be run via <code>make tests</code>, after which you will find the binary in <code>build/px4_sitl_test/unit-MyNewUnit</code>. 也可以直接通过调试器中运行。</p><h2 id="写一个gtest功能测试" tabindex="-1">写一个GTest功能测试 <a class="header-anchor" href="#写一个gtest功能测试" aria-label="Permalink to &quot;写一个GTest功能测试&quot;">​</a></h2><p>当测试或测试的组件依赖参数、uORB 消息、或更高级的GTest功能的时候，应当使用GTest功能测试。 Additionally, functional tests can contain local usage of STL data structures (although be careful of platform differences between e.g. macOS and Linux).</p><p>创建一个新的功能测试步骤如下：</p><ol><li>一般来说（与单元测试类似）功能测试应分为三个部分：设置，运行，检查结果。 每个单元测试都应该测试一个特定行为或设置案例，如果测试失败，则很明显你的测试代码有错误。 请尽可能遵循这些标准。</li><li>Copy and rename the example functional test <a href="https://github.com/PX4/PX4-Autopilot/blob/main/src/lib/parameters/ParameterTest.cpp" target="_blank" rel="noreferrer">ParameterTest</a> to the directory the code to be tested is in.</li><li>将ParameterTest 重命名为更符合你正在测试的代码功能。</li><li>Add the new file to the directory&#39;s <code>CMakeLists.txt</code>. It should look something like <code>px4_add_functional_gtest(SRC MyNewFunctionalTest.cpp LINKLIBS &lt;library_to_be_tested&gt;)</code></li><li>添加你想要的测试功能。 这包括了，添加特定的头文件、新测试（每个测试都应该使用不同的命名），并设置相关逻辑，运行测试代码并验证是否符合预期。</li><li>If additional library dependencies are required, they should also be added to the CMakeLists after the <code>LINKLIBS</code> as shown above.</li></ol><p>Tests can be run via <code>make tests</code>, after which you will find the binary in <code>build/px4_sitl_test/functional-MyNewFunctional</code>. It can be run directly in a debugger, however be careful to only run one test per executable invocation using the <a href="https://github.com/google/googletest/blob/main/docs/advanced.md#running-a-subset-of-the-tests" target="_blank" rel="noreferrer">--gtest_filter=&lt;regex&gt;</a> arguments, as some parts of the uORB and parameter libraries don&#39;t clean themselves up perfectly and may result in undefined behavior if set up multiple times.</p><h2 id="写一个软件在环-sitl-单元测试" tabindex="-1">写一个软件在环（SITL）单元测试 <a class="header-anchor" href="#写一个软件在环-sitl-单元测试" aria-label="Permalink to &quot;写一个软件在环（SITL）单元测试&quot;">​</a></h2><p>当需要所有的飞行控制组件：驱动、时间或者更多时，应该SITL单元测试。 这些测试运行较慢(每个模块至少1秒+)，同时难以测试，所以仅在必要时使用它们。</p><p>创建一个新的SITL单元测试步骤如下：</p><ol><li><p>Examine the sample <a href="https://github.com/PX4/PX4-Autopilot/blob/main/src/include/unit_test.h" target="_blank" rel="noreferrer">Unittest-class</a>.</p></li><li><p>Create a new .cpp file within <a href="https://github.com/PX4/PX4-Autopilot/tree/main/src/systemcmds/tests" target="_blank" rel="noreferrer">tests</a> with name <strong>test_[description].cpp</strong>.</p></li><li><p>Within <strong>test_[description].cpp</strong> include the base unittest-class <code>&lt;unit_test.h&gt;</code> and all files required to write a test for the new feature.</p></li><li><p>Within <strong>test_[description].cpp</strong> create a class <code>[Description]Test</code> that inherits from <code>UnitTest</code>.</p></li><li><p>Within <code>[Description]Test</code> class declare the public method <code>virtual bool run_tests()</code>.</p></li><li><p>Within <code>[Description]Test</code> class declare all private methods required to test the feature in question (<code>test1()</code>, <code>test2()</code>,...).</p></li><li><p>Within <strong>test_[description].cpp</strong> implement the <code>run_tests()</code> method where each test[1,2,...] will be run.</p></li><li><p>Within <strong>test_[description].cpp</strong>, implement the various tests.</p></li><li><p>At the bottom within <strong>test_[description].cpp</strong> declare the test.</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ut_declare_test_c</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(test_[description], [</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">Description</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]Test)</span></span></code></pre></div><p>下面是一个模板：</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#include</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &lt;unit_test.h&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#include</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;[new feature].h&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [Description]Test : public UnitTest</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    virtual</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> bool</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> run_tests</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">private:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    bool</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> test1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    bool</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> test2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">bool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [Description]</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Test</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">run_tests</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    ut_run_test</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(test1)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    ut_run_test</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(test2)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (_tests_failed </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">bool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [Description]</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Test</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">test1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ut_[name of one of the unit test functions](...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ut_[name of one of the unit test functions](...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">bool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [Description]</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Test</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">test2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ut_[name of one of the unit test functions](...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ut_[name of one of the unit test functions](...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ut_declare_test_c</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(test_[description], [</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">Description</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]Test)</span></span></code></pre></div><p>Note that <code>ut_[name of one of the unit test functions]</code> corresponds to one of the unittest functions defined within <a href="https://github.com/PX4/PX4-Autopilot/blob/main/src/include/unit_test.h" target="_blank" rel="noreferrer">unit_test.h</a>.</p></li><li><p>Within <a href="https://github.com/PX4/PX4-Autopilot/blob/main/src/systemcmds/tests/tests_main.h" target="_blank" rel="noreferrer">tests_main.h</a> define the new test:</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">extern</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> test_[description](</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> argc, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">char</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">argv[]);</span></span></code></pre></div></li><li><p>Within <a href="https://github.com/PX4/PX4-Autopilot/blob/main/src/systemcmds/tests/tests_main.c" target="_blank" rel="noreferrer">tests_main.c</a> add description name, test function and option:</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">} tests[] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;[description]&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, test_[description], OPTION},</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><code>OPTION</code> can be <code>OPT_NOALLTEST</code>,<code>OPT_NOJIGTEST</code> or <code>0</code> and is considered if within px4 shell one of the two commands are called:</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pxh</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">tests</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> all</span></span></code></pre></div><p>或</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pxh</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">tests</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> jig</span></span></code></pre></div><p>If a test has option <code>OPT_NOALLTEST</code>, then that test will be excluded when calling <code>tests all</code>. The same is true for <code>OPT_NOJITEST</code> when command <code>test jig</code> is called. Option <code>0</code> means that the test is never excluded, which is what most developer want to use.</p></li><li><p>Add the test <code>test_[description].cpp</code> to the <a href="https://github.com/PX4/PX4-Autopilot/blob/main/src/systemcmds/tests/CMakeLists.txt" target="_blank" rel="noreferrer">CMakeLists.txt</a>.</p></li></ol><h2 id="在本地计算机上进行测试" tabindex="-1">在本地计算机上进行测试 <a class="header-anchor" href="#在本地计算机上进行测试" aria-label="Permalink to &quot;在本地计算机上进行测试&quot;">​</a></h2><p>Run the complete list of GTest Unit Tests, GTest Functional Tests and SITL Unit Tests right from bash:</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">make</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tests</span></span></code></pre></div><p>The individual GTest test binaries are in the <code>build/px4_sitl_test/</code> directory, and can be run directly in most IDEs&#39; debugger.</p><p>使用以下命令对ctest名称使用正则表达式对要运行的测试子集进行筛选：</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">make</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tests</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> TESTFILTER=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">regex</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> filter</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> expressio</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">n</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span></span></code></pre></div><p>例如：</p><ul><li><code>make tests TESTFILTER=unit</code> only run GTest unit tests</li><li><code>make tests TESTFILTER=sitl</code> only run simulation tests</li><li><code>make tests TESTFILTER=Attitude</code> only run the <code>AttitudeControl</code> test</li></ul>`,22)]))}const u=e(p,[["render",h]]);export{g as __pageData,u as default};
