import{_ as i,c as a,a8 as e,o as t}from"./chunks/framework.BDnHobkS.js";const c=JSON.parse('{"title":"Відтворення усієї системи","description":"","frontmatter":{},"headers":[],"relativePath":"uk/debug/system_wide_replay.md","filePath":"uk/debug/system_wide_replay.md"}'),l={name:"uk/debug/system_wide_replay.md"};function p(n,s,h,d,o,r){return t(),a("div",null,s[0]||(s[0]=[e(`<h1 id="відтворення-усієі-системи" tabindex="-1">Відтворення усієї системи <a class="header-anchor" href="#відтворення-усієі-системи" aria-label="Permalink to &quot;Відтворення усієї системи&quot;">​</a></h1><p>Можливо записувати та відтворювати довільні частини системи на основі повідомлень ORB.</p><p>Перегравання корисне для тестування ефекту різних значень параметрів на основі реальних даних, порівняння різних оцінювачів тощо.</p><h2 id="вимоги" tabindex="-1">Вимоги <a class="header-anchor" href="#вимоги" aria-label="Permalink to &quot;Вимоги&quot;">​</a></h2><p>Перший крок - визначити модуль або модулі, які слід відтворити. Потім визначте всі вхідні дані для цих модулів, тобто підписані теми ORB. Для системного відтворення це включає в себе всі апаратні вхідні дані: сенсори, вхід RC, команди MAVLink та файлову систему.</p><p>All identified topics need to be logged at full rate (see <a href="./../dev_log/logging.html">logging</a>). For <code>ekf2</code> this is already the case with the default set of logged topics.</p><p>It is important that all replayed topics contain only a single absolute timestamp, which is the automatically generated field <code>timestamp</code>. Якщо потрібно додати більше відміток часу, вони повинні бути відносно основної відмітки. For an example, see <a href="https://github.com/PX4/PX4-Autopilot/blob/main/msg/SensorCombined.msg" target="_blank" rel="noreferrer">SensorCombined.msg</a>. Причини цього наведено нижче.</p><h2 id="використання" tabindex="-1">Використання <a class="header-anchor" href="#використання" aria-label="Permalink to &quot;Використання&quot;">​</a></h2><ul><li><p>Спочатку виберіть файл для відтворення та побудуйте ціль (з каталогу PX4-Autopilot):</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> replay</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">absolute_path_to_log_file.ulg</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">make</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> px4_sitl_default</span></span></code></pre></div><p>This will create the build/make output in a separate build directory <code>build/px4_sitl_default_replay</code> (so that the parameters don&#39;t interfere with normal builds). It&#39;s possible to choose any posix SITL build target for replay, since the build system knows through the <code>replay</code> environment variable that it&#39;s in replay mode.</p></li><li><p>Add ORB publisher rules in the file <code>build/px4_sitl_default_replay/rootfs/orb_publisher.rules</code>. Цей файл визначає модулі, які мають право публікувати певні повідомлення. Має наступний формат:</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">restrict_topics:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">topic</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">1&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">topic</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">2&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ...,</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">topic</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">N</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">module:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">modul</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ignore_others:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/fals</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span></span></code></pre></div><p>This means that the given list of topics should only be published by <code>&lt;module&gt;</code> (which is the command name). Публікації з будь-якої з цих тем з іншого модуля мовчки ігноруються. If <code>ignore_others</code> is <code>true</code>, publications to other topics from <code>&lt;module&gt;</code> are ignored.</p><p>For replay, we only want the <code>replay</code> module to be able to publish the previously identified list of topics. So, for replaying <code>ekf2</code>, the rules file should look like this:</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">restrict_topics:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> sensor_combined,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> vehicle_gps_position,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> vehicle_land_detected</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">module:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> replay</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ignore_others:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span></span></code></pre></div><p>З цим модулями, які зазвичай публікують ці теми, не потрібно вимикати для повторення.</p></li><li><p><em>(Optional)</em> Setup parameter overrides (see <a href="#overriding-parameters-in-the-original-log">instructions below</a>).</p></li><li><p><em>(Optional)</em> Copy a <code>dataman</code> mission file from the SD card to the build directory. Це потрібно лише у випадку, якщо місію слід переграти.</p></li><li><p>Почніть відтворення:</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">make</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> px4_sitl_default</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> jmavsim</span></span></code></pre></div><p>Це автоматично відкриє файл журналу, застосує параметри та почне відтворення. Після завершення буде повідомляти про результат і вихід. Новостворений файл журналу можна потім проаналізувати. It can be found in <code>rootfs/fs/microsd/log</code>, in subdirectories organised by date. Replayed log file names will have the <code>_replayed</code> suffix.</p><p>Зверніть увагу, що вищезазначена команда також покаже симулятор, але - в залежності від того, що відтворюється - вона не покаже, що насправді відбувається. Ще завжди можна підключитися через QGC та, наприклад, переглянути зміну ставлення під час відтворення.</p></li><li><p>Нарешті, скасуйте змінну середовища, щоб знову використовувалися звичайні цілі збирання:</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">unset</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> replay</span></span></code></pre></div></li></ul><h3 id="перевизначення-параметрів-у-вихідному-журналі" tabindex="-1">Перевизначення параметрів у вихідному журналі <a class="header-anchor" href="#перевизначення-параметрів-у-вихідному-журналі" aria-label="Permalink to &quot;Перевизначення параметрів у вихідному журналі&quot;">​</a></h3><p>За замовчуванням, під час відтворення застосовуються всі параметри зі стартового файлу журналу. Якщо параметр змінюється під час запису, він буде змінений у відповідний час під час відтворення.</p><p>Parameters can be overridden during a replay in two ways: <em>fixed</em> and <em>dynamic</em>. Коли параметри перевизначаються, відповідні зміни параметрів в журналі не застосовуються під час повторного відтворення.</p><ul><li><p><strong>Fixed parameter overrides</strong> will override parameters from the start of the replay. They are defined in the file <code>build/px4_sitl_default_replay/rootfs/replay_params.txt</code>, where each line should have the format <code>&lt;param_name&gt; &lt;value&gt;</code>. Наприклад:</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">EKF2_RNG_NOISE</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0.1</span></span></code></pre></div></li><li><p><strong>Dynamic parameter overrides</strong> will update parameter values at specified times. Ці параметри все ще будуть ініціалізовані до значень у журналі або в зафіксованих замінах. Parameter update events should be defined in <code>build/px4_sitl_default_replay/rootfs/replay_params_dynamic.txt</code>, where each line has the format <code>&lt;param_name&gt; &lt;value&gt; &lt;timestamp&gt;</code>. Відмітка часу - це час у секундах з моменту початку журналу. Наприклад:</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">EKF2_RNG_NOISE</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0.15</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 23.4</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">EKF2_RNG_NOISE</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0.05</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 56.7</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">EKF2_RNG_DELAY</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4.5</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 30.0</span></span></code></pre></div></li></ul><h3 id="важливе-зауваження" tabindex="-1">Важливе зауваження <a class="header-anchor" href="#важливе-зауваження" aria-label="Permalink to &quot;Важливе зауваження&quot;">​</a></h3><ul><li>Під час відтворення всі відключення в журналі звітуються. Вони мають негативний вплив на повторення, тому слід уникати втрат під час запису.</li><li>Наразі можливо лише відтворення в &#39;реальному часі&#39;: так швидко, як було зроблено запис. Це планується розширити у майбутньому.</li><li>Повідомлення з міткою часу 0 буде вважатися недійсним і не буде відтворено.</li></ul><h2 id="ekf2-повтор" tabindex="-1">EKF2 Повтор <a class="header-anchor" href="#ekf2-повтор" aria-label="Permalink to &quot;EKF2 Повтор&quot;">​</a></h2><p>Це спеціалізація системного повторення для швидкого відтворення EKF2.</p><div class="info custom-block"><p class="custom-block-title">INFO</p><p>The recording and replay of flight logs with <a href="./../advanced_config/tuning_the_ecl_ekf.html#running-multiple-ekf-instances">multiple EKF instances</a> is not supported. To enable recording for EKF replay you must set the parameters to enable a <a href="./../advanced_config/tuning_the_ecl_ekf.html#running-a-single-ekf-instance">single EKF instance</a>.</p></div><p>У режимі EKF2 відтворення автоматично створить правила публікації ORB, описані вище.</p><p>Для виконання повторення EKF2:</p><ul><li><p>Запишіть оригінальний журнал. Optionally set <code>SDLOG_MODE</code> to <code>1</code> to log from boot.</p></li><li><p>In addition to the <code>replay</code> environment variable, set <code>replay_mode</code> to <code>ekf2</code>:</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> replay_mode</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ekf2</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> replay</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">absolute_path_to_log.ulg</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span></span></code></pre></div></li><li><p>Run the replay with the <code>none</code> target:</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">make</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> px4_sitl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> none</span></span></code></pre></div></li><li><p>Once finished, unset both <code>replay</code> and <code>replay_mode</code>.</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">unset</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> replay</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">unset</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> replay_mode</span></span></code></pre></div></li></ul><h3 id="налаштування-конкретних-параметрів-ekf2-для-відтворення" tabindex="-1">Налаштування конкретних параметрів EKF2 для відтворення <a class="header-anchor" href="#налаштування-конкретних-параметрів-ekf2-для-відтворення" aria-label="Permalink to &quot;Налаштування конкретних параметрів EKF2 для відтворення&quot;">​</a></h3><p>First install <code>pyulog</code>:</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pip</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --user</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> pyulog</span></span></code></pre></div><p>Extract the original log&#39;s parameters to <code>replay_params.txt</code>:</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ulog_params</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -i</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$replay</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39; &#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> grep</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -e</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;^EKF2&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> build/px4_sitl_default_replay/rootfs/replay_params.txt</span></span></code></pre></div><p>Adjust these as desired, and add dynamic parameter overrides in <code>replay_params_dynamic.txt</code> if necessary.</p><h2 id="позаду-кадру" tabindex="-1">Позаду кадру <a class="header-anchor" href="#позаду-кадру" aria-label="Permalink to &quot;Позаду кадру&quot;">​</a></h2><p>Перегравання розділено на 3 компоненти:</p><ul><li>A replay module These have a negative effect on replay, so care should be taken to avoid dropouts during recording.</li><li>Наразі можливо лише відтворення в &#39;реальному часі&#39;: так швидко, як було зроблено запис.</li></ul><p>Модуль відтворення читає журнал та публікує повідомлення з тією самою швидкістю, з якою вони були записані. До часового позначення кожного повідомлення додається постійний зсув, щоб відповідати поточному часу системи (це причина, чому всі інші часові позначення повинні бути відносними). The command <code>replay tryapplyparams</code> is executed before all other modules are loaded and applies the parameters from the log and user-set parameters. Then as the last command, <code>replay trystart</code> will again apply the parameters and start the actual replay. Both commands do nothing if the environment variable <code>replay</code> is not set.</p><p>Правила видавця ORB дозволяють вибрати, яка частина системи повторюється, як описано вище. Вони компілюються лише для цільових posix SITL.</p><p>The <strong>time handling</strong> is still an <strong>open point</strong>, and needs to be implemented.</p>`,33)]))}const g=i(l,[["render",p]]);export{c as __pageData,g as default};
