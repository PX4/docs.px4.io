import{_ as i}from"./chunks/flamegraph-example.BMF70yu_.js";import{_ as a,c as e,a8 as t,o as h}from"./chunks/framework.BDnHobkS.js";const g=JSON.parse(`{"title":"Poor Man's Sampling Profiler","description":"","frontmatter":{},"headers":[],"relativePath":"uk/debug/profiling.md","filePath":"uk/debug/profiling.md"}`),l={name:"uk/debug/profiling.md"};function n(p,s,r,o,d,k){return h(),e("div",null,s[0]||(s[0]=[t(`<h1 id="poor-man-s-sampling-profiler" tabindex="-1">Poor Man&#39;s Sampling Profiler <a class="header-anchor" href="#poor-man-s-sampling-profiler" aria-label="Permalink to &quot;Poor Man&#39;s Sampling Profiler&quot;">​</a></h1><p>This section describes how you can use the <a href="https://github.com/PX4/PX4-Autopilot/blob/main/platforms/nuttx/Debug/poor-mans-profiler.sh" target="_blank" rel="noreferrer">Poor Man&#39;s Sampling Profiler</a> (PMSP) shell script to assess the performance of PX4. This is an implementation of a known method originally invented by <a href="https://poormansprofiler.org/" target="_blank" rel="noreferrer">Mark Callaghan and Domas Mituzas</a>.</p><h2 id="підхід" tabindex="-1">Підхід <a class="header-anchor" href="#підхід" aria-label="Permalink to &quot;Підхід&quot;">​</a></h2><p>PMSP - це оболонковий сценарій, який працює шляхом переривання виконання прошивки періодично для збору поточного стеку викликів. Відмічені трасування стеку додаються в текстовий файл. Once sampling is finished (which normally takes about an hour or more), the collected stack traces are <em>folded</em>. The result of <em>folding</em> is another text file that contains the same stack traces, except that all similar stack traces (i.e. those that were obtained at the same point in the program) are joined together, and the number of their occurrences is recorded. The folded stacks are then fed into the visualization script, for which purpose we employ <a href="http://www.brendangregg.com/flamegraphs.html" target="_blank" rel="noreferrer">FlameGraph - an open source stack trace visualizer</a>.</p><h2 id="основне-використання" tabindex="-1">Основне використання <a class="header-anchor" href="#основне-використання" aria-label="Permalink to &quot;Основне використання&quot;">​</a></h2><h3 id="вимоги" tabindex="-1">Вимоги <a class="header-anchor" href="#вимоги" aria-label="Permalink to &quot;Вимоги&quot;">​</a></h3><p>Профілер покладається на GDB для запуску PX4 на вбудованій цілі. Так що перед профілюванням цілі, вам потрібно мати обладнання, яке ви хочете профілювати, і вам потрібно скомпілювати та завантажити прошивку на це обладнання. You will then need a <a href="./../debug/swd_debug.html#debug-probes">debug probe</a> (such as the DroneCode Probe), to run the GDB server and interact with the board.</p><h3 id="визначення-пристрою-відладки" tabindex="-1">Визначення пристрою відладки <a class="header-anchor" href="#визначення-пристрою-відладки" aria-label="Permalink to &quot;Визначення пристрою відладки&quot;">​</a></h3><p>The <code>poor-mans-profiler.sh</code> automatically detects and uses the correct USB device if you use it with a <a href="./../debug/probe_bmp.html#dronecode-probe">DroneCode Probe</a>. If you use a different kind of probe you may need to pass in the specific <em>device</em> on which the debugger is located. You can use the bash command <code>ls -alh /dev/serial/by-id/</code> to enumerate the possible devices on Ubuntu. Наприклад, наступні пристрої перераховані з підключеними через USB Pixhawk 4 та DroneCode Probe:</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">user@ubuntu:~/PX4-Autopilot$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ls</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -alh</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /dev/serial/by-id/</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">total</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">drwxr-xr-x</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> root</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> root</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 100</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Apr</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 23</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 18:57</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> .</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">drwxr-xr-x</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> root</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> root</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  80</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Apr</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 23</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 18:48</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ..</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">lrwxrwxrwx</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> root</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> root</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  13</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Apr</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 23</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 18:48</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> usb-3D_Robotics_PX4_FMU_v5.x_0-if00</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> -</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ../../ttyACM0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">lrwxrwxrwx</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> root</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> root</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  13</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Apr</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 23</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 18:57</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> usb-Black_Sphere_Technologies_Black_Magic_Probe_BFCCB401-if00</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> -</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ../../ttyACM1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">lrwxrwxrwx</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> root</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> root</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  13</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Apr</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 23</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 18:57</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> usb-Black_Sphere_Technologies_Black_Magic_Probe_BFCCB401-if02</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> -</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ../../ttyACM2</span></span></code></pre></div><p>In this case, the script would automatically pick up the device named <code>*Black_Magic_Probe*-if00</code>. Але якщо ви використовуєте інший пристрій, ви зможете знайти відповідний ідентифікатор у вищезазначеному переліку.</p><p>Then pass in the appropriate device using the <code>--gdbdev</code> argument like this:</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./poor-mans-profiler.sh</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --elf=build/px4_fmu-v4_default/px4_fmu-v4_default.elf</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --nsamples=30000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --gdbdev=/dev/ttyACM2</span></span></code></pre></div><h3 id="запуск" tabindex="-1">Запуск <a class="header-anchor" href="#запуск" aria-label="Permalink to &quot;Запуск&quot;">​</a></h3><p>Основне використання профілера доступне через систему збірки. For example, the following command builds and profiles px4_fmu-v4pro target with 10000 samples (fetching <em>FlameGraph</em> and adding it to the path as needed).</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">make</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> px4_fmu-v4pro_default</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> profile</span></span></code></pre></div><p>For more control over the build process, including setting the number of samples, see the <a href="#implementation">Implementation</a>.</p><h2 id="розуміння-виводу" tabindex="-1">Розуміння виводу <a class="header-anchor" href="#розуміння-виводу" aria-label="Permalink to &quot;Розуміння виводу&quot;">​</a></h2><p>Знизу наведено знімок екрану прикладового виводу (зверніть увагу, що тут він не є інтерактивним):</p><p><img src="`+i+'" alt="FlameGraph Example"></p><p>На графіку пламені, горизонтальні рівні представляють рамки стеку, тоді як ширина кожної рамки пропорційна кількості разів, коли вона була вибрана. Зі свого боку, кількість разів, коли функцію виявилися вибраною, пропорційна тривалості множеній на частоту її виконання.</p><h2 id="можливі-проблеми" tabindex="-1">Можливі проблеми <a class="header-anchor" href="#можливі-проблеми" aria-label="Permalink to &quot;Можливі проблеми&quot;">​</a></h2><p>Сценарій був розроблений як тимчасове рішення, тому він має деякі проблеми. Будь ласка, будьте обережні з ними під час використання:</p><ul><li><p>Якщо GDB працює некоректно, скрипт може не виявити це і продовжити виконання. У цьому випадку, очевидно, не буде вироблено жодних придатних стеків. In order to avoid that, the user should periodically check the file <code>/tmp/pmpn-gdberr.log</code>, which contains the stderr output of the most recent invocation of GDB. У майбутньому сценарій слід змінити так, щоб він викликав GDB у тихому режимі, де він буде вказувати проблеми через свій код виходу.</p></li><li><p>Іноді GDB просто залишається назавжди, поки відбувається вибіркове збереження стеку. Під час цієї несправності ціль буде припинена на невизначений термін. The solution is to manually abort the script and re-launch it again with the <code>--append</code> option. У майбутньому сценарій слід змінити, щоб накладати тайм-аут на кожне викликання GDB.</p></li><li><p>Багатопотокові середовища не підтримуються. Це не впливає на однопроцесорні вбудовані цілі, оскільки вони завжди виконуються в одному потоці, але це обмеження робить профілер несумісним з багатьма іншими програмами. У майбутньому папку стеку слід модифікувати для підтримки кількох стеків викликів на один зразок.</p></li></ul><h2 id="імплементація" tabindex="-1">Імплементація <a class="header-anchor" href="#імплементація" aria-label="Permalink to &quot;Імплементація&quot;">​</a></h2><p>The script is located at <a href="https://github.com/PX4/PX4-Autopilot/blob/main/platforms/nuttx/Debug/poor-mans-profiler.sh" target="_blank" rel="noreferrer">/platforms/nuttx/Debug/poor-mans-profiler.sh</a> Once launched, it will perform the specified number of samples with the specified time interval. Collected samples will be stored in a text file in the system temp directory (typically <code>/tmp</code>). Після завершення вибіркового відбору сценарій автоматично викличе папку стеку, вихід якої буде збережено в сусідньому файлі в тимчасовому каталозі. If the stacks were folded successfully, the script will invoke the <em>FlameGraph</em> script and store the result in an interactive SVG file. Зверніть увагу, що не всі переглядачі зображень підтримують інтерактивні зображення; рекомендується відкрити отриманий SVG у веб-переглядачі.</p><p>The FlameGraph script must reside in the <code>PATH</code>, otherwise PMSP will refuse to launch.</p><p>PMSP використовує GDB для збору стек-відстежень. Currently it uses <code>arm-none-eabi-gdb</code>, other toolchains may be added in the future.</p><p>Для того щоб мати можливість відображати місця розташування пам&#39;яті на символи, сценарій повинен посилатися на виконуваний файл, який в даний момент працює на цільовому пристрої. This is done with the help of the option <code>--elf=&lt;file&gt;</code>, which expects a path (relative to the root of the repository) pointing to the location of the currently executing ELF.</p><p>Приклад використання:</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./poor-mans-profiler.sh</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --elf=build/px4_fmu-v4_default/px4_fmu-v4_default.elf</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --nsamples=30000</span></span></code></pre></div><p>Зверніть увагу, що кожен запуск скрипта перезапише старі стеки. Should you want to append to the old stacks rather than overwrite them, use the option <code>--append</code>:</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./poor-mans-profiler.sh</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --elf=build/px4_fmu-v4_default/px4_fmu-v4_default.elf</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --nsamples=30000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --append</span></span></code></pre></div><p>As one might suspect, <code>--append</code> with <code>--nsamples=0</code> will instruct the script to only regenerate the SVG without accessing the target at all.</p><p>Будь ласка, прочитайте сценарій для більш глибокого розуміння того, як це працює.</p>',35)]))}const u=a(l,[["render",n]]);export{g as __pageData,u as default};
