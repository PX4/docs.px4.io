import{_ as s,c as i,a8 as a,o as t}from"./chunks/framework.BDnHobkS.js";const k=JSON.parse('{"title":"System-wide Replay","description":"","frontmatter":{},"headers":[],"relativePath":"en/debug/system_wide_replay.md","filePath":"en/debug/system_wide_replay.md"}'),l={name:"en/debug/system_wide_replay.md"};function n(p,e,h,r,o,d){return t(),i("div",null,e[0]||(e[0]=[a(`<h1 id="system-wide-replay" tabindex="-1">System-wide Replay <a class="header-anchor" href="#system-wide-replay" aria-label="Permalink to &quot;System-wide Replay&quot;">​</a></h1><p>It is possible to record and replay arbitrary parts of the system based on ORB messages.</p><p>Replay is useful to test the effect of different parameter values based on real data, compare different estimators, etc.</p><h2 id="prerequisites" tabindex="-1">Prerequisites <a class="header-anchor" href="#prerequisites" aria-label="Permalink to &quot;Prerequisites&quot;">​</a></h2><p>The first step is to identify the module or modules that should be replayed. Then, identify all the inputs to these modules, i.e. subscribed ORB topics. For system-wide replay, this consists of all hardware input: sensors, RC input, MAVLink commands and file system.</p><p>All identified topics need to be logged at full rate (see <a href="./../dev_log/logging.html">logging</a>). For <code>ekf2</code> this is already the case with the default set of logged topics.</p><p>It is important that all replayed topics contain only a single absolute timestamp, which is the automatically generated field <code>timestamp</code>. Should there be more timestamps, they must be relative to the main timestamp. For an example, see <a href="https://github.com/PX4/PX4-Autopilot/blob/main/msg/SensorCombined.msg" target="_blank" rel="noreferrer">SensorCombined.msg</a>. Reasons for this are given below.</p><h2 id="usage" tabindex="-1">Usage <a class="header-anchor" href="#usage" aria-label="Permalink to &quot;Usage&quot;">​</a></h2><ul><li><p>First, choose the file to replay and build the target (from within the PX4-Autopilot directory):</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> replay</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">absolute_path_to_log_file.ulg</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">make</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> px4_sitl_default</span></span></code></pre></div><p>This will create the build/make output in a separate build directory <code>build/px4_sitl_default_replay</code> (so that the parameters don&#39;t interfere with normal builds). It&#39;s possible to choose any posix SITL build target for replay, since the build system knows through the <code>replay</code> environment variable that it&#39;s in replay mode.</p></li><li><p>Add ORB publisher rules in the file <code>build/px4_sitl_default_replay/rootfs/orb_publisher.rules</code>. This file defines the modules that are allowed to publish particular messages. It has the following format:</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">restrict_topics:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">topic</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">1&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">topic</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">2&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ...,</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">topic</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">N</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">module:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">modul</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ignore_others:</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &lt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/fals</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span></span></code></pre></div><p>This means that the given list of topics should only be published by <code>&lt;module&gt;</code> (which is the command name). Publications to any of these topics from another module are silently ignored. If <code>ignore_others</code> is <code>true</code>, publications to other topics from <code>&lt;module&gt;</code> are ignored.</p><p>For replay, we only want the <code>replay</code> module to be able to publish the previously identified list of topics. So, for replaying <code>ekf2</code>, the rules file should look like this:</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">restrict_topics:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> sensor_combined,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> vehicle_gps_position,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> vehicle_land_detected</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">module:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> replay</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ignore_others:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span></span></code></pre></div><p>With this, the modules that usually publish these topics don&#39;t need to be disabled for the replay.</p></li><li><p><em>(Optional)</em> Setup parameter overrides (see <a href="#overriding-parameters-in-the-original-log">instructions below</a>).</p></li><li><p><em>(Optional)</em> Copy a <code>dataman</code> mission file from the SD card to the build directory. This is only necessary if a mission should be replayed.</p></li><li><p>Start the replay:</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">make</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> px4_sitl_default</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> jmavsim</span></span></code></pre></div><p>This will automatically open the log file, apply the parameters and start the replay. Once done, it will report the outcome and exit. The newly generated log file can then be analyzed. It can be found in <code>rootfs/fs/microsd/log</code>, in subdirectories organised by date. Replayed log file names will have the <code>_replayed</code> suffix.</p><p>Note that the above command will show the simulator as well, but - depending on what is being replayed - it will not show what&#39;s actually going on. It is still possible to connect via QGC and, for example, view the changing attitude during replay.</p></li><li><p>Finally, unset the environment variable, so that the normal build targets are used again:</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">unset</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> replay</span></span></code></pre></div></li></ul><h3 id="overriding-parameters-in-the-original-log" tabindex="-1">Overriding Parameters in the Original Log <a class="header-anchor" href="#overriding-parameters-in-the-original-log" aria-label="Permalink to &quot;Overriding Parameters in the Original Log&quot;">​</a></h3><p>By default, all parameters from the original log file are applied during a replay. If a parameter changes during recording, it will be changed at the right time during the replay.</p><p>Parameters can be overridden during a replay in two ways: <em>fixed</em> and <em>dynamic</em>. When parameters are overridden, corresponding parameter changes in the log are not applied during replay.</p><ul><li><p><strong>Fixed parameter overrides</strong> will override parameters from the start of the replay. They are defined in the file <code>build/px4_sitl_default_replay/rootfs/replay_params.txt</code>, where each line should have the format <code>&lt;param_name&gt; &lt;value&gt;</code>. For example:</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">EKF2_RNG_NOISE</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0.1</span></span></code></pre></div></li><li><p><strong>Dynamic parameter overrides</strong> will update parameter values at specified times. These parameters will still be initialised to the values in the log or in the fixed overrides. Parameter update events should be defined in <code>build/px4_sitl_default_replay/rootfs/replay_params_dynamic.txt</code>, where each line has the format <code>&lt;param_name&gt; &lt;value&gt; &lt;timestamp&gt;</code>. The timestamp is the time in seconds from the start of the log. For example:</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">EKF2_RNG_NOISE</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0.15</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 23.4</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">EKF2_RNG_NOISE</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0.05</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 56.7</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">EKF2_RNG_DELAY</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4.5</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 30.0</span></span></code></pre></div></li></ul><h3 id="important-notes" tabindex="-1">Important Notes <a class="header-anchor" href="#important-notes" aria-label="Permalink to &quot;Important Notes&quot;">​</a></h3><ul><li>During replay, all dropouts in the log file are reported. These have a negative effect on the replay, so care should be taken to avoid dropouts during recording.</li><li>It is currently only possible to replay in &#39;real-time&#39;: as fast as the recording was done. This is planned to be extended in the future.</li><li>A message that has a timestamp of 0 will be considered invalid and not be replayed.</li></ul><h2 id="ekf2-replay" tabindex="-1">EKF2 Replay <a class="header-anchor" href="#ekf2-replay" aria-label="Permalink to &quot;EKF2 Replay&quot;">​</a></h2><p>This is a specialization of the system-wide replay for fast EKF2 replay.</p><div class="info custom-block"><p class="custom-block-title">INFO</p><p>The recording and replay of flight logs with <a href="./../advanced_config/tuning_the_ecl_ekf.html#running-multiple-ekf-instances">multiple EKF instances</a> is not supported. To enable recording for EKF replay you must set the parameters to enable a <a href="./../advanced_config/tuning_the_ecl_ekf.html#running-a-single-ekf-instance">single EKF instance</a>.</p></div><p>In EKF2 mode, the replay will automatically create the ORB publisher rules described above.</p><p>To perform an EKF2 replay:</p><ul><li><p>Record the original log. Optionally set <code>SDLOG_MODE</code> to <code>1</code> to log from boot.</p></li><li><p>In addition to the <code>replay</code> environment variable, set <code>replay_mode</code> to <code>ekf2</code>:</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> replay_mode</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">ekf2</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">export</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> replay</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=&lt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">absolute_path_to_log.ulg</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span></span></code></pre></div></li><li><p>Run the replay with the <code>none</code> target:</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">make</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> px4_sitl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> none</span></span></code></pre></div></li><li><p>Once finished, unset both <code>replay</code> and <code>replay_mode</code>.</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">unset</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> replay</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">; </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">unset</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> replay_mode</span></span></code></pre></div></li></ul><h3 id="adjusting-ekf2-specific-parameters-for-the-replay" tabindex="-1">Adjusting EKF2-specific Parameters for the Replay <a class="header-anchor" href="#adjusting-ekf2-specific-parameters-for-the-replay" aria-label="Permalink to &quot;Adjusting EKF2-specific Parameters for the Replay&quot;">​</a></h3><p>First install <code>pyulog</code>:</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pip</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --user</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> pyulog</span></span></code></pre></div><p>Extract the original log&#39;s parameters to <code>replay_params.txt</code>:</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ulog_params</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -i</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">$replay</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -d</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39; &#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> |</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> grep</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -e</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &#39;^EKF2&#39;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> build/px4_sitl_default_replay/rootfs/replay_params.txt</span></span></code></pre></div><p>Adjust these as desired, and add dynamic parameter overrides in <code>replay_params_dynamic.txt</code> if necessary.</p><h2 id="behind-the-scenes" tabindex="-1">Behind the Scenes <a class="header-anchor" href="#behind-the-scenes" aria-label="Permalink to &quot;Behind the Scenes&quot;">​</a></h2><p>Replay is split into 3 components:</p><ul><li>A replay module These have a negative effect on replay, so care should be taken to avoid dropouts during recording.</li><li>It is currently only possible to replay in &#39;real-time&#39;: as fast as the recording was done.</li></ul><p>The replay module reads the log and publishes the messages at the same speed as they were recorded. A constant offset is added to the timestamp of each message to match the current system time (this is the reason why all other timestamps need to be relative). The command <code>replay tryapplyparams</code> is executed before all other modules are loaded and applies the parameters from the log and user-set parameters. Then as the last command, <code>replay trystart</code> will again apply the parameters and start the actual replay. Both commands do nothing if the environment variable <code>replay</code> is not set.</p><p>The ORB publisher rules allow to select which part of the system is replayed, as described above. They are only compiled for the posix SITL targets.</p><p>The <strong>time handling</strong> is still an <strong>open point</strong>, and needs to be implemented.</p>`,33)]))}const g=s(l,[["render",n]]);export{k as __pageData,g as default};
