import{_ as i,c as t,a8 as e,o as a}from"./chunks/framework.BDnHobkS.js";const c=JSON.parse('{"title":"Модульні Тести","description":"","frontmatter":{},"headers":[],"relativePath":"uk/test_and_ci/unit_tests.md","filePath":"uk/test_and_ci/unit_tests.md"}'),n={name:"uk/test_and_ci/unit_tests.md"};function l(p,s,h,o,r,d){return a(),t("div",null,s[0]||(s[0]=[e(`<h1 id="модульні-тести" tabindex="-1">Модульні Тести <a class="header-anchor" href="#модульні-тести" aria-label="Permalink to &quot;Модульні Тести&quot;">​</a></h1><p>Розробникам рекомендується писати модульні тести на всіх етапах розробки, включаючи додавання нових функцій, виправлення помилок і рефакторинг</p><p>PX4 надає декілька методів для написання юніт тестів:</p><ol><li>Unit tests with <a href="https://github.com/google/googletest/blob/main/docs/primer.md" target="_blank" rel="noreferrer">Google Test</a> (&quot;GTest&quot;) - tests that have minimal, internal-only dependencies</li><li>Функціональні тести з GTest - тести, які залежать від параметрів та uORB повідомлень</li><li>Модульні тести SITL. Це і є тести, які повинні запускатися в повному SITL. Ці тести виконуються набагато повільніше та важче налагодити, тому, якщо можливо, замість них рекомендується використовувати GTest.</li></ol><h2 id="написання-gtest-unit-test" tabindex="-1">Написання GTest Unit Test <a class="header-anchor" href="#написання-gtest-unit-test" aria-label="Permalink to &quot;Написання GTest Unit Test&quot;">​</a></h2><p><strong>Tip</strong>: In general, if you need access to advanced GTest utilities, data structures from the STL or need to link to <code>parameters</code> or <code>uorb</code> libraries you should use the functional tests instead.</p><p>Кроки для створення нових функціональних тестів такі:</p><ol><li>Модульні тести мають бути організовані в три секції: налаштування, запуск, перевірка результатів. Кожен тест повинен перевіряти одну дуже конкретну поведінку або випадок налаштування, тому, якщо тест провалиться, стане очевидним, що не так. Будь ласка, намагайтеся дотримуватися цих стандартів, коли це можливо.</li><li>Copy and rename the example unit test <a href="https://github.com/PX4/PX4-Autopilot/blob/main/src/modules/mc_att_control/AttitudeControl/AttitudeControlTest.cpp" target="_blank" rel="noreferrer">AttitudeControlTest</a> to the directory the code to be tested is in.</li><li>Add the new file to the directory&#39;s <code>CMakeLists.txt</code>. It should look something like <code>px4_add_unit_gtest(SRC MyNewUnitTest.cpp LINKLIBS &lt;library_to_be_tested&gt;)</code></li><li>Додайте бажану функцію тестування. Це означатиме включення файлів заголовків, необхідних для ваших конкретних тестів, додавання нових тестів (кожен з індивідуальною назвою) і розміщення логіки для налаштування, запуск коду для перевірки та перевірка його поведінки, як очікувалося.</li><li>If additional library dependencies are required, they should also be added to the CMakeLists after the <code>LINKLIBS</code> as shown above.</li></ol><p>Tests can be run via <code>make tests</code>, after which you will find the binary in <code>build/px4_sitl_test/unit-MyNewUnit</code>. Він може бути запущений безпосередньо в налагоджувачі.</p><h2 id="написання-gtest-functional-test" tabindex="-1">Написання GTest Functional Test <a class="header-anchor" href="#написання-gtest-functional-test" aria-label="Permalink to &quot;Написання GTest Functional Test&quot;">​</a></h2><p>Функціональні тести GTest слід використовувати, коли тест або компоненти, що тестуються, залежать від параметрів, повідомлень uORB та/або розширеної функціональності GTest. Крім того, функціональні тести можуть містити локальне використання структур даних STL (хоча і будьте обережні відмінності платформ між такими як macOS і Linux).</p><p>Кроки для створення нових функціональних тестів такі:</p><ol><li>Загалом (і подібно до модульних тестів), функціональні тести мають бути організовані за трьома розділами: налаштування, запуск, перевірка результатів. Кожен тест повинен перевіряти одну дуже конкретну поведінку або випадок налаштування, тому, якщо тест провалиться, стане очевидним, що не так. Будь ласка, намагайтеся дотримуватися цих стандартів, коли це можливо.</li><li>Copy and rename the example functional test <a href="https://github.com/PX4/PX4-Autopilot/blob/main/src/lib/parameters/ParameterTest.cpp" target="_blank" rel="noreferrer">ParameterTest</a> to the directory the code to be tested is in.</li><li>Перейменуйте клас з ParameterTest на те, що краще представляє код, що тестується</li><li>Add the new file to the directory&#39;s <code>CMakeLists.txt</code>. It should look something like <code>px4_add_functional_gtest(SRC MyNewFunctionalTest.cpp LINKLIBS &lt;library_to_be_tested&gt;)</code></li><li>Додайте бажану функцію тестування. Це означатиме включення файлів заголовків, необхідних для ваших конкретних тестів, додавання нових тестів (кожен з індивідуальною назвою) і розміщення логіки для налаштування тесту, запуск коду, який потрібно перевірити, і перевірку його поведінки, як очікувалося.</li><li>If additional library dependencies are required, they should also be added to the CMakeLists after the <code>LINKLIBS</code> as shown above.</li></ol><p>Tests can be run via <code>make tests</code>, after which you will find the binary in <code>build/px4_sitl_test/functional-MyNewFunctional</code>. It can be run directly in a debugger, however be careful to only run one test per executable invocation using the <a href="https://github.com/google/googletest/blob/main/docs/advanced.md#running-a-subset-of-the-tests" target="_blank" rel="noreferrer">--gtest_filter=&lt;regex&gt;</a> arguments, as some parts of the uORB and parameter libraries don&#39;t clean themselves up perfectly and may result in undefined behavior if set up multiple times.</p><h2 id="написання-sitl-unit-test" tabindex="-1">Написання SITL Unit Test <a class="header-anchor" href="#написання-sitl-unit-test" aria-label="Permalink to &quot;Написання SITL Unit Test&quot;">​</a></h2><p>Модульні тести SITL слід використовувати, коли вам конкретно потрібні всі компоненти контролера польоту – водії, час тощо. Ці тести виконуються повільніше (1 с+ для кожного нового модуля) і їх важче налагодити, тому їх слід використовувати лише за необхідності.</p><p>Кроки для створення нових модульних тестів SITL такі:</p><ol><li><p>Examine the sample <a href="https://github.com/PX4/PX4-Autopilot/blob/main/src/include/unit_test.h" target="_blank" rel="noreferrer">Unittest-class</a>.</p></li><li><p>Create a new .cpp file within <a href="https://github.com/PX4/PX4-Autopilot/tree/main/src/systemcmds/tests" target="_blank" rel="noreferrer">tests</a> with name <strong>test_[description].cpp</strong>.</p></li><li><p>Within <strong>test_[description].cpp</strong> include the base unittest-class <code>&lt;unit_test.h&gt;</code> and all files required to write a test for the new feature.</p></li><li><p>Within <strong>test_[description].cpp</strong> create a class <code>[Description]Test</code> that inherits from <code>UnitTest</code>.</p></li><li><p>Within <code>[Description]Test</code> class declare the public method <code>virtual bool run_tests()</code>.</p></li><li><p>Within <code>[Description]Test</code> class declare all private methods required to test the feature in question (<code>test1()</code>, <code>test2()</code>,...).</p></li><li><p>Within <strong>test_[description].cpp</strong> implement the <code>run_tests()</code> method where each test[1,2,...] will be run.</p></li><li><p>Within <strong>test_[description].cpp</strong>, implement the various tests.</p></li><li><p>At the bottom within <strong>test_[description].cpp</strong> declare the test.</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ut_declare_test_c</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(test_[description], [</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">Description</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]Test)</span></span></code></pre></div><p>Тут є шаблон:</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#include</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &lt;unit_test.h&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#include</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;[new feature].h&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [Description]Test : public UnitTest</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    virtual</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> bool</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> run_tests</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">private:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    bool</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> test1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    bool</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> test2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">bool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [Description]</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Test</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">run_tests</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    ut_run_test</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(test1)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    ut_run_test</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(test2)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (_tests_failed </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">bool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [Description]</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Test</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">test1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ut_[name of one of the unit test functions](...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ut_[name of one of the unit test functions](...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">bool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [Description]</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Test</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">test2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ut_[name of one of the unit test functions](...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ut_[name of one of the unit test functions](...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ut_declare_test_c</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(test_[description], [</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">Description</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]Test)</span></span></code></pre></div><p>Note that <code>ut_[name of one of the unit test functions]</code> corresponds to one of the unittest functions defined within <a href="https://github.com/PX4/PX4-Autopilot/blob/main/src/include/unit_test.h" target="_blank" rel="noreferrer">unit_test.h</a>.</p></li><li><p>Within <a href="https://github.com/PX4/PX4-Autopilot/blob/main/src/systemcmds/tests/tests_main.h" target="_blank" rel="noreferrer">tests_main.h</a> define the new test:</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">extern</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> test_[description](</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> argc, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">char</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">argv[]);</span></span></code></pre></div></li><li><p>Within <a href="https://github.com/PX4/PX4-Autopilot/blob/main/src/systemcmds/tests/tests_main.c" target="_blank" rel="noreferrer">tests_main.c</a> add description name, test function and option:</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">} tests[] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;[description]&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, test_[description], OPTION},</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><code>OPTION</code> can be <code>OPT_NOALLTEST</code>,<code>OPT_NOJIGTEST</code> or <code>0</code> and is considered if within px4 shell one of the two commands are called:</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pxh</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">tests</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> all</span></span></code></pre></div><p>або</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pxh</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">tests</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> jig</span></span></code></pre></div><p>If a test has option <code>OPT_NOALLTEST</code>, then that test will be excluded when calling <code>tests all</code>. The same is true for <code>OPT_NOJITEST</code> when command <code>test jig</code> is called. Option <code>0</code> means that the test is never excluded, which is what most developer want to use.</p></li><li><p>Add the test <code>test_[description].cpp</code> to the <a href="https://github.com/PX4/PX4-Autopilot/blob/main/src/systemcmds/tests/CMakeLists.txt" target="_blank" rel="noreferrer">CMakeLists.txt</a>.</p></li></ol><h2 id="тестування-на-локальніи-машині" tabindex="-1">Тестування на локальній машині <a class="header-anchor" href="#тестування-на-локальніи-машині" aria-label="Permalink to &quot;Тестування на локальній машині&quot;">​</a></h2><p>Запустіть повний список модульних тестів GTest, функціональних тестів GTest і модульних тестів SITL прямо з bash:</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">make</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tests</span></span></code></pre></div><p>The individual GTest test binaries are in the <code>build/px4_sitl_test/</code> directory, and can be run directly in most IDEs&#39; debugger.</p><p>Фільтр, щоб запустити лише підмножину тестів, використовуючи регулярний вираз для імені ctest за допомогою цієї команди:</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">make</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tests</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> TESTFILTER=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">regex</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> filter</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> expressio</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">n</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span></span></code></pre></div><p>Наприклад:</p><ul><li><code>make tests TESTFILTER=unit</code> only run GTest unit tests</li><li><code>make tests TESTFILTER=sitl</code> only run simulation tests</li><li><code>make tests TESTFILTER=Attitude</code> only run the <code>AttitudeControl</code> test</li></ul>`,26)]))}const E=i(n,[["render",l]]);export{c as __pageData,E as default};
