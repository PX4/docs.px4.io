import{_ as a}from"./chunks/autotune.EOQH3DT_.js";import{_ as i,c as n,o,ab as t,m as e}from"./chunks/framework.CUflZczI.js";const y=JSON.parse('{"title":"Auto-tuning","description":"","frontmatter":{},"headers":[],"relativePath":"en/config/autotune.md","filePath":"en/config/autotune.md"}'),l={name:"en/config/autotune.md"},r=t('<h1 id="auto-tuning" tabindex="-1">Auto-tuning <a class="header-anchor" href="#auto-tuning" aria-label="Permalink to &quot;Auto-tuning&quot;">​</a></h1><p>Auto-tuning automates the process of tuning the PX4 rate and attitude controllers, which are the most important controllers for stable and responsive flight (other tuning is more &quot;optional&quot;). It is currently enabled for multicopter, fixed-wing, and hybrid VTOL fixed-wing vehicles.</p><p>Tuning only needs to be done once, and is recommended unless you&#39;re using a vehicle that has already been tuned by the manufacturer (and not modified since).</p><div class="warning custom-block"><p class="custom-block-title">WARNING</p><p>Auto-tuning is performed while flying. The airframe must fly well enough to handle moderate disturbances, and should be closely attended:</p><ul><li>Test that your vehicle is <a href="#pre-tuning-test">stable enough for autotuning</a>.</li><li>Be ready to abort the autotuning process. You can do this by changing flight modes or using an auto-tune enable/disable switch (<a href="#enable-disable-autotune-switch-fixed-wing">if configured</a>).</li><li>Verify that the vehicle flies well after tuning.</li></ul></div>',4),s=e("p",null,[e("div",{class:"embed-responsive embed-responsive-16by9"},[e("iframe",{class:"embed-responsive-item youtube-player",type:"text/html",width:"640",height:"390",src:"https://www.youtube.com/embed/5xswOhhqrIQ",frameborder:"0",webkitallowfullscreen:"",mozallowfullscreen:"",allowfullscreen:""})])],-1),h=t('<h2 id="pre-tuning-test" tabindex="-1">Pre-tuning Test <a class="header-anchor" href="#pre-tuning-test" aria-label="Permalink to &quot;Pre-tuning Test&quot;">​</a></h2><p>The vehicle must be able to fly and adequately stabilize itself before running auto-tune. This test ensures that the vehicle can fly safely in position controlled modes.</p><div class="info custom-block"><p class="custom-block-title">INFO</p><p>During <a href="./../config/airframe.html">Airframe Setup</a> you should have selected the frame that most closely matches your vehicle. This may fly well enough to run autotuning.</p></div><p>To make sure the vehicle is stable enough for auto-tuning:</p><ol><li>Perform a normal preflight safety checklist to ensure the flight zone is clear and has enough space.</li><li>Takeoff and prepare for the test <ul><li><strong>Multicopters:</strong> Take off and hover at 1m above ground in <a href="./../flight_modes_mc/altitude.html">Altitude mode</a> or Stabilized mode.</li><li><strong>Fixed-wing:</strong> Take off and fly at cruise speed in <a href="./../flight_modes_mc/position.html">Position mode</a> or <a href="./../flight_modes_mc/altitude.html">Altitude mode</a>.</li></ul></li><li>Use the RC transmitter roll stick to perform the following maneuver, tilting the vehicle just a few degrees: <em>roll left &gt; roll right &gt; center</em> (The whole maneuver should take about 3 seconds). The vehicle should stabilise itself within 2 oscillations.</li><li>Repeat the maneuver, tilting with larger amplitudes at each attempt. If the vehicle can stabilise itself within 2 oscillations at ~20 degrees move to the next step.</li><li>Repeat the same maneuvers but on the pitch axis. As above, start with small angles and confirm that the vehicle can stabilise itself within 2 oscillations before increasing the tilt.</li></ol><p>If the drone can stabilize itself within 2 oscillations it is ready for the auto-tuning procedure.</p><p>If not, go to the <a href="#troubleshooting">troubleshooting</a> section, which explains the minimal manual tuning to prepare the vehicle for auto-tuning.</p><h3 id="auto-tuning-procedure" tabindex="-1">Auto-tuning Procedure <a class="header-anchor" href="#auto-tuning-procedure" aria-label="Permalink to &quot;Auto-tuning Procedure&quot;">​</a></h3><p>The auto-tuning sequence must be performed in a <strong>safe flight zone, with enough space</strong>. It takes about 40 seconds (<a href="#how-long-does-autotuning-take">between 19 and 68 seconds</a>). For best results, we recommend running the test in calm weather conditions.</p><p>The recommended modes for autotuning are <a href="./../flight_modes_fw/hold.html">Hold mode</a> (FW) and <a href="./../flight_modes_mc/altitude.html">Altitude mode</a> (MC), but any other flight mode can be used. During auto tuning, the RC sticks can still be used to fly the vehicle.</p><div class="info custom-block"><p class="custom-block-title">INFO</p><p>The auto-tuning sequence can be aborted at any time by changing flight modes or using the <a href="#enable-disable-autotune-switch-fixed-wing">enable/disable Autotune switch</a> (if configured).</p></div><p>The test steps are:</p><ol><li><p>Perform the <a href="#pre-tuning-test">pre-tuning test</a>.</p></li><li><p>Takeoff using RC control and prepare for test:</p><ul><li><strong>Multicopters:</strong> Takeoff using the remote controller in <a href="./../flight_modes_mc/altitude.html">Altitude mode</a>. Hover the vehicle at a safe distance and at a few meters above ground (between 4 and 20m).</li><li><strong>Fixed-wing:</strong> Once flying at cruise speed, activate <a href="./../flight_modes_mc/hold.html">Hold mode</a>. This will guide the plane to fly in circle at constant altitude and speed.</li></ul></li><li><p>Enable autotune.</p><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>If an <a href="#enable-disable-autotune-switch-fixed-wing">Enable/Disable Autotune Switch</a> is configured you can just toggle the switch to the &quot;enabled&quot; position.</p></div><ol><li><p>In QGroundControl, open the menu: <strong>Vehicle setup &gt; PID Tuning</strong></p><p><img src="'+a+'" alt="Tuning Setup &gt; Autotune Enabled"></p></li><li><p>Select either the <em>Rate Controller</em> or <em>Attitude Controller</em> tabs.</p></li><li><p>Ensure that the <strong>Autotune enabled</strong> button is enabled (this will display the <strong>Autotune</strong> button and remove the manual tuning selectors).</p></li><li><p>Read the warning popup and click on <strong>OK</strong> to start tuning.</p></li></ol></li><li><p>The drone will first start to perform quick roll motions followed by pitch and yaw motions. The progress is shown in the progress bar, next to the <em>Autotune</em> button.</p></li><li><p>Apply the tuning:</p><ul><li><strong>Fixed-Wing:</strong> The tuning will be immediately/automatically be applied and tested in flight (by default). PX4 will then run a 4 second test and revert the new tuning if a problem is detected.</li><li><strong>Multicopters:</strong> Manually land and disarm to apply the new tuning parameters. Takeoff carefully and manually test that the vehicle is stable.</li></ul></li><li><p>If any strong oscillations occur, land immediately and follow the instructions in the <a href="#troubleshooting">Troubleshooting</a> section below.</p></li></ol><p>Additional notes:</p><ul><li><strong>VTOL:</strong> Hybrid VTOL fixed-wing vehicles must be tuned twice, following multicopter instructions in MC mode and fixed-wing instructions in FW mode.</li><li><strong>Multicopter:</strong> The instructions above tune the vehicle in <a href="./../flight_modes_mc/altitude.html">Altitude mode</a>. You can instead takeoff in <a href="./../flight_modes_mc/takeoff.html">Takeoff mode</a> and tune in <a href="./../flight_modes_mc/position.html">Position mode</a> if the vehicle is is <em>known</em> to be stable in these modes.</li><li><strong>Fixed-wing:</strong> Autotuning can also be run in <a href="./../flight_modes_fw/altitude.html">Altitude mode</a> or <a href="./../flight_modes_fw/position.html">Position mode</a>. However running the test while flying straight requires a larger safe area for tuning, and does not give a significantly better tuning result.</li><li>Whether tuning is applied in-air or after landing can be <a href="#apply-parameters-when-in-air-landed">configured using parameters</a>.</li></ul><h2 id="troubleshooting" tabindex="-1">Troubleshooting <a class="header-anchor" href="#troubleshooting" aria-label="Permalink to &quot;Troubleshooting&quot;">​</a></h2><h4 id="the-drone-oscillates-when-performing-the-testing-maneuvers-prior-to-the-auto-tuning" tabindex="-1">The drone oscillates when performing the testing maneuvers prior to the auto-tuning <a class="header-anchor" href="#the-drone-oscillates-when-performing-the-testing-maneuvers-prior-to-the-auto-tuning" aria-label="Permalink to &quot;The drone oscillates when performing the testing maneuvers prior to the auto-tuning&quot;">​</a></h4><ul><li>slow oscillations (1 oscillation per second or slower): this often occurs on large platforms and means that the attitude loop is too fast compared to the rate loop. <ul><li><strong>Multicopter:</strong> decrease <a href="./../advanced_config/parameter_reference.html#MC_ROLL_P">MC_ROLL_P</a> and <a href="./../advanced_config/parameter_reference.html#MC_PITCH_P">MC_PITCH_P</a> by steps of 1.0.</li><li><strong>Fixed-wing:</strong> increase <a href="./../advanced_config/parameter_reference.html#FW_R_TC">FW_R_TC</a> and <a href="./../advanced_config/parameter_reference.html#FW_P_TC">FW_P_TC</a> by steps of 0.1.</li></ul></li><li>fast oscillations (more than 1 oscillation per second): this is because the gain of the rate loop is too high. <ul><li><strong>Multicopter:</strong> decrease <code>MC_[ROLL|PITCH|YAW]RATE_K</code> by steps of 0.02</li><li><strong>Fixed-wing:</strong> decrease <a href="./../advanced_config/parameter_reference.html#FW_RR_P">FW_RR_P</a>, <a href="./../advanced_config/parameter_reference.html#FW_PR_P">FW_PR_P</a>, <a href="./../advanced_config/parameter_reference.html#FW_YR_P">FW_YR_P</a> by steps of 0.01.</li></ul></li></ul><h4 id="the-auto-tuning-sequence-fails" tabindex="-1">The auto-tuning sequence fails <a class="header-anchor" href="#the-auto-tuning-sequence-fails" aria-label="Permalink to &quot;The auto-tuning sequence fails&quot;">​</a></h4><p>If the drone was not moving enough during auto-tuning, the system identification algorithm might have issues to find the correct coefficients. Increase the <a href="./../advanced_config/parameter_reference.html#FW_AT_SYSID_AMP">FW_AT_SYSID_AMP</a>, <a href="./../advanced_config/parameter_reference.html#MC_AT_SYSID_AMP">MC_AT_SYSID_AMP</a> by steps of 1 and trigger the auto-tune again.</p><h4 id="the-drone-oscillates-after-auto-tuning" tabindex="-1">The drone oscillates after auto-tuning <a class="header-anchor" href="#the-drone-oscillates-after-auto-tuning" aria-label="Permalink to &quot;The drone oscillates after auto-tuning&quot;">​</a></h4><p>Due to effects not included in the mathematical model such as delays, saturation, slew-rate, airframe flexibility, the loop gain can be too high. To fix this, follow the same steps described <a href="#the-drone-oscillates-when-performing-the-testing-maneuvers-prior-to-the-auto-tuning">when the drone oscillates in the pre-tuning test</a>.</p><h4 id="i-still-can-t-get-it-to-work" tabindex="-1">I still can&#39;t get it to work <a class="header-anchor" href="#i-still-can-t-get-it-to-work" aria-label="Permalink to &quot;I still can&#39;t get it to work&quot;">​</a></h4><p>Attempt manual tuning using the appropriate guides:</p><ul><li><a href="./../config_mc/pid_tuning_guide_multicopter_basic.html">Multicopter PID Tuning Guide</a> (Manual/Simple)</li><li><a href="./../config_mc/pid_tuning_guide_multicopter.html">Multicopter PID Tuning Guide</a> (Advanced/Detailed)</li><li><a href="./../config_fw/pid_tuning_guide_fixedwing.html">Fixed-Wing PID Tuning Guide</a></li></ul><h2 id="optional-configuration" tabindex="-1">Optional Configuration <a class="header-anchor" href="#optional-configuration" aria-label="Permalink to &quot;Optional Configuration&quot;">​</a></h2><h3 id="apply-parameters-when-in-air-landed" tabindex="-1">Apply Parameters When In-Air/Landed <a class="header-anchor" href="#apply-parameters-when-in-air-landed" aria-label="Permalink to &quot;Apply Parameters When In-Air/Landed&quot;">​</a></h3><p>By default MC vehicles land before parameters are applied, while FW vehicles apply the parameters in-air and then test that the controllers work properly. This behaviour can be configured using the <a href="./../advanced_config/parameter_reference.html#MC_AT_APPLY">MC_AT_APPLY</a> and <a href="./../advanced_config/parameter_reference.html#FW_AT_APPLY">FW_AT_APPLY</a> parameters respectively:</p><ul><li><code>0</code>: the gains are not applied. This is used for testing purposes if the user wants to inspect results of the auto-tuning algorithm without using them directly.</li><li><code>1</code>: apply the gains after disarm (default for multirotors). The operator can then test the new tuning while taking-off carefully.</li><li><code>2</code>: apply immediately (default for fixed-fings). The new tuning is applied, disturbances are sent to the controller and the stability is monitored during the next 4 seconds. If the control loop is unstable, the control gains are immediately reverted back to their previous value. If the test passes, the pilot can then use the new tuning.</li></ul><h3 id="enable-disable-autotune-switch-fixed-wing" tabindex="-1">Enable/Disable Autotune Switch (Fixed-Wing) <a class="header-anchor" href="#enable-disable-autotune-switch-fixed-wing" aria-label="Permalink to &quot;Enable/Disable Autotune Switch (Fixed-Wing)&quot;">​</a></h3><p>A remote control switch can be configured to enable/disable autotune (in any mode) using an RC AUX channel.</p><p>To map a switch:</p><ol><li>Select an RC channel on your controller to use for the autotune enable/disable switch.</li><li>Set <a href="./../advanced_config/parameter_reference.html#RC_MAP_AUX1">RC_MAP_AUX1</a> to match the RC channel for your switch (you can use any of <code>RC_MAP_AUX1</code> to <code>RC_MAP_AUX6</code>).</li><li>Set <a href="./../advanced_config/parameter_reference.html#FW_AT_MAN_AUX">FW_AT_MAN_AUX</a> to the selected channel (i.e. <code>1: Aux 1</code> if you mapped <code>RC_MAP_AUX1</code>).</li></ol><p>The auto tuner will be disabled when the switch is below <code>0.5</code> (on the manual control setpoint range of of <code>[-1, 1]</code> and enabled when the switch channel is above <code>0.5</code>.</p><p>If using an RC AUX switch to enable autotuning, make sure to <a href="#select-tuning-axis-fixed-wing">select the tuning axes</a> before flight.</p><h3 id="select-tuning-axis-fixed-wing" tabindex="-1">Select Tuning Axis (Fixed-Wing) <a class="header-anchor" href="#select-tuning-axis-fixed-wing" aria-label="Permalink to &quot;Select Tuning Axis (Fixed-Wing)&quot;">​</a></h3><p>Fixed-wing vehicles (only) can select which axes are tuned using the <a href="./../advanced_config/parameter_reference.html#FW_AT_AXES">FW_AT_AXES</a> bitmask parameter:</p><ul><li>bit <code>0</code>: roll (default)</li><li>bit <code>1</code>: pitch (default)</li><li>bit <code>2</code>: yaw</li></ul><h2 id="developers-sdks" tabindex="-1">Developers/SDKs <a class="header-anchor" href="#developers-sdks" aria-label="Permalink to &quot;Developers/SDKs&quot;">​</a></h2><p>Autotuning is started using <a href="https://mavlink.io/en/messages/common.html#MAV_CMD_DO_AUTOTUNE_ENABLE" target="_blank" rel="noreferrer">MAV_CMD_DO_AUTOTUNE_ENABLE</a> MAVLink command.</p><p>At time of writing the message is resent at regular intervals to poll PX4 for progress: the <code>COMMAND_ACK</code> includes result that the operation is in progress, and also the progress as a percentage. The operation completes when the progress is 100% or the vehicle lands and disarms.</p><div class="info custom-block"><p class="custom-block-title">INFO</p><p>This is not a MAVLink-compliant implementation of a <a href="https://mavlink.io/en/services/command.html#long_running_commands" target="_blank" rel="noreferrer">command protocol long running command</a>. PX4 should stream progress as the protocol does not allow polling.</p></div><p>The feature is not yet supported by MAVSDK.</p><h2 id="background-detail" tabindex="-1">Background/Detail <a class="header-anchor" href="#background-detail" aria-label="Permalink to &quot;Background/Detail&quot;">​</a></h2><p>PX4 uses <a href="./../flight_stack/controller_diagrams.html">PID controllers</a> (rate, attitude, velocity, and position) to calculate the outputs required to move a vehicle from its current estimated state to match a desired setpoint. The controllers must be well tuned in order to get the best performance out of a vehicle. In particular, a poorly tuned rate controller results in less stable flight in all modes, and takes longer to recover from disturbances.</p><p>Generally if you use a <a href="./../config/airframe.html">frame configuration</a> that is similar to your vehicle then the vehicle will be able to fly. However unless the configuration precisely matches your hardware you should tune the rate and attitude controllers. Tuning the velocity and position controllers is less important because they are less affected by vehicle dynamics, and the default tuning configuration for a similar airframe is often sufficient.</p><p>Autotuning provides an automatic mechanism to tune the rate and attitude controllers. It can be used to tune fixed-wing and multicopter vehicles, and VTOL vehicles when flying as a multicopter or as a fixed-wing (transition between modes must be manually tuned). In theory it should work for other vehicle types that have a rate controller, but currently only the above types are supported.</p><p>Automatic tuning works well for the multicopter and fixed-wing vehicle configurations supported by PX4, provided the frame is not too flexible (see <a href="#does-autotuning-work-for-all-supported-airframes">below for more information</a>).</p><p>The vehicle must be flying in an altitude-stabilized mode (such as <a href="./../flight_modes_mc/altitude.html">Altitude mode</a>, <a href="./../flight_modes_mc/hold.html">Hold mode</a>, or <a href="./../flight_modes_mc/position.html">Position mode</a>). The flight stack will apply a small disturbance to the vehicle in each axis and then attempt to calculate the new tuning parameters. For fixed-wing vehicles the new tuning is applied in-air by default, after which the vehicle tests the new settings and reverts the tuning if the controllers are not stable. For multicopter, the vehicle lands and applies the new tuning parameters after disarming; the pilot is expected to then take off carefully and test the tuning.</p><p>The tuning process takes about 40 seconds (<a href="#how-long-does-autotuning-take">between 19 and 68 seconds</a>). The default behaviour can be configured using <a href="#optional-configuration">parameters</a>.</p><h3 id="faq" tabindex="-1">FAQ <a class="header-anchor" href="#faq" aria-label="Permalink to &quot;FAQ&quot;">​</a></h3><h4 id="what-frames-types-are-supported" tabindex="-1">What frames types are supported? <a class="header-anchor" href="#what-frames-types-are-supported" aria-label="Permalink to &quot;What frames types are supported?&quot;">​</a></h4><p>Autotuning is enabled for multicopter, fixed-wing, and hybrid VTOL fixed-wing vehicles.</p><p>While it is not yet enabled for other frame types, in theory it an be used with any frame that uses a rate controller.</p><h4 id="does-autotuning-work-for-all-supported-airframes" tabindex="-1">Does autotuning work for all supported airframes? <a class="header-anchor" href="#does-autotuning-work-for-all-supported-airframes" aria-label="Permalink to &quot;Does autotuning work for all supported airframes?&quot;">​</a></h4><p>The mathematical model used by autotuning to estimate the dynamics of the drone assumes this it is a linear system with no coupling between the axes (SISO), and with a limited complexity (2 poles and 2 zeros). If the real drone is too far from those conditions, the model will not be able to represent the real dynamics of the drone.</p><p>In practise, autotuning generally works well for fixed-wing and multicopter, provided the frame is not too flexible.</p><h4 id="how-long-does-autotuning-take" tabindex="-1">How long does autotuning take? <a class="header-anchor" href="#how-long-does-autotuning-take" aria-label="Permalink to &quot;How long does autotuning take?&quot;">​</a></h4><p>Tuning takes 5s-20s per axis (aborted if tuning could not be established in 20s) + 2s pause between each axis + 4s of testing if the new gains are applied in air.</p><p>A multicopter must tune all three axes, and by default does not test the new gains in-air. Tuning will therefore take between 19s (<code>5 + 2 + 5 + 2 + 5</code>) and 64s (<code>20x3 + 2x2</code>).</p><p>By default a fixed-wing vehicle tunes all three axes and then tests the new gains in-air. The range is therefore between 25s (<code>5 + 2 + 5 + 2 + 5 + 2 + 4</code>) and 70s (<code>20x3 + 3x2 + 4</code>).</p><p>Note however that the above settings are defaults. A multicopter can choose to run the tests in air, and a fixed-wing can choose not to. Further, a fixed-wing can choose to tune fewer axes.</p><p>Anecdotally, it usually takes around 40s for either vehicle.</p><h2 id="see-also" tabindex="-1">See also <a class="header-anchor" href="#see-also" aria-label="Permalink to &quot;See also&quot;">​</a></h2><ul><li><a href="./../config_mc/pid_tuning_guide_multicopter_basic.html">Multicopter PID Tuning Guide</a> (Manual/Simple)</li><li><a href="./../config_mc/pid_tuning_guide_multicopter.html">Multicopter PID Tuning Guide</a> (Advanced/Detailed)</li><li><a href="./../config_fw/pid_tuning_guide_fixedwing.html">Fixed-Wing PID Tuning Guide</a></li></ul>',65),u=[r,s,h];function d(c,f,p,g,m,b){return o(),n("div",null,u)}const v=i(l,[["render",d]]);export{y as __pageData,v as default};
