import{_ as s}from"./chunks/ekf2_ev_delay_tuning.Bgxz8N1S.js";import{_ as i}from"./chunks/ref_frames.C52lwBbQ.js";import{_ as n,c as o,m as e,a as t,ab as a,o as r}from"./chunks/framework.CUflZczI.js";const y=JSON.parse('{"title":"Використання Vision або Motion Capture систем для Position Estimation","description":"","frontmatter":{},"headers":[],"relativePath":"uk/ros/external_position_estimation.md","filePath":"uk/ros/external_position_estimation.md"}'),l={name:"uk/ros/external_position_estimation.md"},d=a('<h1 id="використання-vision-або-motion-capture-систем-для-position-estimation" tabindex="-1">Використання Vision або Motion Capture систем для Position Estimation <a class="header-anchor" href="#використання-vision-або-motion-capture-систем-для-position-estimation" aria-label="Permalink to &quot;Використання Vision або Motion Capture систем для Position Estimation&quot;">​</a></h1><p>Системи візуальної інерційної одометрії (VIO) та захоплення руху (MoCap) дозволяють транспортним засобам здійснювати навігацію, коли джерело глобального позиціонування недоступне або ненадійне (наприклад, в приміщенні або під час прольоту під мостом. тощо).</p><p>І VIO, і MoCap визначають <em>положення</em> (положення і позицію) транспортного засобу на основі &quot;візуальної&quot; інформації. Основна відмінність між ними - перспектива кадру:</p><ul><li>VIO використовує <em>бортові датчики</em> для отримання даних про позу з точки зору транспортного засобу (див. <a href="https://en.wikipedia.org/wiki/Visual_odometry#Egomotion" target="_blank" rel="noreferrer">egomotion</a>).</li><li>MoCap використовує систему <em>зовнішніх камер</em> для отримання даних про положення транспортного засобу в 3D-просторі (тобто це зовнішня система, яка повідомляє транспортному засобу його положення).</li></ul><p>Дані про положення, отримані від обох типів систем, можуть бути використані для оновлення оцінки локального положення автопілота на базі PX4 (відносно локальної точки відліку), а також, за бажанням, можуть бути інтегровані в оцінку положення транспортного засобу. Крім того, якщо зовнішня система позиціонування також забезпечує вимірювання лінійної швидкості, її можна використовувати для покращення оцінки стану (об&#39;єднання вимірювань лінійної швидкості підтримується лише EKF2).</p><p>У цій темі пояснюється, як налаштувати систему на базі PX4 для отримання даних від систем MoCap/VIO (або через ROS, або через іншу систему MAVLink) і, зокрема, як налаштувати системи MoCap, такі як VICON і Optitrack, і системи оцінки на основі комп&#39;ютерного зору, такі як <a href="https://github.com/ethz-asl/rovio" target="_blank" rel="noreferrer">ROVIO</a>, <a href="https://github.com/uzh-rpg/rpg_svo" target="_blank" rel="noreferrer">SVO</a> та <a href="https://github.com/ethz-asl/ethzasl_ptam" target="_blank" rel="noreferrer">PTAM</a>).</p><div class="info custom-block"><p class="custom-block-title">INFO</p><p>Інструкції відрізняються залежно від того, чи використовуєте ви оцінювач EKF2 або LPE.</p></div><h2 id="інтеграція-px4-з-mavlink" tabindex="-1">Інтеграція PX4 з MAVLink <a class="header-anchor" href="#інтеграція-px4-з-mavlink" aria-label="Permalink to &quot;Інтеграція PX4 з MAVLink&quot;">​</a></h2><p>PX4 використовує наступні повідомлення MAVLink для отримання інформації про зовнішню позицію і зіставляє їх з темами <a href="./../middleware/uorb.html">uORB</a>:</p><table><thead><tr><th>MAVLink</th><th>uORB</th></tr></thead><tbody><tr><td><a href="https://mavlink.io/en/messages/common.html#VISION_POSITION_ESTIMATE" target="_blank" rel="noreferrer">VISION_POSITION_ESTIMATE</a></td><td><code>vehicle_visual_odometry</code></td></tr><tr><td><a href="https://mavlink.io/en/messages/common.html#ODOMETRY" target="_blank" rel="noreferrer">ODOMETRY</a> (<code>frame_id =</code> <a href="https://mavlink.io/en/messages/common.html#MAV_FRAME_LOCAL_FRD" target="_blank" rel="noreferrer">MAV_FRAME_LOCAL_FRD</a>)</td><td><code>vehicle_visual_odometry</code></td></tr><tr><td><a href="https://mavlink.io/en/messages/common.html#ATT_POS_MOCAP" target="_blank" rel="noreferrer">ATT_POS_MOCAP</a></td><td><code>vehicle_mocap_odometry</code></td></tr><tr><td><a href="https://mavlink.io/en/messages/common.html#ODOMETRY" target="_blank" rel="noreferrer">ODOMETRY</a> (<code>frame_id =</code> <a href="https://mavlink.io/en/messages/common.html#MAV_FRAME_MOCAP_NED" target="_blank" rel="noreferrer">MAV_FRAME_MOCAP_NED</a>)</td><td><code>vehicle_mocap_odometry</code></td></tr></tbody></table><p>EKF2 підписується лише на теми <code>vehicle_visual_odometry</code> і тому може обробляти лише перші дві повідомлення (система MoCap повинна генерувати ці повідомлення для роботи з EKF2). Повідомлення odometry є єдиним повідомленням, яке може також відправляти лінійні швидкості в PX4. Оцінювач LPE підписується на обидві теми, тому може обробляти всі вищезазначені повідомлення.</p><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>EKF2 - це типовий оцінювач, який використовується PX4. Він краще протестований і підтримується, ніж LPE, і його слід використовувати за умовчанням.</p></div><p>Повідомлення повинні транслюватися з частотою між 30 Гц (якщо містять коваріанти) і 50 Гц. Якщо частота повідомлень занадто низька, EKF2 не буде обробляти повідомлення з зовнішнього візуального спостереження.</p><p>Наступні повідомлення &quot;візій&quot; MAVLink наразі не підтримуються PX4: <a href="https://mavlink.io/en/messages/common.html#GLOBAL_VISION_POSITION_ESTIMATE" target="_blank" rel="noreferrer">GLOBAL_VISION_POSITION_ESTIMATE</a>, <a href="https://mavlink.io/en/messages/common.html#VISION_SPEED_ESTIMATE" target="_blank" rel="noreferrer">VISION_SPEED_ESTIMATE</a>, <a href="https://mavlink.io/en/messages/common.html#VICON_POSITION_ESTIMATE" target="_blank" rel="noreferrer">VICON_POSITION_ESTIMATE</a></p><h2 id="основні-відмінності" tabindex="-1">Основні відмінності <a class="header-anchor" href="#основні-відмінності" aria-label="Permalink to &quot;Основні відмінності&quot;">​</a></h2><p>PX4 використовує FRD (<strong>X</strong> вперед, <strong>Y</strong> праворуч і <strong>Z</strong> донизу) для локального тілесного каркасу, а також для опорного каркасу. Коли використовується напрямок магнітометра, вісь x опорного каркасу PX4 буде вирівнена з північним напрямком, тому вона називається NED (<strong>X</strong> північ, <strong>Y</strong> схід, <strong>Z</strong> донизу). Напрямок опорного каркасу оцінювача PX4 та напрямок зовнішньої оцінки положення в більшості випадків не збігаються. Тому напрямок опорного каркасу зовнішньої оцінки положення має різну назву - він називається <a href="https://mavlink.io/en/messages/common.html#MAV_FRAME_LOCAL_FRD" target="_blank" rel="noreferrer">MAV_FRAME_LOCAL_FRD</a>.</p><p>Залежно від джерела вашого опорного каркасу, вам потрібно буде застосувати власне перетворення до оцінки положення перед надсиланням повідомлення MAVLink Vision/MoCap. Це необхідно для зміни орієнтації батьківського та дочірнього каркасу оцінки положення так, щоб вона відповідала конвенції PX4. Подивіться на плагін оцінювання MAVROS <a href="https://github.com/mavlink/mavros/blob/master/mavros_extras/src/plugins/odom.cpp" target="_blank" rel="noreferrer"><em>odom</em></a>для необхідних перетворень.</p><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>Користувачі ROS можуть знайти більш детальні інструкції нижче в розділі <a href="#reference-frames-and-ros">Основні відмінності та ROS</a>.</p></div>',18),c={class:"MathJax",jax:"SVG",style:{direction:"ltr",position:"relative"}},m={style:{overflow:"visible","min-height":"1px","min-width":"1px","vertical-align":"-0.025ex"},xmlns:"http://www.w3.org/2000/svg",width:"1.294ex",height:"1.025ex",role:"img",focusable:"false",viewBox:"0 -442 572 453","aria-hidden":"true"},p=a('<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D465" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z" style="stroke-width:3;"></path></g><g data-mml-node="TeXAtom" data-mjx-texclass="ORD" transform="translate(572,0)"></g></g></g>',1),_=[p],h=e("mjx-assistive-mml",{unselectable:"on",display:"inline",style:{top:"0px",left:"0px",clip:"rect(1px, 1px, 1px, 1px)","-webkit-touch-callout":"none","-webkit-user-select":"none","-khtml-user-select":"none","-moz-user-select":"none","-ms-user-select":"none","user-select":"none",position:"absolute",padding:"1px 0px 0px 0px",border:"0px",display:"block",width:"auto",overflow:"hidden"}},[e("math",{xmlns:"http://www.w3.org/1998/Math/MathML"},[e("mi",null,"x"),e("mrow",{"data-mjx-texclass":"ORD"})])],-1),g={class:"MathJax",jax:"SVG",style:{direction:"ltr",position:"relative"}},f={style:{overflow:"visible","min-height":"1px","min-width":"1px","vertical-align":"-0.025ex"},xmlns:"http://www.w3.org/2000/svg",width:"1.052ex",height:"1.025ex",role:"img",focusable:"false",viewBox:"0 -442 465 453","aria-hidden":"true"},u=a('<g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D467" d="M347 338Q337 338 294 349T231 360Q211 360 197 356T174 346T162 335T155 324L153 320Q150 317 138 317Q117 317 117 325Q117 330 120 339Q133 378 163 406T229 440Q241 442 246 442Q271 442 291 425T329 392T367 375Q389 375 411 408T434 441Q435 442 449 442H462Q468 436 468 434Q468 430 463 420T449 399T432 377T418 358L411 349Q368 298 275 214T160 106L148 94L163 93Q185 93 227 82T290 71Q328 71 360 90T402 140Q406 149 409 151T424 153Q443 153 443 143Q443 138 442 134Q425 72 376 31T278 -11Q252 -11 232 6T193 40T155 57Q111 57 76 -3Q70 -11 59 -11H54H41Q35 -5 35 -2Q35 13 93 84Q132 129 225 214T340 322Q352 338 347 338Z" style="stroke-width:3;"></path></g><g data-mml-node="TeXAtom" data-mjx-texclass="ORD" transform="translate(465,0)"></g></g></g>',1),k=[u],E=e("mjx-assistive-mml",{unselectable:"on",display:"inline",style:{top:"0px",left:"0px",clip:"rect(1px, 1px, 1px, 1px)","-webkit-touch-callout":"none","-webkit-user-select":"none","-khtml-user-select":"none","-moz-user-select":"none","-ms-user-select":"none","user-select":"none",position:"absolute",padding:"1px 0px 0px 0px",border:"0px",display:"block",width:"auto",overflow:"hidden"}},[e("math",{xmlns:"http://www.w3.org/1998/Math/MathML"},[e("mi",null,"z"),e("mrow",{"data-mjx-texclass":"ORD"})])],-1),b=e("em",null,"x",-1),v=e("em",null,"z",-1),O=e("em",null,"y",-1),P=a(`<p>Якщо <code>x_{mav}</code>, <code>y_{mav}</code> і <code>z_{mav}</code> - це координати, які надсилаються через MAVLink як зворотний зв&#39;язок з позицією, тоді ми отримуємо:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>x_{mav} = x_{mocap}</span></span>
<span class="line"><span>y_{mav} = z_{mocap}</span></span>
<span class="line"><span>z_{mav} = - y_{mocap}</span></span></code></pre></div><p>Щодо орієнтації, залишайте частину скаляра <em>w</em> кватерніону такою самою і обмінюйте частину вектора <em>x</em>, <em>y</em> та <em>z</em> так само. Ви можете застосувати цей трюк у будь-якій системі - якщо вам потрібно отримати рамку NED, подивіться на вивід вашого MoCap та обміняйте вісі відповідно.</p><h2 id="конфігурація-та-налаштування-ekf2" tabindex="-1">Конфігурація та налаштування EKF2 <a class="header-anchor" href="#конфігурація-та-налаштування-ekf2" aria-label="Permalink to &quot;Конфігурація та налаштування EKF2&quot;">​</a></h2><p>Примітка: це короткий огляд. Для отримання більш детальної інформації перегляньте <a href="./../advanced_config/tuning_the_ecl_ekf.html">посібник з налаштування EKF2</a></p><p>Наступні параметри повинні бути встановлені для використання зовнішньої інформації про положення з EKF2 (їх можна встановити в <em>QGroundControl</em> &gt; <strong>Налаштування транспортного засобу &gt; Параметри &gt; EKF2</strong>).</p><table><thead><tr><th>Параметр</th><th>Налаштування для Зовнішньої Оцінки Положення</th></tr></thead><tbody><tr><td><a href="./../advanced_config/parameter_reference.html#EKF2_EV_CTRL">EKF2_EV_CTRL</a></td><td>Встановіть <em>злиття горизонтального положення</em>, <em>вертикального положення</em> за допомогою візій, <em>злиття швидкості</em> та <em>злиття курсу</em> відповідно до вашої бажаної моделі злиття.</td></tr><tr><td><a href="./../advanced_config/parameter_reference.html#EKF2_HGT_REF">EKF2_HGT_REF</a></td><td>Встановіть на <em>Vision</em> для використання візії як джерела посилання для оцінки висоти.</td></tr><tr><td><a href="./../advanced_config/parameter_reference.html#EKF2_EV_DELAY">EKF2_EV_DELAY</a></td><td>Встановіть різницю між міткою часу вимірювання та &quot;фактичним&quot; часом захоплення. Для отримання більш детальної інформації див. <a href="#tuning-EKF2_EV_DELAY">нижче</a>.</td></tr><tr><td><a href="./../advanced_config/parameter_reference.html#EKF2_EV_POS_X">EKF2_EV_POS_X</a>, <a href="./../advanced_config/parameter_reference.html#EKF2_EV_POS_Y">EKF2_EV_POS_Y</a>, <a href="./../advanced_config/parameter_reference.html#EKF2_EV_POS_Z">EKF2_EV_POS_Z</a></td><td>Встановіть положення візійного датчика (або маркерів MoCap) відносно тіла робота.</td></tr></tbody></table><p>Ви також можете вимкнути GNSS, baro та range finder fusion за допомогою <a href="./../advanced_config/parameter_reference.html#EKF2_GPS_CTRL">EKF2_GPS_CTRL</a>, <a href="./../advanced_config/parameter_reference.html#EKF2_BARO_CTRL">EKF2_BARO_CTRL</a> та <a href="./../advanced_config/parameter_reference.html#EKF2_RNG_CTRL">EKF2_RNG_CTRL</a>, відповідно.</p><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>Перезавантажте контролер польоту, щоб зміни параметрів набули чинності.</p></div><p><a id="tuning-EKF2_EV_DELAY"></a></p><h4 id="налаштування-ekf2-ev-delay" tabindex="-1">Налаштування EKF2_EV_DELAY <a class="header-anchor" href="#налаштування-ekf2-ev-delay" aria-label="Permalink to &quot;Налаштування EKF2_EV_DELAY&quot;">​</a></h4><p><a href="./../advanced_config/parameter_reference.html#EKF2_EV_DELAY">EKF2_EV_DELAY</a> - це затримка <em>Vision Position Estimator відносно вимірювань IMU</em>.</p><p>Іншими словами, це різниця між міткою часу системи комп&#39;ютерного зору та &quot;фактичним&quot; часом захоплення, який був би зафіксований годинником IMU (&quot;базовим годинником&quot; для EKF2).</p><p>Технічно цей параметр можна встановити на 0, якщо між комп&#39;ютерами MoCap і (наприклад) ROS є правильне маркування часу (не тільки час прибуття) і синхронізація часу (наприклад, NTP). Насправді це потребує деякого емпіричного налаштування, оскільки затримки в усьому ланцюжку MoCap-&gt;PX4 дуже залежать від налаштувань. Рідко коли система налаштована з повністю синхронізованим ланцюжком!</p><p>Приблизну оцінку затримки можна отримати з логів, перевіривши зсув між частотами IMU та EV. Щоб увімкнути реєстрацію швидкості EV, встановіть біт 7 (Комп&#39;ютерний зір та уникнення) у <a href="./../advanced_config/parameter_reference.html#SDLOG_PROFILE">SDLOG_PROFILE</a>.</p><p><img src="`+s+'" alt="ekf2_ev_delay log"></p><div class="info custom-block"><p class="custom-block-title">Графік зовнішніх даних проти вбудованої оцінки (як вище) може бути створений за допомогою <a href="./../log/flight_log_analysis.html#flightplot">FlightPlot</a> або подібних засобів аналізу польоту. На момент написання статті (липень 2021 року) ні <a href="./../log/flight_log_analysis.html#flight-review-online-tool">Flight Review</a>, ні <a href="./../log/flight_log_analysis.html#mavgcl">MAVGCL</a> не підтримують цю функцію.</p></div><p>Значення можна додатково налаштувати, змінюючи параметр, щоб знайти значення, яке дає найнижчі інновації EKF під час динамічних маневрів.</p><h2 id="lpe-конфігурація-налаштування" tabindex="-1">LPE Конфігурація/Налаштування <a class="header-anchor" href="#lpe-конфігурація-налаштування" aria-label="Permalink to &quot;LPE Конфігурація/Налаштування&quot;">​</a></h2><p>Спочатку вам потрібно <a href="./../advanced/switching_state_estimators.html">перейти до оцінювача LPE</a>, встановивши наступні параметри: <a href="./../advanced_config/parameter_reference.html#LPE_EN">LPE_EN</a> (1), <a href="./../advanced_config/parameter_reference.html#EKF2_EN">EKF2_EN</a> (0), <a href="./../advanced_config/parameter_reference.html#ATT_EN">ATT_EN</a> (0).</p><div class="info custom-block"><p class="custom-block-title">Якщо ви використовуєте обладнання <code>px4_fmu-v2</code>, вам також потрібно використовувати версію прошивки, яка містить модуль LPE (прошивка для іншого обладнання серії FMU містить як LPE, так і EKF). Версію LPE можна знайти у zip-файлі для кожного випуску PX4 або зібрати з вихідного коду за допомогою команди збірки <code>make px4_fmu-v2_lpe</code>. Дивіться <a href="./../dev_setup/building_px4.html">Створення коду</a> для більш детальної інформації.</p></div><h3 id="увімкнення-зовнішнього-введення-позиціі" tabindex="-1">Увімкнення зовнішнього введення позиції <a class="header-anchor" href="#увімкнення-зовнішнього-введення-позиціі" aria-label="Permalink to &quot;Увімкнення зовнішнього введення позиції&quot;">​</a></h3><p>Для використання зовнішньої інформації про місцезнаходження з LPE потрібно встановити такі параметри (їх можна встановити у <em>QGroundControl</em> &gt; <strong>Vehicle Setup &gt; Parameters &gt; Local Position Estimator</strong>).</p><table><thead><tr><th>Parameter</th><th>Налаштування для Зовнішньої Оцінки Положення</th></tr></thead><tbody><tr><td><a href="./../advanced_config/parameter_reference.html#LPE_FUSION">LPE_FUSION</a></td><td>Інтеграція зору увімкнена, якщо встановлено прапорець <em>fuse vision position</em> (за замовчуванням увімкнено).</td></tr><tr><td><a href="./../advanced_config/parameter_reference.html#ATT_EXT_HDG_M">ATT_EXT_HDG_M</a></td><td>Встановіть значення 1 або 2, щоб увімкнути інтеграцію зовнішніх заголовків. Встановлення значення 1 призведе до використання зору, тоді як 2 увімкне використання заголовків MoCap.</td></tr></tbody></table><h3 id="вимкнення-barometer-fusion" tabindex="-1">Вимкнення Barometer Fusion <a class="header-anchor" href="#вимкнення-barometer-fusion" aria-label="Permalink to &quot;Вимкнення Barometer Fusion&quot;">​</a></h3><p>Якщо високоточна висота вже доступна з інформації VIO або MoCap, може бути корисно вимкнути корекцію баро в LPE, щоб зменшити дрейф по осі Z.</p><p>Це можна зробити у <em>QGroundControl</em>, знявши позначку з опції <em>fuse baro</em> у параметрі <a href="./../advanced_config/parameter_reference.html#LPE_FUSION">LPE_FUSION</a>.</p><h3 id="параметри-налаштування-шуму" tabindex="-1">Параметри налаштування шуму <a class="header-anchor" href="#параметри-налаштування-шуму" aria-label="Permalink to &quot;Параметри налаштування шуму&quot;">​</a></h3><p>Якщо дані вашого комп&#39;ютерного зору або MoCap є дуже точними, і ви просто хочете, щоб оцінювач чітко відстежував їх, вам слід зменшити параметри стандартного відхилення: <a href="./../advanced_config/parameter_reference.html#LPE_VIS_XY">LPE_VIS_XY</a> і <a href="./../advanced_config/parameter_reference.html#LPE_VIS_Z">LPE_VIS_Z</a> (для VIO) або <a href="./../advanced_config/parameter_reference.html#LPE_VIC_P">LPE_VIC_P</a> (для MoCap). Зменшення їх призведе до того, що оцінювач буде більше довіряти вхідній оцінці положення. Можливо, вам доведеться встановити їх нижче допустимого мінімуму та ввімкнути примусове збереження.</p><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>Якщо продуктивність все ще низька, спробуйте збільшити параметр <a href="./../advanced_config/parameter_reference.html#LPE_PN_V">LPE_PN_V</a>. Це змусить оцінювача більше довіряти вимірюванням під час оцінювання швидкості.</p></div><h2 id="увімкнення-автоматичних-режимів-з-локальним-розташуванням" tabindex="-1">Увімкнення автоматичних режимів з локальним розташуванням <a class="header-anchor" href="#увімкнення-автоматичних-режимів-з-локальним-розташуванням" aria-label="Permalink to &quot;Увімкнення автоматичних режимів з локальним розташуванням&quot;">​</a></h2><p>Всі автоматичні режими польоту PX4 (такі як <a href="./../flight_modes_mc/mission.html">Mission</a>, <a href="./../flight_modes_mc/return.html">Return</a>, <a href="./../flight_modes_mc/land.html">Land</a>, <a href="./../flight_modes_mc/land.html">Hold</a>, <a href="./../flight_modes_mc/orbit.html">Orbit</a>)) вимагають <em>global</em> оцінки положення, яка зазвичай надходить від системи GPS/GNSS.</p><p>Системи, які мають лише <em>local</em> оцінку положення (від MOCAP, VIO або подібних), можуть використовувати повідомлення <a href="https://mavlink.io/en/messages/common.html#SET_GPS_GLOBAL_ORIGIN" target="_blank" rel="noreferrer">SET_GPS_GLOBAL_ORIGIN</a> MAVLink, щоб встановити початок координат EKF на певне глобальне місцезнаходження. Після цього EKF надасть оцінку глобального положення на основі походження та локального положення у просторі.</p><p>Це може бути використано при плануванні та виконанні місій у приміщенні, для встановлення місцевої точки повернення тощо.</p><h2 id="робота-з-ros" tabindex="-1">Робота з ROS <a class="header-anchor" href="#робота-з-ros" aria-label="Permalink to &quot;Робота з ROS&quot;">​</a></h2><p>ROS не є <em>обов&#39;язковим</em> для надання зовнішньої інформації про позицію, але настійно рекомендується, оскільки він вже має хорошу інтеграцію з системами VIO та MoCap. PX4 вже мають бути налаштовані як вище.</p><h3 id="отримання-даних-про-позицію-в-ros" tabindex="-1">Отримання даних про позицію в ROS <a class="header-anchor" href="#отримання-даних-про-позицію-в-ros" aria-label="Permalink to &quot;Отримання даних про позицію в ROS&quot;">​</a></h3><p>Системи VIO та MoCap мають різні способи отримання даних про положення, а також власні налаштування та теми.</p><p>Налаштування для конкретних систем висвітлені <a href="#setup_specific_systems">нижче</a>. Для інших систем зверніться до документації з налаштування виробника.</p><p><a id="relaying_pose_data_to_px4"></a></p><h3 id="передача-даних-про-позицію-до-px4" tabindex="-1">Передача даних про позицію до PX4 <a class="header-anchor" href="#передача-даних-про-позицію-до-px4" aria-label="Permalink to &quot;Передача даних про позицію до PX4&quot;">​</a></h3><p>MAVROS має плагіни для передачі візуальної оцінки з системи VIO або MoCap за допомогою наступних пайплайнів:</p><table><thead><tr><th>ROS</th><th>MAVLink</th><th>uORB</th></tr></thead><tbody><tr><td>/mavros/vision_pose/pose</td><td><a href="https://mavlink.io/en/messages/common.html#VISION_POSITION_ESTIMATE" target="_blank" rel="noreferrer">VISION_POSITION_ESTIMATE</a></td><td><code>vehicle_visual_odometry</code></td></tr><tr><td>/mavros/odometry/out (<code>frame_id = odom</code>, <code>child_frame_id = base_link</code>)</td><td><a href="https://mavlink.io/en/messages/common.html#ODOMETRY" target="_blank" rel="noreferrer">ODOMETRY</a> (<code>frame_id =</code> <a href="https://mavlink.io/en/messages/common.html#MAV_FRAME_LOCAL_FRD" target="_blank" rel="noreferrer">MAV_FRAME_LOCAL_FRD</a>)</td><td><code>vehicle_visual_odometry</code></td></tr><tr><td>/mavros/mocap/pose</td><td><a href="https://mavlink.io/en/messages/common.html#ATT_POS_MOCAP" target="_blank" rel="noreferrer">ATT_POS_MOCAP</a></td><td><code>vehicle_mocap_odometry</code></td></tr><tr><td>/mavros/odometry/out (<code>frame_id = odom</code>, <code>child_frame_id = base_link</code>)</td><td><a href="https://mavlink.io/en/messages/common.html#ODOMETRY" target="_blank" rel="noreferrer">ODOMETRY</a> (<code>frame_id =</code> <a href="https://mavlink.io/en/messages/common.html#MAV_FRAME_LOCAL_FRD" target="_blank" rel="noreferrer">MAV_FRAME_LOCAL_FRD</a>)</td><td><code>vehicle_mocap_odometry</code></td></tr></tbody></table><p>Ви можете використовувати будь-який з наведених вище пайплайнів за допомогою LPE.</p><p>Якщо ви працюєте з EKF2, підтримуються лише &quot;vision&quot; пайплайни. Щоб використовувати дані MoCap з EKF2, вам потрібно <a href="http://wiki.ros.org/roslaunch/XML/remap" target="_blank" rel="noreferrer">remap</a> позицію теми, яку ви отримали з MoCap:</p><ul><li>Теми MoCap ROS типу <code>geometry_msgs/PoseStamped</code> або <code>geometry_msgs/PoseWithCovarianceStamped</code> має бути змінено на <code>/mavros/vision_pose/pose</code>. Тема <code>geometry_msgs/PoseStamped</code> є найпоширенішою, оскільки MoCap зазвичай не має пов&#39;язаних з даними коваріацій.</li><li>Якщо ви отримуєте дані через ROS-повідомлення <code>nav_msgs/Odometry</code>, вам потрібно перевести його на <code>/mavros/odometry/out</code>, переконавшись, що ви оновили <code>frame_id</code> та <code>child_frame_id</code> відповідним чином.</li><li>Фрейми одометрії <code>frame_id = odom</code>, <code>child_frame_id = base_link</code> можуть бути змінені шляхом оновлення файлу у <code>mavros/launch/px4_config.yaml</code>. Однак поточна версія mavros (<code>1.3.0</code>) повинна мати можливість використовувати дерево tf для пошуку трансформації з <code>frame_id</code> до жорстко заданого кадру <code>odom_ned</code>. Те ж саме стосується <code>child_frame_id</code>, яке потрібно підключити в дереві tf до жорстко заданої рамки <code>base_link_frd</code>. Якщо ви використовуєте mavros <code>1.2.0</code> і не оновили файл <code>mavros/launch/px4_config.yaml</code>, то ви можете безпечно використовувати кадри одометрії <code>frame_id = odom</code>, <code>child_frame_id = base_link</code> без особливих турбот.</li><li>Зверніть увагу, що якщо ви надсилаєте дані одометрії до px4, використовуючи <code>child_frame_id = base_link</code>, то вам потрібно переконатися, що частина <code>twist</code> повідомлення <code>nav_msgs/Odometry</code> <strong>виражена в тілі</strong>, <strong>а не в інерційній системі координат!!!!!</strong>.</li></ul><h3 id="референсні-системи-координат-та-ros" tabindex="-1">Референсні системи координат та ROS <a class="header-anchor" href="#референсні-системи-координат-та-ros" aria-label="Permalink to &quot;Референсні системи координат та ROS&quot;">​</a></h3><p>Локальна/світова та світова системи координат, що використовуються в ROS та PX4, відрізняються.</p><table><thead><tr><th>Frame</th><th>PX4</th><th>ROS</th></tr></thead><tbody><tr><td>Body</td><td>FRD (X <strong>F</strong>orward, Y <strong>R</strong>ight, Z <strong>D</strong>own)</td><td>FLU (X <strong>F</strong>orward, Y <strong>L</strong>eft, Z <strong>U</strong>p), зазвичай називається <code>base_link</code></td></tr><tr><td>World</td><td>FRD або NED (X <strong>N</strong>orth, Y <strong>E</strong>ast, Z <strong>D</strong>own)</td><td>FLU або ENU (X <strong>E</strong>ast, Y <strong>N</strong>orth, Z <strong>U</strong>p), з іменуванням <code>odom</code> або <code>map</code></td></tr></tbody></table><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>Дивіться <a href="http://www.ros.org/reps/rep-0105.html" target="_blank" rel="noreferrer">REP105: Системи координат для мобільних платформ</a> для отримання додаткової інформації про системи координат ROS.</p></div><p>Обидві системи координат показані на зображенні нижче (FRD зліва / FLU справа).</p><p><img src="'+i+`" alt="Reference frames"></p><p>З EKF2 при використанні зовнішньої оцінки напрямку магнітного північ може бути або ігноруватися, або зміщення напрямку до магнітного північного може бути розраховано та скомпенсовано. Залежно від вашого вибору кут крену вказується відносно магнітного північного або місцевого <em>x</em>.</p><div class="info custom-block"><p class="custom-block-title">При створенні жорсткого тіла в програмному забезпеченні MoCap не забудьте спочатку вирівняти локальну вісь робота <em>x</em> зі світовою віссю <em>x</em>, інакше оцінка розвороту матиме зміщення. Це може призупинити правильну роботу злиття зовнішньої оцінки позиції. Кут крену повинен дорівнювати нулю, коли тіло та опорна система вирівнюються.</p></div><p>Використовуючи MAVROS, ця операція є простою. ROS використовує фрейми ENU як конвенцію, тому зворотний зв&#39;язок щодо позиції повинен бути наданий в ENU. Якщо у вас є система Optitrack, ви можете використати вузол <a href="https://github.com/ros-drivers/mocap_optitrack" target="_blank" rel="noreferrer">mocap_optitrack</a>, який транслює позицію об&#39;єкта на тему ROS, що вже є у ENU. За допомогою переналаштування ви можете безпосередньо опублікувати його на <code>mocap_pose_estimate</code> таким, як він є, без будь-яких перетворень, і MAVROS позбудеться перетворень NED.</p><p>Плагін MAVROS відомий тим, що спрощує роботу з координатними рамками. Він використовує пакет tf ROS. Ваш зовнішній система позиціонування може мати зовсім іншу конвенцію рамки, яка не відповідає конвенції PX4. Корпусна рама зовнішньої оцінки позиції може залежати від того, як ви встановите корпусну раму в програмному забезпеченні MOCAP або від того, як ви встановите сенсор VIO на дрона. Плагін відомостей MAVROS потребує знання, як дитяча рамка зовнішньої позиції орієнтована відносно рамки тіла FRD або FLU повітряного судна, відомої за допомогою MAVROS. Отже, вам потрібно додати зовнішню позу тіла до дерева tf. Це можна зробити, включивши адаптовану версію наступного рядка до вашого ROS-файлу запуску.</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span></span></span></code></pre></div><p>Переконайтеся, що ви змінили значення крену, тангажу та кочення так, що вони належним чином приєднують корпус зовнішньої позиції до <code>base_link</code> або <code>base_link_frd</code>. Подивіться на пакет <a href="http://wiki.ros.org/tf#static_transform_publisher" target="_blank" rel="noreferrer">tf package</a> для отримання додаткової допомоги з приводу того, як вказати трансформацію між кадрами. Ви можете використовувати rviz, щоб перевірити, чи ви правильно прикріпили рамку. Назва <code>external_pose_child_frame</code> повинна збігатися з child_frame_id вашого повідомлення <code>nav_msgs/Odometry</code>. Те ж саме стосується і для опорної рамки зовнішньої позиції. Вам потрібно прикріпити опорний каркас зовнішньої позиції як дитину до рамки <code>odom</code> або <code>odom_frd</code>. Адаптуйте тому відповідно кодовий рядок.</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>  &lt;node pkg=&quot;tf&quot; type=&quot;static_transform_publisher&quot; name=&quot;tf_odom_externalPoseParentFrame&quot;</span></span>
<span class="line"><span>        args=&quot;0 0 0 &lt;yaw&gt; &lt;pitch&gt; &lt;roll&gt; odom &lt;external_pose_parent_frame&gt; 1000&quot;/&gt;</span></span></code></pre></div><p>Якщо опорна рама має вісь z, що вказує вгору, ви можете прикріпити її без будь-якого обертання (yaw=0, pitch=0, roll=0) до рами <code>odom</code>. Назва <code>external_pose_parent_frame</code> повинна збігатися з frame_id повідомлення про відомість.</p><div class="info custom-block"><p class="custom-block-title">При використанні плагіну MAVROS <em>odom</em> важливо, щоб жоден інший вузол не публікував трансформацію між зовнішнім посиланням позиції та дочірнім кадром. Це може зламати дерево <em>tf</em>.</p></div><p><a id="setup_specific_systems"></a></p><h2 id="конкретні-налаштування-системи" tabindex="-1">Конкретні налаштування системи <a class="header-anchor" href="#конкретні-налаштування-системи" aria-label="Permalink to &quot;Конкретні налаштування системи&quot;">​</a></h2><h3 id="optitrack-mocap" tabindex="-1">OptiTrack MoCap <a class="header-anchor" href="#optitrack-mocap" aria-label="Permalink to &quot;OptiTrack MoCap&quot;">​</a></h3><p>Наступні кроки пояснюють, як подавати оцінки позиції з системи <a href="https://optitrack.com/motion-capture-robotics/" target="_blank" rel="noreferrer">OptiTrack</a> в PX4. Припускається, що система MoCap налаштована. Дивіться <a href="https://www.youtube.com/watch?v=cNZaFEghTBU" target="_blank" rel="noreferrer">це відео</a> для навчання процесу калібрування.</p><h4 id="кроки-у-програмному-забезпеченні-motive-mocap" tabindex="-1">Кроки у програмному забезпеченні <em>Motive</em> MoCap <a class="header-anchor" href="#кроки-у-програмному-забезпеченні-motive-mocap" aria-label="Permalink to &quot;Кроки у програмному забезпеченні *Motive* MoCap&quot;">​</a></h4><ul><li>Вирівняйте напрямок вашого робота з <a href="https://v20.wiki.optitrack.com/index.php?title=Template:Coordinate_System" target="_blank" rel="noreferrer">system +x-axis</a></li><li><a href="https://www.youtube.com/watch?v=1e6Qqxqe-k0" target="_blank" rel="noreferrer">Визначте жорстке тіло в програмному забезпеченні Motive</a>. Вкажіть роботу ім&#39;я, яке не містить пробілів, наприклад, <code>robot1</code> замість <code>Rigidbody 1</code></li><li><a href="https://www.youtube.com/watch?v=yYRNG58zPFo" target="_blank" rel="noreferrer">Увімкніть трансляцію кадру та потокове відтворення VRPN</a></li><li>Встановіть вісь Up на ось Z (за замовчуванням - Y)</li></ul><h4 id="отримання-даних-про-позицію-в-ros-1" tabindex="-1">Отримання даних про позицію в ROS <a class="header-anchor" href="#отримання-даних-про-позицію-в-ros-1" aria-label="Permalink to &quot;Отримання даних про позицію в ROS&quot;">​</a></h4><ul><li>Встановіть пакет <code>vrpn_client_ros</code></li><li>Ви можете отримати позу кожного жорсткого тіла на окрему тему, запустивши<div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">roslaunch</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> vrpn_client_ros</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> sample.launch</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> server:=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">mocap</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> machine</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> i</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">p</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span></span></code></pre></div></li></ul><p>Якщо ви назвали rigidbody як <code>robot1</code>, ви отримаєте тему, схожу на <code>/vrpn_client_node/robot1/pose</code></p><h4 id="передача-перенаправлення-даних-про-позу" tabindex="-1">Передача / перенаправлення даних про позу <a class="header-anchor" href="#передача-перенаправлення-даних-про-позу" aria-label="Permalink to &quot;Передача / перенаправлення даних про позу&quot;">​</a></h4><p>MAVROS надає плагін для передачі даних позиції, опублікованих на <code>/mavros/vision_pose/pose</code>, до PX4. Припускаючи, що MAVROS працює, вам просто потрібно <strong>переналаштувати</strong> тему позиції, яку ви отримуєте від MoCap <code>/vrpn_client_node/&lt;rigid_body_name&gt;/pose</code> безпосередньо на <code>/mavros/vision_pose/pose</code>. Зверніть увагу, що також є тема <code>mocap</code>, яку надає MAVROS для подачі <code>ATT_POS_MOCAP</code> в PX4, але вона не застосовується до EKF2. Однак, це застосовується з LPE.</p><div class="info custom-block"><p class="custom-block-title">Переналаштування тем постави описано вище <a href="#relaying_pose_data_to_px4">Передача даних постави в PX4</a> (<code>/vrpn_client_node/&lt;rigid_body_name&gt;/pose</code> має тип <code>geometry_msgs/PoseStamped</code>).</p></div><p>Припускаючи, що ви налаштували параметри EKF2, як описано вище, PX4 тепер встановлений і об&#39;єднує дані MoCap.</p><p>Ви тепер готові перейти до першого політ.</p><h2 id="першии-політ" tabindex="-1">Перший політ <a class="header-anchor" href="#першии-політ" aria-label="Permalink to &quot;Перший політ&quot;">​</a></h2><p>Після налаштування однієї з (специфічних) систем, описаних вище, ви повинні бути готові до тесту. Інструкції нижче показують, як це зробити для систем MoCap та VIO</p><h3 id="перевірте-зовнішню-оцінку" tabindex="-1">Перевірте зовнішню оцінку <a class="header-anchor" href="#перевірте-зовнішню-оцінку" aria-label="Permalink to &quot;Перевірте зовнішню оцінку&quot;">​</a></h3><p>Перед першим польотом обов&#39;язково виконайте наступні перевірки:</p><ul><li>Встановіть параметр PX4 <code>MAV_ODOM_LP</code> на 1. Після цього PX4 передасть отриману зовнішню позицію назад у вигляді повідомлень MAVLink <a href="https://mavlink.io/en/messages/common.html#ODOMETRY" target="_blank" rel="noreferrer">ODOMETRY</a>.</li><li>Ви можете перевірити ці повідомлення MAVLink за допомогою <em>QGroundControl</em> <a href="https://docs.qgroundcontrol.com/master/en/qgc-user-guide/analyze_view/mavlink_inspector.html" target="_blank" rel="noreferrer">Інспектора MAVLink</a> Для цього поверніть транспортний засіб, поки кватерніон повідомлення <code>ODOMETRY</code> дуже близький до одиничного кватерніону. (w=1, x=y=z=0)</li><li>На цьому етапі корпус виробу зорієнтований у відповідності з ориєнтацією відносно зовнішньої системи координат. Якщо вам не вдається отримати кватерніон, близький до одиничного, без обертання або нахилу вашого літака, це, ймовірно, означає, що ваша рама все ще має зміщення нахилу або кочування. У цьому випадку не продовжуйте і перевірте знову свої координатні рамки.</li><li>Після зорієнтування ви можете підняти літак з землі, і ви маєте бачити, як координата z позиції зменшується. Переміщення засобу в напрямку вперед повинно збільшити координату X. Під час руху транспортного засобу вправо слід збільшувати координату y. У разі, якщо ви також надсилаєте лінійні швидкості зовнішньої системи позиціонування, вам також слід перевірити лінійні швидкості. Перевірте, що лінійні швидкості виражені в описаній відносно корпусу <em>FRD</em> відліковій системі.</li><li>Встановіть параметр PX4 <code>MAV_ODOM_LP</code> на 0. PX4 припинить передавати це повідомлення назад.</li></ul><p>Якщо ці кроки є послідовними, ви можете спробувати свій перший польот.</p><p>Покладіть робота на землю і почніть передавати зворотний зв&#39;язок MoCap. Потягніть палицю газу вниз і зберметизуйте двигуни.</p><p>На цьому етапі, зліва палиця на найнижчому положенні, перейдіть у режим позиціонного контролю. Ви повинні побачити зелену лампочку. Зелена лампочка свідчить про те, що доступний зворотний зв&#39;язок позиції, і позиційний контроль активований.</p><p>Помістіть лівий джойстик в середину, це зона мертвої зони. З цим значенням палиці робот підтримує свою висоту; підняття палиці збільшить висоту посилки, тоді як зниження значення зменшить її. Те ж саме для правої палиці по x та y.</p><p>Збільште значення лівої палиці, і робот злетить, поверніть його назад у середину праворуч після цього. Перевірте, чи він може утримати своє положення.</p><p>Якщо це працює, ви можете налаштувати експеримент <a href="./offboard_control.html">поза бортом</a>, відправивши позиційний вказівник з віддаленої земної станції.</p>`,86);function T(M,F,S,x,A,V){return r(),o("div",null,[d,e("p",null,[t("Наприклад, якщо ви використовуєте фреймворк Optitrack, локальний каркас має координати "),e("mjx-container",c,[(r(),o("svg",m,_)),h]),t(" та "),e("mjx-container",g,[(r(),o("svg",f,k)),E]),t(" на горизонтальній площині ("),b,t(" вперед і "),v,t(" праворуч), в той час як вісь "),O,t(" є вертикальною і спрямована вверх. Простий трюк полягає в тому, що обмінюються вісіми, щоб отримати конвенцію NED.")]),P])}const I=n(l,[["render",T]]);export{y as __pageData,I as default};
