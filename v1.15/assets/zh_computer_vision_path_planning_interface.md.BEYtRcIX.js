import{_ as e,c as a,o,ab as t}from"./chunks/framework.CUflZczI.js";const f=JSON.parse('{"title":"路径规划接口","description":"","frontmatter":{},"headers":[],"relativePath":"zh/computer_vision/path_planning_interface.md","filePath":"zh/computer_vision/path_planning_interface.md"}'),i={name:"zh/computer_vision/path_planning_interface.md"},n=t('<h1 id="路径规划接口" tabindex="-1">路径规划接口 <a class="header-anchor" href="#路径规划接口" aria-label="Permalink to &quot;路径规划接口&quot;">​</a></h1><p>PX4 使用数个 MAVLink 接口来整合机载计算机的路径规划服务（包括在执行航线任务时避障，<a href="./../computer_vision/safe_landing.html">安全着陆</a>和未来的一些服务）：</p><ul><li>有两个 <a href="https://mavlink.io/en/services/trajectory.html" target="_blank" rel="noreferrer">MAVLink 路径规划协议</a> 接口： <ul><li><a href="https://mavlink.io/en/messages/common.html#TRAJECTORY_REPRESENTATION_WAYPOINTS" target="_blank" rel="noreferrer">TRAJECTORY_REPRESENTATION_WAYPOINTS</a>: Used by PX4 to send the <em>desired path</em>. May be used by path planning software to send PX4 a stream of setpoints for the <em>planned path</em>.</li><li><a href="https://mavlink.io/en/messages/common.html#TRAJECTORY_REPRESENTATION_BEZIER" target="_blank" rel="noreferrer">TRAJECTORY_REPRESENTATION_BEZIER</a> may (alternatively) be used by path planning software to send PX4 the <em>planned path</em> as a bezier curve. 曲线表示给定时间段内机体（移动的）位置设定值。</li></ul></li><li><a href="https://mavlink.io/en/services/heartbeat.html" target="_blank" rel="noreferrer">HEARTBEAT（心跳包）/连接协议</a> 用于检测“生命证明”。</li><li><a href="https://mavlink.io/en/messages/common.html#LOCAL_POSITION_NED" target="_blank" rel="noreferrer">LOCAL_POSITION_NED</a> 和 <a href="https://mavlink.io/en/messages/common.html#ALTITUDE" target="_blank" rel="noreferrer">ALTITUDE</a> 分别用来发送机体本地位置和高度。</li></ul><p>如果 <a href="./../advanced_config/parameter_reference.html#COM_OBS_AVOID">COM_OBS_AVOID=1</a>，那么 PX4 的路径规划功能会在自动化模式 （着陆Landing、起飞Takeoff、保持Hold、任务Mission、返回Return）下启用 。 在这些模式中，路径规划软件将为 PX4 提供预设航点；如果软件无法支持特定的飞行模式，则必须将设定值从机体上向下一个位置镜像。</p><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>The message flows from PX4 UORB topics, through MAVLink, to ROS and back again are all documented in <a href="https://github.com/PX4/PX4-Avoidance#message-flows" target="_blank" rel="noreferrer">PX4/PX4-Avoidance &gt; Message Flows</a>. 因此，开发者可以使用这个接口来创建自己新的机载计算机端路径规划服务，或调整现有的规划者软件。</p><p>所有使用此接口的服务均发送并且接收相同类型/格式的消息。 Developers can therefore use this interface to create their own new companion-side path planning services or tweak the existing planner software.</p><p>:::note 推荐使用 <a href="./../complete_vehicles/px4_vision_kit.html">PX4 Vision Autonomy Development Kit</a> 来开发路径规划软件。 It comes with <a href="https://github.com/PX4/PX4-Avoidance" target="_blank" rel="noreferrer">PX4 avoidance</a> software pre-installed and can be used as the base for your own algorithms.</p></div><h2 id="px4-配置" tabindex="-1">PX4 配置 <a class="header-anchor" href="#px4-配置" aria-label="Permalink to &quot;PX4 配置&quot;">​</a></h2><p>实际需要的设置/配置取决于所用的规划器。</p><h2 id="机载计算机设置" tabindex="-1">机载计算机设置 <a class="header-anchor" href="#机载计算机设置" aria-label="Permalink to &quot;机载计算机设置&quot;">​</a></h2><p>Companion-side hardware setup and hardware/software configuration is provided in the <a href="https://github.com/PX4/PX4-Avoidance" target="_blank" rel="noreferrer">PX4/PX4-Avoidance</a> Github repo.</p><p>实际需要的设置/配置取决于所用的规划器。</p><div class="warning custom-block"><p class="custom-block-title">WARNING</p><p>Only one planner can run on the companion computer at a time (at the time of writing). This means that offboard features that use different planners cannot be enabled on the same vehicle at the same time (e.g., a vehicle can support obstacle avoidance and collision prevention, but not also safe landing - or vice versa).</p></div><p><a id="waypoint_interface"></a></p><h2 id="轨迹接口" tabindex="-1">轨迹接口 <a class="header-anchor" href="#轨迹接口" aria-label="Permalink to &quot;轨迹接口&quot;">​</a></h2><p>PX4 sends information about the <em>desired path</em> to the companion computer (when <code>COM_OBS_AVOID=1</code>, in <em>auto</em> modes), and receives back a stream of setpoints for the <em>planned path</em> from the path planning software.</p><p>期望路径信息由 PX4 通过使用 <a href="https://mavlink.io/en/messages/common.html#TRAJECTORY_REPRESENTATION_WAYPOINTS" target="_blank" rel="noreferrer">TRAJECTORY_REPRESTATION_WAYPOINTS</a> 消息来发送，如下文 <a href="#px4_waypoint_interface">PX4 航点接口</a> 所述。</p><p>Path planner software sends back setpoints for the <em>planned path</em> using either <code>TRAJECTORY_REPRESENTATION_WAYPOINTS</code> (see <a href="#companion_waypoint_interface">Companion Waypoint Interface</a>) or <a href="https://mavlink.io/en/messages/common.html#TRAJECTORY_REPRESENTATION_BEZIER" target="_blank" rel="noreferrer">TRAJECTORY_REPRESENTATION_BEZIER</a> (see <a href="#bezier_interface">Companion Bezier Trajectory Interface</a>). 不同之处在于，前者航点参数只是指定下一个设定的目标航点，而贝塞尔轨迹则描述精确的车辆运动（即随时间变化的设定点）。</p><div class="warning custom-block"><p class="custom-block-title">WARNING</p><p>路由规划软件在执行任务时不应混用这些接口（PX4 将使用最近收到的任意类型的消息）。 因此，开发者可以使用这个接口来创建自己新的机载计算机端路径规划服务，或调整现有的规划者软件。</p><p><a id="px4_waypoint_interface"></a></p><h3 id="px4-航点接口" tabindex="-1">PX4 航点接口 <a class="header-anchor" href="#px4-航点接口" aria-label="Permalink to &quot;PX4 航点接口&quot;">​</a></h3><p>PX4 将期望路径封装在 <a href="https://mavlink.io/en/messages/common.html#TRAJECTORY_REPRESENTATION_WAYPOINTS" target="_blank" rel="noreferrer">TRAJECTORY_REPRESENTATION_WAYPOINTS</a> 消息中，以 5Hz 的频率发送。</p><p>PX4 中各字段定义如下：</p><ul><li><code>time_usec</code>: UNIX 纪元时间戳</li><li><code>valid_points</code>: 3</li><li>Point 0 - Current waypoint <em>type adapted</em> by FlightTaskAutoMapper (see <a href="#type_adapted">notes below</a>): <ul><li><code>pos_x[0]</code>, <code>pos_y[0]</code>, <code>pos_z[0]</code>: Type adapted x-y-z NED local position of <em>current</em> mission waypoint.</li><li><code>vel_x[0]</code>, <code>vel_y[0]</code>, <code>vel_z[0]</code>: Type adapted x-y-z NED local velocity of <em>current</em> mission waypoint.</li><li><code>acc_x[0]</code>, <code>acc_y[0]</code>, <code>acc_z[0]</code>: NaN</li><li><code>pos_yaw[0]</code>: 当前航向角</li><li><code>vel_yaw[0]</code>: NaN</li><li><code>command[0]</code>: 当前航点的 <a href="https://mavlink.io/en/messages/common.html#mav_commands" target="_blank" rel="noreferrer">MAVLink 命令</a></li></ul></li><li>Point 1 - 当前航点（未修改/未调整类型）： <ul><li><code>pos_x[1]</code>, <code>pos_y[1]</code>, <code>pos_z[1]</code>: x-y-z NED local position of <em>current</em> mission waypoint</li><li><code>vel_x[1]</code>, <code>vel_y[1]</code>, <code>vel_z[1]</code>: NaN</li><li><code>acc_x[1]</code>, <code>acc_y[1]</code>, <code>acc_z[1]</code>: NaN</li><li><code>pos_yaw[1]</code>: 航向设定值</li><li><code>vel_yaw[1]</code>: 偏航速率设定值</li><li><code>command[1]</code>: 当前航点的 <a href="https://mavlink.io/en/messages/common.html#mav_commands" target="_blank" rel="noreferrer">MAVLink 命令</a></li></ul></li><li>Point 2 - 局部坐标系中的下一个航点 (未修改/未调整类型)： <ul><li><code>pos_x[2]</code>, <code>pos_y[2]</code>, <code>pos_z[2]</code>: x-y-z NED local position of <em>next</em> mission waypoint</li><li><code>vel_x[2]</code>, <code>vel_y[2]</code>, <code>vel_z[2]</code>: NaN</li><li><code>acc_x[2]</code>, <code>acc_y[2]</code>, <code>acc_z[2]</code>: NaN</li><li><code>pos_yaw[2]</code>: 航向设定值</li><li><code>vel_yaw[2]</code>: 偏航速率设定值</li><li><code>command[2]</code>: 当前航点的 <a href="https://mavlink.io/en/messages/common.html#mav_commands" target="_blank" rel="noreferrer">MAVLink 命令</a></li></ul></li><li>所有其它字段都是NaN(未定义)。</li></ul><p><a id="type_adapted"></a></p><p>路径规划软件（在机载计算机上运行）<em>可以</em> 以<a href="https://mavlink.io/en/messages/common.html#TRAJECTORY_REPRESENTATION_WAYPOINTS" target="_blank" rel="noreferrer">TRAJECTORY_REPRESENTATION_WAYPOINTS</a> 消息流的形式发送所规划路径给 PX4，消息流中包含 Point 0 设定航点。</p><ul><li>Point 0 是当前根据目标类型所修改的目标航点/目标。 例如，在着陆时指定目标的 x、y 坐标和降落速度是合理的。 为了实现这一点，<code>FlightTaskAutoMapper</code> 修改 Point 0 中的着陆点，将 z 轴位置的分量设置为 NAN，将 z 轴速度设置为期望值。</li><li>Points 1 and 2 are not used by the safe landing planner.</li><li>Point 1 is used by local and global planners.</li></ul><p><a id="companion-failure-handling"></a></p><h4 id="机载计算机的失效处理" tabindex="-1">机载计算机的失效处理 <a class="header-anchor" href="#机载计算机的失效处理" aria-label="Permalink to &quot;机载计算机的失效处理&quot;">​</a></h4><p>实现此接口的规划器必须：</p><ul><li>如果规划器均未运行并且 <code>COM_OBS_AVOID</code> 在/从启动时处于启用状态： <ul><li>航前自检将失败（无论机体模式如何），在 <code>COM_OBS_AVOID</code> 设置为 0 之前，机体不会起飞。</li></ul></li><li>如果规划器均未运行并且 <code>COM_OBS_AVOID</code> 在启动后处于启用状态： <ul><li>机体将以手动方式正常运行。</li><li>if you switch to an autonomous mode (e.g. Land Mode) it will immediately fall back to <a href="./../flight_modes_mc/hold.html">Hold mode</a>.</li></ul></li><li>When external path planning is enabled: <ul><li>if the <code>HEARTBEAT</code> is lost PX4 will emit a status message (which is displayed in <em>QGroundControl</em>) stating either &quot;Avoidance system lost&quot; or &quot;Avoidance system timeout&quot; (depending on the vehicle state). 这项提醒与当前的飞行模式无关。</li><li>if a trajectory message is not received for more than 0.5 seconds and the vehicle is in an autonomous mode (Return, Mission, Takeoff, Land), the vehicle will switch into <a href="./../flight_modes_mc/hold.html">Hold mode</a>. ::: info A planner must always provide points in this timeframe.</li><li>A planner will mirror back setpoints it receives when the vehicle is in a mode/state for which it doesn&#39;t provide path planning. (i.e. the vehicle will follow its desired path, delayed by a very small amount).</li></ul></li></ul></div><ul><li>If the execution time of the last-supplied Bezier trajectory expires during path planning (when using the <a href="#bezier_interface">Bezier Trajectory Interface</a>), this is treated the same as not getting a new message within 0.5 seconds (i.e. vehicle switches to <a href="./../flight_modes_mc/hold.html">Hold mode</a>).</li></ul><p><a id="companion_waypoint_interface"></a></p><h2 id="机载航点接口" tabindex="-1">机载航点接口 <a class="header-anchor" href="#机载航点接口" aria-label="Permalink to &quot;机载航点接口&quot;">​</a></h2><p>The path planning software (running on the companion computer) <em>may</em> send the planned path to PX4 as a stream of <a href="https://mavlink.io/en/messages/common.html#TRAJECTORY_REPRESENTATION_WAYPOINTS" target="_blank" rel="noreferrer">TRAJECTORY_REPRESENTATION_WAYPOINTS</a> messages that have the setpoint in Point 0.</p><p>来自机载计算机的消息字段设置如下：</p><ul><li><code>time_usec</code>: UNIX 纪元时间戳</li><li><code>valid_points</code>: 1</li><li>当前飞机信息： <ul><li><code>pos_x[0]</code>, <code>pos_y[0]</code>, <code>pos_z[0]</code>: x-y-z NED坐标系下的载具位置设定值</li><li><code>vel_x[0]</code>, <code>vel_y[0]</code>, <code>vel_z[0]</code>: x-y-z NED 坐标系下速度设定值</li><li><code>acc_x[0]</code>, <code>acc_y[0]</code>, <code>acc_z[0]</code>: NaN</li><li><code>pos_yaw[0]</code>: 航向角设定值</li><li><code>vel_yaw[0]</code>: 偏航速率设定值</li><li><code>command[0]</code>: NaN</li></ul></li><li>所有其它字段都是NaN(未定义)。</li></ul><p>更详细地讲，<code>TRAJECTORY_REPRESENTATION_BEZIER</code> 被解析为：</p><ul><li>从 PX4 接收消息时，以超过 2Hz 的频率发出设定点。 PX4 will enter <a href="./../flight_modes_mc/hold.html">Hold mode</a> if no message is received for more than 0.5s.</li><li>Mirror back setpoints it receives when it doesn&#39;t support planning for the current vehicle state (e.g. the local planner would mirror back messages sent during safe landing because it does not support Land mode).</li></ul><p><a id="bezier_interface"></a></p><h2 id="机载贝塞尔曲线轨迹接口" tabindex="-1">机载贝塞尔曲线轨迹接口 <a class="header-anchor" href="#机载贝塞尔曲线轨迹接口" aria-label="Permalink to &quot;机载贝塞尔曲线轨迹接口&quot;">​</a></h2><p>The path planning software (running on the companion computer) <em>may</em> send the planned path to PX4 as a stream of <a href="https://mavlink.io/en/messages/common.html#TRAJECTORY_REPRESENTATION_BEZIER" target="_blank" rel="noreferrer">TRAJECTORY_REPRESENTATION_BEZIER</a> messages.</p><p>消息定义了无人机应遵循的路径（由控制点定义），从消息 <code>时间戳</code> 开始，在时间 <code>delta</code> 后到达终点。 PX4 使用消息发送时间、当前时间和贝塞尔曲线的总时间（delta）计算其新的轨迹设定点（沿曲线趋势来预测的当前位置/速度/加速度）。</p><div class="info custom-block"><p class="custom-block-title">For example, say the message was sent 0.1 seconds ago, and <code>delta</code> (curve duration) is 0.3s. PX4 可以在曲线中以 0.1 秒间隔的精度计算其轨迹设定点。 因此，开发者可以使用这个接口来创建自己新的机载计算机端路径规划服务，或调整现有的规划者软件。</p><p>更详细地讲，<code>TRAJECTORY_REPRESENTATION_BEZIER</code> 被解析为：</p><ul><li>The number of Bezier control points determines the degree of the Bezier curve. For example, 3 points make a quadratic Bezier curve with constant acceleration.</li><li>The Bezier curve must be the same degree in x, y, z, and yaw, with all Bezier control points finite</li><li>The <code>delta</code> array should have the value corresponding with the last Bezier control point to indicate the duration that the waypoint takes to execute the curve to that point, from beginning to end. 其他 <code>delta</code> 数组中的值将被忽略。</li><li>MAVLink 消息的时间戳应为曲线开始的时间，通信延迟和时钟不匹配将通过时间同步机制在飞行控制器上进行补偿。</li><li>所有控制点都应该在局部坐标系中指定（<a href="https://mavlink.io/en/messages/common.html#MAV_FRAME_LOCAL_NED" target="_blank" rel="noreferrer">MAV_FRAME_LOCAL_NED</a>）。</li><li>Bezier curves expire after the execution time of the Bezier curve has been reached. Ensure that new messages are sent at a high enough rate and with a long enough execution time. If this does not happen the vehicle will switch to Hold mode.</li></ul><h2 id="支持的硬件" tabindex="-1">支持的硬件 <a class="header-anchor" href="#支持的硬件" aria-label="Permalink to &quot;支持的硬件&quot;">​</a></h2><p>Tested companion computers and cameras are listed in <a href="https://github.com/PX4/PX4-Avoidance#run-on-hardware" target="_blank" rel="noreferrer">PX4/PX4-Avoidance</a>.</p></div>',30),l=[n];function r(c,s,d,h,m,p){return o(),a("div",null,l)}const u=e(i,[["render",r]]);export{f as __pageData,u as default};
