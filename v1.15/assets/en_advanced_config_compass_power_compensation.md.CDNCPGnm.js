import{_ as e,a as t,b as a,c as o}from"./chunks/comp_params.u_TZpdZZ.js";import{_ as s,c as i,o as r,ab as n}from"./chunks/framework.CUflZczI.js";const v=JSON.parse('{"title":"Compass Power Compensation","description":"","frontmatter":{},"headers":[],"relativePath":"en/advanced_config/compass_power_compensation.md","filePath":"en/advanced_config/compass_power_compensation.md"}'),p={name:"en/advanced_config/compass_power_compensation.md"},l=n('<h1 id="compass-power-compensation" tabindex="-1">Compass Power Compensation <a class="header-anchor" href="#compass-power-compensation" aria-label="Permalink to &quot;Compass Power Compensation&quot;">​</a></h1><p>Compasses (magnetometers) should be mounted as far as possible from cables that carry large currents, as these induce magnetic fields that may corrupt the compass readings.</p><p>This topic explains how to compensate for the induced magnetic fields in the cases where moving the compass is not realistic.</p><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>Moving the compass away from power-carrying cables is the easiest and most effective way to fix this issue, because the strength of the magnetic fields decreases quadratically with the distance from the cable.</p></div><div class="info custom-block"><p class="custom-block-title">INFO</p><p>The process is demonstrated for a multicopter, but is equally valid for other vehicle types.</p></div><p><a id="when"></a></p><h2 id="when-is-power-compensation-applicable" tabindex="-1">When is Power Compensation Applicable? <a class="header-anchor" href="#when-is-power-compensation-applicable" aria-label="Permalink to &quot;When is Power Compensation Applicable?&quot;">​</a></h2><p>Performing this power compensation is advisable only if all the following statements are true:</p><ol><li><p>The compass cannot be moved away from the power-carrying cables.</p></li><li><p>There is a strong correlation between the compass readings and the thrust setpoint, and/or the battery current.</p><p><img src="'+e+'" alt="Corrupted mag"></p></li><li><p>The drone cables are all fixed in place/do not move (calculated compensation parameters will be invalid if the current-carrying cables can move).</p></li></ol><p><a id="how"></a></p><h2 id="how-to-compensate-the-compass" tabindex="-1">How to Compensate the Compass <a class="header-anchor" href="#how-to-compensate-the-compass" aria-label="Permalink to &quot;How to Compensate the Compass&quot;">​</a></h2><ol><li><p>Make sure your drone runs a Firmware version supporting power compensation (current master, or releases from v.1.11.0).</p></li><li><p>Perform the <a href="./../config/compass.html#compass-calibration">standard compass calibration</a>.</p></li><li><p>Set the parameter <a href="./../advanced_config/parameter_reference.html#SDLOG_MODE">SDLOG_MODE</a> to 2 to enable logging of data from boot.</p></li><li><p>Set the parameter <a href="./../advanced_config/parameter_reference.html#SDLOG_PROFILE">SDLOG_PROFILE</a> checkbox for <em>Sensor comparison</em> (bit 6) to get more data points.</p></li><li><p>Secure the drone so that it cannot move, and attach the propellers (so the motors can draw the same current as in flight). This example secures the vehicle using straps.</p><p><img src="'+t+'" alt="strap"></p></li><li><p>Power the vehicle and switch into <a href="./../flight_modes_mc/acro.html">ACRO flight mode</a> (using this mode ensures the vehicle won&#39;t attempt to compensate for movement resulting from the straps).</p><ul><li>Arm the vehicle and slowly raise the throttle to the maximum</li><li>Slowly lower the throttle down to zero</li><li>Disarm the vehicle</li></ul><div class="info custom-block"><p class="custom-block-title">INFO</p><p>Perform the test carefully and closely monitor the vibrations.</p></div></li><li><p>Retrieve the ulog and use the python script <a href="https://github.com/PX4/PX4-Autopilot/blob/release/1.15/src/modules/sensors/vehicle_magnetometer/mag_compensation/python/mag_compensation.py" target="_blank" rel="noreferrer">mag_compensation.py</a> to identify the compensation parameters.</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">python</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> mag_compensation.py</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ~/path/to/log/logfile.ulg</span></span></code></pre></div><div class="info custom-block"><p class="custom-block-title">INFO</p><p>If your log does not contain battery current measurements, you will need to comment out the respective lines in the Python script, such that it does the calculation for thrust only.</p></div></li><li><p>The script will return the parameter identification for thrust as well as for current and print them to the console. The figures that pop up from the script show the &quot;goodness of fit&quot; for each compass instance, and how the data would look if compensated with the suggested values. If a current measurement is available, using the current-compensation usually yields the better results. Here is an example of a log, where the current fit is good, but the thrust parameters are unusable as the relationship is not linear.</p><p><img src="'+a+'" alt="line fit"></p></li><li><p>Once the parameters are identified, the power compensation must be enabled by setting <a href="./../advanced_config/parameter_reference.html#CAL_MAG_COMP_TYP">CAL_MAG_COMP_TYP</a> to 1 (when using thrust parameters) or 2 (when using current parameters). Additionally, the compensation parameters for each axis of each compass must be set.</p><p><img src="'+o+'" alt="comp params"></p></li></ol>',12),c=[l];function h(m,d,u,f,g,_){return r(),i("div",null,c)}const y=s(p,[["render",h]]);export{v as __pageData,y as default};
