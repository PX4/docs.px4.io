import{_ as l,a as t}from"./chunks/qgc_mode_assignment.qGPdsCZc.js";import{_ as h,E as p,c as e,J as i,a as n,m as a,ab as k,o as r}from"./chunks/framework.CUflZczI.js";const b=JSON.parse('{"title":"Інтерфейс керування PX4 ROS 2","description":"","frontmatter":{},"headers":[],"relativePath":"uk/ros2/px4_ros2_control_interface.md","filePath":"uk/ros2/px4_ros2_control_interface.md"}'),d={name:"uk/ros2/px4_ros2_control_interface.md"},E=a("h1",{id:"інтерфеис-керування-px4-ros-2",tabindex:"-1"},[n("Інтерфейс керування PX4 ROS 2 "),a("a",{class:"header-anchor",href:"#інтерфеис-керування-px4-ros-2","aria-label":'Permalink to "Інтерфейс керування PX4 ROS 2"'},"​")],-1),g=k('<div class="warning custom-block"><p class="custom-block-title">WARNING</p><p>Експериментальні налаштування</p><ul><li>Архітектура та основні інтерфейси для визначення режимів ROS 2 є значною мірою стабільними і перевіряються в ІК. Бібліотека надає значні переваги в режимі офборду в поточному стані.</li><li>Лише кілька типів значень було врегульовано (інші все ще в розробці). Вам можуть знадобитися внутрішні теми PX4, які можуть не залишитись серверно-сумісними з часом.</li><li>API не повністю задокументований.</li></ul></div><p><a href="./../ros2/px4_ros2_interface_lib.html">PX4 ROS 2 Interface бібліотека</a> - це бібліотека C++++, яка спрощує контроль PX4 з ROS 2.</p><p>Розробники використовують бібліотеку для створення і динамічної реєстрації режимів, написаних за допомогою ROS 2. Ці режими динамічно реєструються в PX4 і здаються частиною PX4 для наземної станції або іншої зовнішньої системи. Вони навіть можуть замінити стандартні режими в PX4 на покращені версії ROS 2, відновлюючи оригінальну версію, якщо режим ROS2 не вдасться.</p><p>Бібліотека також надає класи для надсилання різних типів налаштувань, починаючи від багаторівневих навігаційних завдань на високому рівні аж до прямого контролю приводу. Ці класи абстрагують внутрішні встановлені точки, які використовуються PX4, і, отже, їх можна використовувати для надання послідовного інтерфейсу ROS 2 для майбутніх версій PX4 і ROS.</p><h2 id="загальнии-огляд" tabindex="-1">Загальний огляд <a class="header-anchor" href="#загальнии-огляд" aria-label="Permalink to &quot;Загальний огляд&quot;">​</a></h2><p>Ця діаграма надає концептуального уявлення про те, як режими інтерфейсу і режими керування будуть взаємодіяти з PX4.</p><p><img src="'+l+`" alt="ROS2 modes overview diagram"></p><p>Наступні розділи визначають та пояснюють терміни, що використовуються в діаграмі.</p><h3 id="означення" tabindex="-1">Означення <a class="header-anchor" href="#означення" aria-label="Permalink to &quot;Означення&quot;">​</a></h3><h4 id="режим" tabindex="-1">Режим <a class="header-anchor" href="#режим" aria-label="Permalink to &quot;Режим&quot;">​</a></h4><p>Режим визначений за допомогою бібліотеки інтерфейсу має такі властивості:</p><ul><li>Режим - це компонент, який може передавати вказані точки автомобіля для керування рухом (такі як швидкість або прямі вимикачі).</li><li>Режим вибирає тип значень і відправляє його під час активності. Він може переключитися між різними типами множин.</li><li>Режим не може активувати інші режими, і він повинен бути активований користувачем (через RC/GCS), контролер польоту в безпечній ситуації <em>mode executor</em>, або деяких інших зовнішніх системах.</li><li>Має ім&#39;я, яке відображається у GCS.</li><li>Можна налаштувати вимоги до його режиму (наприклад, що він вимагає достовірної оцінки позиції).</li><li>Режим може виконувати різні завдання, такі як польот до цілі, спуск лебідки, скидання вантажу та повернення назад.</li><li>Режим може замінити режим, визначений у PX4.</li></ul><h4 id="виконавець-режимів" tabindex="-1">Виконавець Режимів <a class="header-anchor" href="#виконавець-режимів" aria-label="Permalink to &quot;Виконавець Режимів&quot;">​</a></h4><p>Виконавець режимів - це необов&#39;язковий компонент для розкладання режимів. Наприклад, виконавець режимів для індивідуальної доставки вантажу або режиму обстеження може спочатку ініціювати злет, потім переключитися на індивідуальний режим, і коли він завершиться, ініціювати повернення на базу (RTL).</p><p>Зокрема, він має наступні властивості:</p><ul><li>Виконавець режимів - це необов&#39;язковий компонент, який знаходиться на рівень вище за режим. Це скінченний автомат, який може активувати режими і чекати їх завершення.</li><li>Це може зробити лише поки він є відповідним. Для цього виконавець має лише один власний режим (і режим може належати лише одному виконавцю). Цей режим служить для активації виконавця: коли користувач вибирає режим, активується власник-виконавець, який може вибрати будь-який режим. Він залишається відповідальним до того моменту, поки користувач не змінить режими (через RC або з GCS), або не спрацює аварійний перехід в інший режим. Якщо аварійна ситуація знімається, виконавець знову активується.</li><li>Це дозволяє існувати декільком виконавцям одночасно.</li><li>Виконувачі не можуть активувати інших виконавців.</li><li>У бібліотеці виконавець режимів завжди реалізується в комбінації з індивідуальним режимом.</li></ul><div class="info custom-block"><p class="custom-block-title">INFO</p><ul><li>Ці визначення гарантують, що користувач може в будь-який момент забрати контроль від індивідуального режиму або виконавця, командуючи переключення режиму через RC або GCS. Виконавець режимів є прозорим для користувача.</li><li>Виконавець режиму є прозорий для користувача. Він вибирається і активується опосередковано через власний режим, і тому режим має бути відповідно названий.</li></ul></div><h4 id="перевизначення-конфігураціі" tabindex="-1">Перевизначення конфігурації <a class="header-anchor" href="#перевизначення-конфігураціі" aria-label="Permalink to &quot;Перевизначення конфігурації&quot;">​</a></h4><p>Обидва режими і виконавці можуть визначати заміну конфігурації, дозволяючи персоналізацію певних поведінок, коли режим або виконавець активний.</p><p>Наразі реалізовано наступне:</p><ul><li><em>Вимкнення автоматичного роз&#39;єднання</em>. Це дозволяє здійснити посадку та знову злетіти (наприклад, для скидання вантажу).</li><li><em>Можливість відкласти неістотні збої помилки</em>. Це дозволяє виконавцю проводити дію без переривання через некритичні заходи безпеки. Наприклад, ігнорування заходу безпеки через низький заряд батареї, щоб операція з лебідкою могла бути завершена.</li></ul><h3 id="порівняння-з-управлінням-з-віддаленоі-платформи" tabindex="-1">Порівняння з управлінням з віддаленої платформи <a class="header-anchor" href="#порівняння-з-управлінням-з-віддаленоі-платформи" aria-label="Permalink to &quot;Порівняння з управлінням з віддаленої платформи&quot;">​</a></h3><p>Вищезазначені концепції мають кілька переваг перед традиційним управлінням з віддаленої платформи:</p><ul><li>Декілька вузлів або додатків можуть співіснувати і навіть працювати одночасно. Але лише один вузол може керувати транспортним засобом у певний момент, і цей вузол чітко визначений.</li><li>Режими мають відмінну назву і можуть бути відображені / вибрані в GCS.</li><li>Режими інтегровані з аварійною машиною стану та перевірками настроювання.</li><li>Типи установок, які можуть бути відправлені, чітко визначені.</li><li>Режими ROS 2 можуть замінити внутрішні режими контролера польоту (такі як режим повернення).</li></ul><h2 id="установка-та-першии-тест" tabindex="-1">Установка та перший тест <a class="header-anchor" href="#установка-та-першии-тест" aria-label="Permalink to &quot;Установка та перший тест&quot;">​</a></h2><p>Для початку роботи потрібно виконати наступні кроки:</p><ol><li><p>Make sure you have a working <a href="./../ros2/user_guide.html">ROS 2 setup</a>, with <a href="https://github.com/PX4/px4_msgs" target="_blank" rel="noreferrer"><code>px4_msgs</code></a> in the ROS 2 workspace.</p></li><li><p>Клонуйте репозиторій в робочий простір:</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">cd</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $ros_workspace</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">/src</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">git</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> clone</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --recursive</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://github.com/Auterion/px4-ros2-interface-lib</span></span></code></pre></div><div class="info custom-block"><p class="custom-block-title">INFO</p><p>Для забезпечення сумісності, використовуйте останні <em>main</em> гілки для PX4, <em>px4_msgs</em> та бібліотеки.:::</p></div></li><li><p>Побудуйте робочий простір:</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">cd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ..</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">colcon</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> build</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">source</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> install/setup.bash</span></span></code></pre></div></li><li><p>У іншій оболонці запустіть PX4 SITL:</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">cd</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> $px4</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">-autopilot</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">make</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> px4_sitl</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> gazebo-classic</span></span></code></pre></div><p>(тут ми використовуємо Gazebo-Classic, але ви можете використовувати будь-яку модель або симулятор)</p></li><li><p>Запустіть агента micro XRCE в новій оболонці (після цього ви можете залишити його запущеним):</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">MicroXRCEAgent</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> udp4</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -p</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 8888</span></span></code></pre></div></li><li><p>Запустіть QGroundControl.</p><div class="info custom-block"><p class="custom-block-title">INFO</p><p>Використовуйте QGroundControl Daily, яка підтримує динамічне оновлення списку режимів.</p></div></li></ol><p>:::</p><ol start="7"><li><p>Повернутись до терміналу 2 ROS, запустити один із прикладів:</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ros2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> run</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> example_mode_manual_cpp</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> example_mode_manual</span></span></code></pre></div><p>Ви повинні отримати на виході режим &#39;Мій ручний режим&#39; зареєстрований:</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[DEBUG] [example_mode_manual]: Checking message compatibility...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[DEBUG] [example_mode_manual]: Subscriber found, continuing</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[DEBUG] [example_mode_manual]: Publisher found, continuing</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[DEBUG] [example_mode_manual]: Registering </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;My Manual Mode&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">arming</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> check:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 1,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> mode:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 1,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> mode</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> executor:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[DEBUG] [example_mode_manual]: Subscriber found, continuing</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[DEBUG] [example_mode_manual]: Publisher found, continuing</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[DEBUG] [example_mode_manual]: Got RegisterExtComponentReply</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[DEBUG] [example_mode_manual]: Arming check request (id</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">1,</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> only</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> printed</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> once</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div></li><li><p>На PX4 оболонці ви можете перевірити, що PX4 зареєстрував новий режим:</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">commander</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> status</span></span></code></pre></div><p>Вихід має містити:</p><div class="language-plain vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">plain</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>INFO  [commander] Disarmed</span></span>
<span class="line"><span>INFO  [commander] navigation mode: Position</span></span>
<span class="line"><span>INFO  [commander] user intended navigation mode: Position</span></span>
<span class="line"><span>INFO  [commander] in failsafe: no</span></span>
<span class="line"><span>INFO  [commander] External Mode 1: nav_state: 23, name: My Manual Mode</span></span></code></pre></div></li><li><p>У цій точці ви також повинні побачити режим в QGroundControl :</p></li><li><p>Виберіть режим, переконайтеся, що у вас є ручне джерело управління (фізичний або віртуальний джойстик), та озброєння транспорту. Тоді режим активується, і він має вивести наступний вивід:</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[DEBUG] [example_mode_manual]: Mode </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;My Manual Mode&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> activated</span></span></code></pre></div></li><li><p>Тепер ви готові створити свій власний режим.</p></li></ol><h2 id="як-користуватися-бібліотекою" tabindex="-1">Як користуватися бібліотекою <a class="header-anchor" href="#як-користуватися-бібліотекою" aria-label="Permalink to &quot;Як користуватися бібліотекою&quot;">​</a></h2><p>Наступні розділи описують конкретні функціональні можливості, які надає ця бібліотека. Крім того, можна підписуватися на будь-яку іншу тему PX4 або публікувати у неї.</p><h3 id="визначення-класу-режиму" tabindex="-1">Визначення класу режиму <a class="header-anchor" href="#визначення-класу-режиму" aria-label="Permalink to &quot;Визначення класу режиму&quot;">​</a></h3><p>У цьому розділі розглядається приклад створення класу для власного режиму.</p><p>Для повного застосування перегляньте приклади в репозиторії Auterion/px4-ros2-interface-lib, такі як examples/cpp/modes/manual.</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line highlighted"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> MyMode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> : </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> px4_ros2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ModeBase</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // [1]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  explicit</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> MyMode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rclcpp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Node</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> node</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  : </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ModeBase</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(node, Settings{</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;My Mode&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">})</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // [2]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  {</span></span>
<span class="line highlighted"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // [3]</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    _manual_control_input </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> std</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">make_shared</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">px4_ros2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ManualControlInput</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    _rates_setpoint </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> std</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">make_shared</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">px4_ros2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">RatesSetpointType</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> onActivate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">override</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // Called whenever our mode gets selected</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> onDeactivate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">override</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  {</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // Called when our mode gets deactivated</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> updateSetpoint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> rclcpp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Duration</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> dt</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">override</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  {</span></span>
<span class="line highlighted"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    // [4]</span></span>
<span class="line highlighted"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Eigen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::Vector3f thrust_sp{</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0.</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">F</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0.</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">F</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">_manual_control_input-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">throttle</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()};</span></span>
<span class="line highlighted"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    const</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Eigen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::Vector3f rates_sp{</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      _manual_control_input-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">roll</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 150.</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">F</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> M_PI </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 180.</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">F</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line highlighted"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      -</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">_manual_control_input-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pitch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 150.</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">F</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> M_PI </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 180.</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">F</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">,</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      _manual_control_input-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">yaw</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 100.</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">F</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> M_PI </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 180.</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">F</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    };</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    _rates_setpoint-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">update</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(rates_sp, thrust_sp);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">private:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  std</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::shared_ptr</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">px4_ros2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::ManualControlInput</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> _manual_control_input;</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  std</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::shared_ptr</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">px4_ros2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::RatesSetpointType</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> _rates_setpoint;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span></code></pre></div><ul><li><code>[1]</code>: Спочатку ми створюємо клас, який успадковується від <a href="https://auterion.github.io/px4-ros2-interface-lib/classpx4__ros2_1_1ModeBase.html" target="_blank" rel="noreferrer"><code>px4_ros2::ModeBase</code></a>.</li><li><code>[2]</code>: У конструкторі ми передаємо назву режиму. Це також дозволяє нам налаштувати деякі інші речі, наприклад, замінити внутрішній режим польоту.</li><li><code>[3]</code>: Саме тут ми створюємо всі об&#39;єкти, через які ми хочемо використовувати пізніше. Це може бути RC на виведення, значення типу або телеметрія. <code>*this</code> передається як <code>Контекст</code> до кожного об&#39;єкту, який асоціює об&#39;єкт з режимом.</li><li><code>[4]</code>: Кожен раз, коли режим активний, цей метод викликається регулярно (частота оновлення залежить від типу вказаної точки). Ось де ми можемо працювати і створювати нову установку.</li></ul><p>Після створення екземпляру цього режиму потрібно викликати mode-&gt;doRegister(), яке фактично реєструється з контролером польоту і повертає false у разі невдачі. У разі використання виконавця режиму, doRegister() повинно бути викликано на виконавці режиму, а не на самому режимі.</p><h3 id="визначення-класу-виконавця-режиму" tabindex="-1">Визначення класу виконавця режиму <a class="header-anchor" href="#визначення-класу-виконавця-режиму" aria-label="Permalink to &quot;Визначення класу виконавця режиму&quot;">​</a></h3><p>У цьому розділі розглядається приклад створення класу для власного режиму.</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line highlighted"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> MyModeExecutor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> : </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> px4_ros2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ModeExecutorBase</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // [1]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public:</span></span>
<span class="line highlighted"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  MyModeExecutor</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rclcpp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Node</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> node</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">px4_ros2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ModeBase</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> &amp;</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> owned_mode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // [2]</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  : </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ModeExecutorBase</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(node, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">px4_ros2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ModeExecutorBase</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::Settings{}, owned_mode),</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    _node</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(node)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  { }</span></span>
<span class="line"></span>
<span class="line highlighted"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  enum</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> class</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> State </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// [3]</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  {</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    Reset,</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    TakingOff,</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    MyMode,</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    RTL,</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    WaitUntilDisarmed,</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  };</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> onActivate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">override</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  {</span></span>
<span class="line highlighted"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    runState</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">State</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::TakingOff, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">px4_ros2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Result</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::Success);</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // [4]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> onDeactivate</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">DeactivateReason</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> reason</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">override</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> runState</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">State</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> state</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">px4_ros2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Result</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> previous_result</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (previous_result </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">!=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> px4_ros2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Result</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::Success) {</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">      RCLCPP_ERROR</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(_node.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get_logger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(), </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;State </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%i</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">: previous state failed: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)state,</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        resultToString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(previous_result));</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line highlighted"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    switch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (state) {</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // [5]</span></span>
<span class="line highlighted"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      case</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> State</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::Reset:</span></span>
<span class="line highlighted"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line highlighted"><wbr></span>
<span class="line highlighted"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      case</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> State</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::TakingOff:</span></span>
<span class="line highlighted"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        takeoff</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">([</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">](</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">px4_ros2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Result</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> result</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">runState</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">State</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::MyMode, result);});</span></span>
<span class="line highlighted"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line highlighted"><wbr></span>
<span class="line highlighted"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      case</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> State</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::MyMode:</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> // [6]</span></span>
<span class="line highlighted"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        scheduleMode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line highlighted"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">          ownedMode</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">id</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(), [</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">](</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">px4_ros2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Result</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> result</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line highlighted"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">            runState</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">State</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::RTL, result);</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          });</span></span>
<span class="line highlighted"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line highlighted"><wbr></span>
<span class="line highlighted"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      case</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> State</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::RTL:</span></span>
<span class="line highlighted"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        rtl</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">([</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">](</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">px4_ros2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Result</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> result</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">runState</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">State</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::WaitUntilDisarmed, result);});</span></span>
<span class="line highlighted"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line highlighted"><wbr></span>
<span class="line highlighted"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">      case</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> State</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::WaitUntilDisarmed:</span></span>
<span class="line highlighted"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        waitUntilDisarmed</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">([</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">](</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">px4_ros2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Result</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;"> result</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line highlighted"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">            RCLCPP_INFO</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(_node.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">get_logger</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(), </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;All states complete (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">%s</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">)&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">resultToString</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(result));</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          });</span></span>
<span class="line highlighted"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        break</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line highlighted"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">private:</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  rclcpp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::Node </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> _node;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span></code></pre></div><ul><li><code>[1]</code>: Спочатку ми створюємо клас, який наслідується від <a href="https://auterion.github.io/px4-ros2-interface-lib/classpx4__ros2_1_1ModeExecutorBase.html" target="_blank" rel="noreferrer"><code>px4_ros2::ModeExecutorBase</code></a>.</li><li>[2]: Конструктор приймає наш власний режим, який пов&#39;язаний з виконавцем, і передає його в конструктор ModeExecutorBase.</li><li>[3]: Ми визначаємо перерахування для станів, через які ми хочемо пройти.</li><li>[4]: Метод onActivate викликається, коли виконавець стає активним. На цій точці ми можемо почати проходити через наші стани. Як ви це робите - це на ваш розсуд, у цьому прикладі використовується метод runState для виконання наступного стану.</li><li>[5]: При переході до стану ми викликаємо асинхронний метод від ModeExecutorBase для запуску бажаного режиму: run, takeoff, rtl і так далі. Ці методи передають функцію, яка викликається при завершенні; зворотний виклик надає аргумент Result, який вказує, чи вдалося виконання чи ні. У разі успіху зворотний виклик запускає наступний стан.</li><li>[6]: Ми використовуємо метод scheduleMode(), щоб запустити &quot;власний режим&quot; виконавця, слідуючи тому ж шаблону, що й інші обробники станів.</li></ul><h3 id="типи-установок" tabindex="-1">Типи установок <a class="header-anchor" href="#типи-установок" aria-label="Permalink to &quot;Типи установок&quot;">​</a></h3><p>Режим може вибрати тип(и) установки, які він хоче використовувати для керування транспортним засобом. Використані типи також визначають сумісність з різними типами транспортних засобів.</p><p>Наступні розділи надають список підтримуваних типів установок:</p><ul><li>GotoSetpointType: Плавне позиціонування та (за бажанням) керування курсом</li><li>DirectActuatorsSetpointType: Пряме керування моторами та установками сервоприводів польотних поверхонь</li></ul><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>The other setpoint types are currently experimental, and can be found in: <a href="https://github.com/Auterion/px4-ros2-interface-lib/tree/main/px4_ros2_cpp/include/px4_ros2/control/setpoint_types/experimental" target="_blank" rel="noreferrer">px4_ros2/control/setpoint_types/experimental</a>.</p><p>Ви можете додати свої власні типи установок, додавши клас, який успадковується від px4_ros2::SetpointBase, встановлює прапорці конфігурації відповідно до того, що вимагає установка, а потім публікує будь-яку тему, що містить установку</p></div><h4 id="установка-переити-до-gotosetpointtype" tabindex="-1">Установка &quot;перейти до&quot; (GotoSetpointType) <a class="header-anchor" href="#установка-переити-до-gotosetpointtype" aria-label="Permalink to &quot;Установка &quot;перейти до&quot; (GotoSetpointType)&quot;">​</a></h4><div class="info custom-block"><p class="custom-block-title">INFO</p><p>Цей тип установки наразі підтримується лише для багтрикоптерів.</p></div><p>Плавне керування позицією та (за бажанням) керуванням установками курсу за допомогою типу установки px4_ros2::GotoSetpointType. Тип установки транслюється до плавних позиційних та курсових вирівнювачів на основі FMU, сформульованих з оптимальним за часом, максимальною швидкістю зміни прискорення, з обмеженнями швидкості та прискорення.</p><p>Найбільш тривіальне використання полягає в простому введенні 3D-позиції в метод оновлення:</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Eigen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::Vector3f target_position_m{</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10.</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">F</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0.</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">F</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3.</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">F</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">_goto_setpoint-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">update</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(target_position_m);</span></span></code></pre></div><p>У цьому випадку заголовок залишиться <em>uncontrolled</em>. Для додаткового контрольного заголовку, вкажіть його в якості другого вхідного аргументу:</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Eigen</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::Vector3f target_position_m{</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10.</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">F</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0.</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">F</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">3.</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">F</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">const</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> float</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> heading_rad </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 3.14</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">F</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">_goto_setpoint-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">update</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  target_position_m,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  heading_rad);</span></span></code></pre></div><p>Додатковою особливістю установки цільової точки є динамічний контроль за межами швидкості плавних рухів (тобто максимальні горизонтальні та вертикальні швидкості трансляції, а також швидкість руху по курсу). Якщо, як вище, не вказано, то плавники за замовчуванням приймуть максимальні значення за замовчуванням транспортного засобу (зазвичай встановлені на фізичні обмеження). Плавники можуть тільки зменшувати межі швидкості, але ніколи не збільшувати.</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">_goto_setpoint-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">update</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  target_position_m,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  heading_rad,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  max_horizontal_velocity_m_s,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  max_vertical_velocity_m_s,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  max_heading_rate_rad_s);</span></span></code></pre></div><p>Усі аргументи у методі оновлення, крім позиції, є зразками у вигляді <code>std::optional&lt;float&gt;</code>, що означає, що якщо хтось бажає обмежити швидкість руху по курсу, але не швидкості трансляції, це можливо за допомогою <code>std::nullopt</code>:</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">_goto_setpoint-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">update</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  target_position_m,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  heading_rad,</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  std</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::nullopt,</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  std</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::nullopt,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  max_heading_rate_rad_s);</span></span></code></pre></div><h4 id="безпосереднє-значення-параметра-control-directactuatorssetpointtype" tabindex="-1">Безпосереднє значення параметра Control (DirectActuatorsSetpointType) <a class="header-anchor" href="#безпосереднє-значення-параметра-control-directactuatorssetpointtype" aria-label="Permalink to &quot;Безпосереднє значення параметра Control (DirectActuatorsSetpointType)&quot;">​</a></h4><p>Клапани можна безпосередньо керувати, використовуючи тип встановлення px4_ros2::DirectActuatorsSetpointType. Мотори і сервоприводи можна встановити незалежно один від одного. Будьте уважні, що призначення є транспортним засобом та специфікацією. Наприклад, для управління квадрокоптером потрібно встановити перші 4 мотори відповідно до його конфігурації виводу.</p><div class="info custom-block"><p class="custom-block-title">INFO</p><p>Якщо ви хочете керувати клапаном, який не контролює рух транспортного засобу, але, наприклад, сервопривід навантаження, подивіться нижче.</p></div><h3 id="керування-незалежним-клапаном-сервоприводом" tabindex="-1">Керування незалежним клапаном/сервоприводом <a class="header-anchor" href="#керування-незалежним-клапаном-сервоприводом" aria-label="Permalink to &quot;Керування незалежним клапаном/сервоприводом&quot;">​</a></h3><p>Якщо ви хочете керувати незалежним клапаном (сервоприводом), дотримуйтесь цих кроків:</p><ol><li>Налаштуйте вивід</li><li>Створіть екземпляр px4_ros2::PeripheralActuatorControls у конструкторі вашого режиму.</li><li>Викличте метод set(), щоб керувати клапаном(-ами). Це може бути зроблено незалежно від будь-яких активних встановлень.</li></ol><h3 id="телеметрія" tabindex="-1">Телеметрія <a class="header-anchor" href="#телеметрія" aria-label="Permalink to &quot;Телеметрія&quot;">​</a></h3><p>Ви можете отримати доступ до телеметрії PX4 безпосередньо через наступні класи:</p><ul><li><a href="https://auterion.github.io/px4-ros2-interface-lib/classpx4__ros2_1_1OdometryGlobalPosition.html" target="_blank" rel="noreferrer">OdometryGlobalPosition</a>: Global position</li><li><a href="https://auterion.github.io/px4-ros2-interface-lib/classpx4__ros2_1_1OdometryLocalPosition.html" target="_blank" rel="noreferrer">OdometryLocalPosition</a>: Local position, velocity, acceleration, and heading</li><li><a href="https://auterion.github.io/px4-ros2-interface-lib/classpx4__ros2_1_1OdometryAttitude.html" target="_blank" rel="noreferrer">OdometryAttitude</a>: Vehicle attitude</li></ul><p>Наприклад, ви можете надати запит на поточну позицію автомобіля наступним чином:</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">std</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::shared_ptr</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">px4_ros2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::OdometryLocalPosition</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> _vehicle_local_position;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Get vehicle&#39;s last local position</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">_vehicle_local_position-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">positionNed</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// Check last horizontal position is valid</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">_vehicle_local_position-&gt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">positionXYValid</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span></code></pre></div><div class="info custom-block"><p class="custom-block-title">INFO</p><p>Ці теми надають обгортку навколо внутрішніх тем PX4, що дозволяє бібліотеці підтримувати сумісність у випадку зміни внутрішніх тем. Перевірте px4_ros2/odometry для нових тем, і, звісно, ви можете використовувати будь-яку тему ROS 2, опубліковану з PX4.</p></div><h3 id="аваріині-вимкнення-та-вимоги-до-режимів" tabindex="-1">Аварійні вимкнення та вимоги до режимів <a class="header-anchor" href="#аваріині-вимкнення-та-вимоги-до-режимів" aria-label="Permalink to &quot;Аварійні вимкнення та вимоги до режимів&quot;">​</a></h3><p>Кожен режим має набір прапорців вимог. Ці прапорці, як правило, автоматично встановлюються в залежності від об&#39;єктів, які використовуються в контексті режиму. Наприклад, коли додається керування вручну за допомогою коду нижче, прапорець вимог для керування вручну встановлюється:</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">_manual_control_input </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> std</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">make_shared</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">px4_ros2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ManualControlInput</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">this</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span></code></pre></div><p>Зокрема, встановлення прапорця має наступні наслідки в PX4, якщо умова не виконується:</p><ul><li>Озброєння неможливе, коли вибрано режим</li><li>коли вже озброєний, режим не можна вибрати</li><li>коли озброєний і обраний режим, відповідний аварійний режим спрацьовує (наприклад, втрата RC для вимоги до керування вручну). Перевірте <a href="./../config/safety.html">сторінку безпеки</a>, щоб налаштувати безпечну поведінку. Аварійний режим також спрацьовує, коли режим аварійно завершується або стає несприйнятливим, коли він обраний.</li></ul><p>Ось відповідна блок-схема для прапорця керування вручну:</p><p>Можна вручну оновити будь-які вимоги до режиму після реєстрації.</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">modeRequirements</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().home_position </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span></code></pre></div><p>Повний список флагів може бути знайдений у <a href="https://github.com/Auterion/px4-ros2-interface-lib/blob/main/px4_ros2_cpp/include/px4_ros2/common/requirement_flags.hpp" target="_blank" rel="noreferrer">requirement_flags.hpp</a>.</p><h4 id="відкладення-аваріиних-режимів" tabindex="-1">Відкладення аварійних режимів <a class="header-anchor" href="#відкладення-аваріиних-режимів" aria-label="Permalink to &quot;Відкладення аварійних режимів&quot;">​</a></h4><p>Режим або режим виконавця може тимчасово відкласти неістотні збої, викликаючи метод <a href="https://auterion.github.io/px4-2-interface-lib/classpx4__ros2_1_1ModeExecutorBase.html#a16ec5be6e70e1d0625bf696c3e29ae" target="_blank" rel="noreferrer"><code>deferFailsafesSync()</code></a>.</p><p>Переглянте <a href="https://github.com/Auterion/px4-ros2-interface-lib/blob/main/px4_ros2_cpp/test/integration/overrides.cpp" target="_blank" rel="noreferrer">integration test</a> for an example.</p><h3 id="призначення-режиму-для-rc-перемикача-або-діі-джоистика" tabindex="-1">Призначення режиму для RC-перемикача або дії джойстика <a class="header-anchor" href="#призначення-режиму-для-rc-перемикача-або-діі-джоистика" aria-label="Permalink to &quot;Призначення режиму для RC-перемикача або дії джойстика&quot;">​</a></h3><p>Зовнішні режими можуть бути призначені на <a href="./../config/flight_mode.html">RC перемикачі</a> або дії джойстика. При призначенні режиму для RC-перемикача вам потрібно знати індекс (тому що параметри метаданих не містять динамічне ім&#39;я режиму). Використовуйте статус <code>commander </code>, коли режим запущено, щоб отримати цю інформацію.</p><div class="language-plain vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">plain</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>   INFO  [commander] External Mode 1: nav_state: 23, name: My Manual Mode</span></span></code></pre></div><p>означає, що ви б обрали <strong>Зовнішній режим 1</strong> в QGC:</p><p><img src="`+t+'" alt="QGC Mode Assignment"></p><div class="info custom-block"><p class="custom-block-title">INFO</p><p>PX4 забезпечує, що певний режим завжди призначається тому ж індексу, зберігаючи хеш назви режиму. This makes it independent of startup ordering in case of multiple external modes.</p></div><h3 id="заміна-внутрішнього-режиму" tabindex="-1">Заміна внутрішнього режиму <a class="header-anchor" href="#заміна-внутрішнього-режиму" aria-label="Permalink to &quot;Заміна внутрішнього режиму&quot;">​</a></h3><p>Зовнішній режим може замінити існуючий внутрішній режим, наприклад, режим Повернення (RTL). При цьому кожного разу, коли вибирається RTL (через користувача або ситуацію аварійного виклику), замість внутрішнього режиму використовується зовнішній. Внутрішній режим використовується лише як резервний випадок. Внутрішній режим використовується лише як резервний випадок, коли зовнішній стає недоступним або відмовляє.</p><p>Замінений режим можна встановити в налаштуваннях конструктора ModeBase:</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Settings{kName, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ModeBase</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::kModeIDRtl}</span></span></code></pre></div>',91);function o(c,y,F,u,C,m){const s=p("Badge");return r(),e("div",null,[E,i(s,{type:"tip",text:"PX4 v1.15"}),n(),i(s,{type:"warning",text:"Experimental"}),g])}const v=h(d,[["render",o]]);export{b as __pageData,v as default};
