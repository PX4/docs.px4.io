import{_ as s,c as i,o as t,ab as a}from"./chunks/framework.CUflZczI.js";const g=JSON.parse('{"title":"Модульні Тести","description":"","frontmatter":{},"headers":[],"relativePath":"uk/test_and_ci/unit_tests.md","filePath":"uk/test_and_ci/unit_tests.md"}'),e={name:"uk/test_and_ci/unit_tests.md"},n=a(`<h1 id="модульні-тести" tabindex="-1">Модульні Тести <a class="header-anchor" href="#модульні-тести" aria-label="Permalink to &quot;Модульні Тести&quot;">​</a></h1><p>Розробникам рекомендується писати модульні тести на всіх етапах розробки, включаючи додавання нових функцій, виправлення помилок і рефакторинг</p><p>PX4 надає декілька методів для написання юніт тестів:</p><ol><li>Модульні тести з <a href="https://github.com/google/googletest/blob/main/docs/primer.md" target="_blank" rel="noreferrer">Google Test</a> (&quot;GTest&quot;) – тести, які мають мінімальні внутрішні залежності</li><li>Функціональні тести з GTest - тести, які залежать від параметрів та uORB повідомлень</li><li>Модульні тести SITL. Це і є тести, які повинні запускатися в повному SITL. Ці тести виконуються набагато повільніше та важче налагодити, тому, якщо можливо, замість них рекомендується використовувати GTest.</li></ol><h2 id="написання-gtest-unit-test" tabindex="-1">Написання GTest Unit Test <a class="header-anchor" href="#написання-gtest-unit-test" aria-label="Permalink to &quot;Написання GTest Unit Test&quot;">​</a></h2><p><strong>Порада</strong>: загалом, якщо вам потрібен доступ до розширених утиліт GTest, структур даних із STL або потрібно зв’язатися з <code>параметрами</code> чи бібліотеками <code>uorb</code>, натомість слід використовувати функціональні тести.</p><p>Кроки для створення нових функціональних тестів такі:</p><ol><li>Модульні тести мають бути організовані в три секції: налаштування, запуск, перевірка результатів. Кожен тест повинен перевіряти одну дуже конкретну поведінку або випадок налаштування, тому, якщо тест провалиться, стане очевидним, що не так. Будь ласка, намагайтеся дотримуватися цих стандартів, коли це можливо.</li><li>Скопіюйте та перейменуйте приклад модульного тесту <a href="https://github.com/PX4/PX4-Autopilot/blob/release/1.15/src/modules/mc_att_control/AttitudeControl/AttitudeControlTest.cpp" target="_blank" rel="noreferrer">AttitudeControlTest</a> у каталог, у якому знаходиться код для перевірки.</li><li>Додайте новий файл до <code>CMakeLists.txt</code> каталогу. Це має виглядати приблизно так: <code>px4_add_unit_gtest(SRC MyNewUnitTest.cpp LINKLIBS &lt;library_to_be_tested&gt;&lt;library_to_be_tested&gt;)</code></li><li>Додайте бажану функцію тестування. Це означатиме включення файлів заголовків, необхідних для ваших конкретних тестів, додавання нових тестів (кожен з індивідуальною назвою) і розміщення логіки для налаштування, запуск коду для перевірки та перевірка його поведінки, як очікувалося.</li><li>Якщо потрібні додаткові бібліотечні залежності, їх також слід додати до CMakeLists після <code>LINKLIBS</code>, як показано вище.</li></ol><p>Тести можна запустити за допомогою <code>make tests</code>, після чого ви знайдете двійковий файл у <code>build/px4_sitl_test/unit-MyNewUnit</code>. Він може бути запущений безпосередньо в налагоджувачі.</p><h2 id="написання-gtest-functional-test" tabindex="-1">Написання GTest Functional Test <a class="header-anchor" href="#написання-gtest-functional-test" aria-label="Permalink to &quot;Написання GTest Functional Test&quot;">​</a></h2><p>Функціональні тести GTest слід використовувати, коли тест або компоненти, що тестуються, залежать від параметрів, повідомлень uORB та/або розширеної функціональності GTest. Крім того, функціональні тести можуть містити локальне використання структур даних STL (хоча і будьте обережні відмінності платформ між такими як macOS і Linux).</p><p>Кроки для створення нових функціональних тестів такі:</p><ol><li>Загалом (і подібно до модульних тестів), функціональні тести мають бути організовані за трьома розділами: налаштування, запуск, перевірка результатів. Кожен тест повинен перевіряти одну дуже конкретну поведінку або випадок налаштування, тому, якщо тест провалиться, стане очевидним, що не так. Будь ласка, намагайтеся дотримуватися цих стандартів, коли це можливо.</li><li>Скопіюйте та перейменуйте приклад функціонального тесту <a href="https://github.com/PX4/PX4-Autopilot/blob/release/1.15/src/lib/parameters/ParameterTest.cpp" target="_blank" rel="noreferrer">ParameterTest</a> у каталог, у якому знаходиться код, який потрібно перевірити.</li><li>Перейменуйте клас з ParameterTest на те, що краще представляє код, що тестується</li><li>Додайте новий файл до <code>CMakeLists.txt</code> каталогу. Це має виглядати приблизно так: <code>px4_add_functional_gtest(SRC MyNewFunctionalTest.cpp LINKLIBS &lt;library_to_be_tested&gt;&lt;library_to_be_tested&gt;)</code></li><li>Додайте бажану функцію тестування. Це означатиме включення файлів заголовків, необхідних для ваших конкретних тестів, додавання нових тестів (кожен з індивідуальною назвою) і розміщення логіки для налаштування тесту, запуск коду, який потрібно перевірити, і перевірку його поведінки, як очікувалося.</li><li>Якщо потрібні додаткові бібліотечні залежності, їх також слід додати до CMakeLists після <code>LINKLIBS</code>, як показано вище.</li></ol><p>Тести можна запускати за допомогою <code>make tests</code>, після чого ви знайдете двійковий файл у <code>build/px4_sitl_test/functional-MyNewFunctional</code>. Його можна запустити безпосередньо в налагоджувачі, однак будьте обережні, щоб запустити лише один тест для кожного виклику виконуваного файлу, використовуючи аргументи --<a href="https://github.com/google/googletest/blob/main/docs/advanced.md#running-a-subset-of-the-tests" target="_blank" rel="noreferrer">--gtest_filter=&lt;regex&gt;</a>, оскільки деякі частини uORB і бібліотек параметрів не очищаються ідеально та може призвести до невизначеної поведінки, якщо налаштувати кілька разів.</p><h2 id="написання-sitl-unit-test" tabindex="-1">Написання SITL Unit Test <a class="header-anchor" href="#написання-sitl-unit-test" aria-label="Permalink to &quot;Написання SITL Unit Test&quot;">​</a></h2><p>Модульні тести SITL слід використовувати, коли вам конкретно потрібні всі компоненти контролера польоту – водії, час тощо. Ці тести виконуються повільніше (1 с+ для кожного нового модуля) і їх важче налагодити, тому їх слід використовувати лише за необхідності.</p><p>Кроки для створення нових модульних тестів SITL такі:</p><ol><li><p>Перегляньте зразок <a href="https://github.com/PX4/PX4-Autopilot/blob/release/1.15/src/include/unit_test.h" target="_blank" rel="noreferrer">Unittest-класу</a>.</p></li><li><p>Створіть новий файл .cpp у тестах <a href="https://github.com/PX4/PX4-Autopilot/tree/release/1.15/src/systemcmds/tests" target="_blank" rel="noreferrer">tests</a> із назвою <strong>test_[description].cpp</strong>.</p></li><li><p>У <strong>test_[description].cpp</strong> включається базовий unittest-class unit_test.h<code>&lt;unit_test.h&gt;</code> і всі файли, необхідні для написання тесту для нової функції.</p></li><li><p>У межах <strong>test_[description].cpp</strong> створіть клас <code>[Description]Test</code>, який успадковує <code>UnitTest</code>.</p></li><li><p>У класі <code>[Description]Test </code>оголосите відкритий метод <code>virtual bool run_tests()</code>.</p></li><li><p>У класі <code>[Description]Test</code> оголосити всі приватні методи, необхідні для тестування відповідної функції (<code>test1()</code>, <code>test2()</code>,...).</p></li><li><p>У межах <strong>test_[description].cpp</strong> реалізуйте метод <code>run_tests()</code>, де запускатиметься кожен тест [1,2,...].</p></li><li><p>У <strong>test_[description].cpp</strong> реалізуйте різні тести.</p></li><li><p>У нижній частині <strong>test_[description].cpp</strong> оголосите тест.</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ut_declare_test_c</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(test_[description], [</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">Description</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]Test)</span></span></code></pre></div><p>Тут є шаблон:</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#include</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &lt;unit_test.h&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">#include</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> &quot;[new feature].h&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">class</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [Description]Test : public UnitTest</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    virtual</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> bool</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> run_tests</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">private:</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    bool</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> test1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    bool</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> test2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">();</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">};</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">bool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [Description]</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Test</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">run_tests</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    ut_run_test</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(test1)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    ut_run_test</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(test2)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (_tests_failed </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">bool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [Description]</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Test</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">test1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ut_[name of one of the unit test functions](...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ut_[name of one of the unit test functions](...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">bool</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> [Description]</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Test</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">::</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">test2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">{</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ut_[name of one of the unit test functions](...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ut_[name of one of the unit test functions](...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> true</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">...</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ut_declare_test_c</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(test_[description], [</span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">Description</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]Test)</span></span></code></pre></div><p>Зауважте, що <code>ut_[назва однієї з функцій модульного тестування]</code> відповідає одній із функцій модульного тестування, визначених у <a href="https://github.com/PX4/PX4-Autopilot/blob/release/1.15/src/include/unit_test.h" target="_blank" rel="noreferrer">unit_test.h</a>.</p></li><li><p>У <a href="https://github.com/PX4/PX4-Autopilot/blob/release/1.15/src/systemcmds/tests/tests_main.h" target="_blank" rel="noreferrer">tests_main.h</a> визначте новий тест:</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">extern</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> test_[description](</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">int</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> argc, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">char</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> *</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">argv[]);</span></span></code></pre></div></li><li><p>У <a href="https://github.com/PX4/PX4-Autopilot/blob/release/1.15/src/systemcmds/tests/tests_main.c" target="_blank" rel="noreferrer">tests_main.c</a> додайте назву опису, тестову функцію та параметр:</p><div class="language-cpp vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">cpp</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">} tests[] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    {</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;[description]&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, test_[description], OPTION},</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre></div><p><code>OPTION</code> може бути <code>OPT_NOALLTEST</code>,<code>OPT_NOJIGTEST</code> або <code>0</code> і розглядається, якщо в оболонці px4 викликається одна з двох команд:</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pxh&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tests</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> all</span></span></code></pre></div><p>або</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">pxh&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tests</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> jig</span></span></code></pre></div><p>Якщо тест має параметр <code>OPT_NOALLTEST</code>, тоді цей тест буде виключено під час виклику <code>tests all</code>. Те саме стосується <code>OPT_NOJITEST</code>, коли викликається команда <code>test jig</code>. Варіант <code>0</code> означає, що тест ніколи не виключається, і це те, що хоче використовувати більшість розробників.</p></li><li><p>Додайте тест <code>test_[description].cpp</code> до <a href="https://github.com/PX4/PX4-Autopilot/blob/release/1.15/src/systemcmds/tests/CMakeLists.txt" target="_blank" rel="noreferrer">CMakeLists.txt</a>.</p></li></ol><h2 id="тестування-на-локальніи-машині" tabindex="-1">Тестування на локальній машині <a class="header-anchor" href="#тестування-на-локальніи-машині" aria-label="Permalink to &quot;Тестування на локальній машині&quot;">​</a></h2><p>Запустіть повний список модульних тестів GTest, функціональних тестів GTest і модульних тестів SITL прямо з bash:</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">make</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tests</span></span></code></pre></div><p>Окремі тестові двійкові файли GTest знаходяться в каталозі <code>build/px4_sitl_test/</code> і можуть бути запущені безпосередньо в налагоджувачі більшості IDE.</p><p>Фільтр, щоб запустити лише підмножину тестів, використовуючи регулярний вираз для імені ctest за допомогою цієї команди:</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">make</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tests</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> TESTFILTER=</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">regex</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> filter</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> expressio</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">n</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span></span></code></pre></div><p>Наприклад:</p><ul><li><code>make tests TESTFILTER=unit</code> лише запускає GTest unit tests</li><li><code>make tests TESTFILTER=sitl</code> лише запускає simulation tests</li><li><code>make tests TESTFILTER=Attitude</code> лише запускає <code>AttitudeControl</code> test</li></ul>`,26),l=[n];function p(h,k,r,o,d,c){return t(),i("div",null,l)}const u=s(e,[["render",p]]);export{g as __pageData,u as default};
