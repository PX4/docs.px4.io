import{_ as e}from"./chunks/flamegraph-example.CBi_68T9.js";import{_ as i,c as s,o as a,ab as t}from"./chunks/framework.CUflZczI.js";const m=JSON.parse(`{"title":"Poor Man's Sampling Profiler","description":"","frontmatter":{},"headers":[],"relativePath":"zh/debug/profiling.md","filePath":"zh/debug/profiling.md"}`),h={name:"zh/debug/profiling.md"},n=t(`<h1 id="poor-man-s-sampling-profiler" tabindex="-1">Poor Man&#39;s Sampling Profiler <a class="header-anchor" href="#poor-man-s-sampling-profiler" aria-label="Permalink to &quot;Poor Man&#39;s Sampling Profiler&quot;">​</a></h1><p>This section describes how you can use the <a href="https://github.com/PX4/PX4-Autopilot/blob/release/1.15/platforms/nuttx/Debug/poor-mans-profiler.sh" target="_blank" rel="noreferrer">Poor Man&#39;s Sampling Profiler</a> (PMSP) shell script to assess the performance of PX4. This is an implementation of a known method originally invented by <a href="https://poormansprofiler.org/" target="_blank" rel="noreferrer">Mark Callaghan and Domas Mituzas</a>.</p><h2 id="方法" tabindex="-1">方法 <a class="header-anchor" href="#方法" aria-label="Permalink to &quot;方法&quot;">​</a></h2><p>PMSP 是一种 shell 脚本,它通过定期中断固件的执行来运行，便对当前堆栈跟踪进行采样。 采样的堆栈跟踪将追加到文本文件中。 Once sampling is finished (which normally takes about an hour or more), the collected stack traces are <em>folded</em>. The result of <em>folding</em> is another text file that contains the same stack traces, except that all similar stack traces (i.e. those that were obtained at the same point in the program) are joined together, and the number of their occurrences is recorded. 然后将折叠的堆栈输入到可视化脚本中，为此，我们使用了 <a href="http://www.brendangregg.com/flamegraphs.html" target="_blank" rel="noreferrer">FlameGraph--开源堆栈跟踪可视化 </a>。</p><h2 id="基本用法" tabindex="-1">基本用法 <a class="header-anchor" href="#基本用法" aria-label="Permalink to &quot;基本用法&quot;">​</a></h2><h3 id="prerequisites" tabindex="-1">Prerequisites <a class="header-anchor" href="#prerequisites" aria-label="Permalink to &quot;Prerequisites&quot;">​</a></h3><p>探查器的基本用法可通过生成系统使用。 例如，下面的命令生成和探查出 px4_fmu-v4pro 目标的10000个样本（提取 <em>FlameGraph</em> 并根据需要将其添加到路径中）。 You will then need a <a href="./../debug/swd_debug.html#debug-probes">debug probe</a> (such as the DroneCode Probe), to run the GDB server and interact with the board.</p><h3 id="determine-the-debugger-device" tabindex="-1">Determine the Debugger Device <a class="header-anchor" href="#determine-the-debugger-device" aria-label="Permalink to &quot;Determine the Debugger Device&quot;">​</a></h3><p>The <code>poor-mans-profiler.sh</code> automatically detects and uses the correct USB device if you use it with a <a href="./../debug/probe_bmp.html#dronecode-probe">DroneCode Probe</a>. If you use a different kind of probe you may need to pass in the specific <em>device</em> on which the debugger is located. You can use the bash command <code>ls -alh /dev/serial/by-id/</code> to enumerate the possible devices on Ubuntu. For example the following devices are enumerated with a Pixhawk 4 and DroneCode Probe connected over USB:</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">user@ubuntu:~/PX4-Autopilot$</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ls</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -alh</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /dev/serial/by-id/</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">total</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">drwxr-xr-x</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> root</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> root</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 100</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Apr</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 23</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 18:57</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> .</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">drwxr-xr-x</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> root</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> root</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  80</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Apr</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 23</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 18:48</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ..</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">lrwxrwxrwx</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> root</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> root</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  13</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Apr</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 23</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 18:48</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> usb-3D_Robotics_PX4_FMU_v5.x_0-if00</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> -</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ../../ttyACM0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">lrwxrwxrwx</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> root</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> root</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  13</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Apr</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 23</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 18:57</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> usb-Black_Sphere_Technologies_Black_Magic_Probe_BFCCB401-if00</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> -</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ../../ttyACM1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">lrwxrwxrwx</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> root</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> root</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  13</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Apr</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 23</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 18:57</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> usb-Black_Sphere_Technologies_Black_Magic_Probe_BFCCB401-if02</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> -</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ../../ttyACM2</span></span></code></pre></div><p>In this case, the script would automatically pick up the device named <code>*Black_Magic_Probe*-if00</code>. But if you were using a different device you would be able discover the appropriate id from the listing above.</p><p>Then pass in the appropriate device using the <code>--gdbdev</code> argument like this:</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./poor-mans-profiler.sh</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --elf=build/px4_fmu-v4_default/px4_fmu-v4_default.elf</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --nsamples=30000</span></span></code></pre></div><h3 id="running" tabindex="-1">Running <a class="header-anchor" href="#running" aria-label="Permalink to &quot;Running&quot;">​</a></h3><p>在火焰图上，水平水平表示堆叠帧，而每个帧的宽度与采样次数成正比。 For example, the following command builds and profiles px4_fmu-v4pro target with 10000 samples (fetching <em>FlameGraph</em> and adding it to the path as needed).</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./poor-mans-profiler.sh</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --elf=build/px4_fmu-v4_default/px4_fmu-v4_default.elf</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --nsamples=30000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --append</span></span></code></pre></div><p>For more control over the build process, including setting the number of samples, see the <a href="#implementation">Implementation</a>.</p><h2 id="理解输出" tabindex="-1">理解输出 <a class="header-anchor" href="#理解输出" aria-label="Permalink to &quot;理解输出&quot;">​</a></h2><p>A screenshot of an example output is provided below (note that it is not interactive here):</p><p><img src="`+e+'" alt="FlameGraph Example"></p><p>PMSP 使用 GDB 收集堆栈跟踪。 目前，它使用 <code>arm-none-eabi-gdb</code>，今后可能会添加其他工具链。</p><h2 id="可能的问题" tabindex="-1">可能的问题 <a class="header-anchor" href="#可能的问题" aria-label="Permalink to &quot;可能的问题&quot;">​</a></h2><p>为了能够映射内存地址到符号，脚本需要被当前运行的文件中提及。 这个是在 <code>--elf=&amp;lt;file&amp;gt;</code> 的选项帮助下完成的，该选项需要一个指向当前执行ELF位置的路径来执行（相对于储存库的root）。</p><ul><li><p>如果 GDB 出现故障，脚本可能无法检测到该问题，并继续运行。 在这种情况下，显然不会产生可用的堆栈。 为了避免这种情况，用户应定期检查文件 <code>/tmp/pmpn-gdberr.log</code>，其中包含最近调用 GDB 的 stderr 输出。 将来，应修改脚本以在安静模式下调用 GDB，在安静模式下，它将通过其退出代码指示问题。</p></li><li><p>有时 GDB 一直运行，同时采样堆栈跟踪。 在此失败期间，目标将无限期停止。 解决方案是手动中止脚本，然后使用 <code>--append</code> 选项再次重新启动它。 将来，应修改脚本以对每次 GDB 调用强制执行超时。</p></li><li><p>不支持多线程环境。 这不会影响单个核心嵌入式目标，因为它们总是在一个线程中执行，但这一限制使探查器与许多其他应用程序不兼容。 将来，应修改堆栈文件夹以支持每个示例的多个堆栈跟踪。</p></li></ul><h2 id="实现" tabindex="-1">实现 <a class="header-anchor" href="#实现" aria-label="Permalink to &quot;实现&quot;">​</a></h2><p>The script is located at <a href="https://github.com/PX4/PX4-Autopilot/blob/release/1.15/platforms/nuttx/Debug/poor-mans-profiler.sh" target="_blank" rel="noreferrer">/platforms/nuttx/Debug/poor-mans-profiler.sh</a> Once launched, it will perform the specified number of samples with the specified time interval. Collected samples will be stored in a text file in the system temp directory (typically <code>/tmp</code>). Once sampling is finished, the script will automatically invoke the stack folder, the output of which will be stored in an adjacent file in the temp directory. If the stacks were folded successfully, the script will invoke the <em>FlameGraph</em> script and store the result in an interactive SVG file. Please note that not all image viewers support interactive images; it is recommended to open the resulting SVG in a web browser.</p><p>The FlameGraph script must reside in the <code>PATH</code>, otherwise PMSP will refuse to launch.</p><p>PMSP uses GDB to collect the stack traces. Currently it uses <code>arm-none-eabi-gdb</code>, other toolchains may be added in the future.</p><p>In order to be able to map memory locations to symbols, the script needs to be referred to the executable file that is currently running on the target. This is done with the help of the option <code>--elf=&lt;file&gt;</code>, which expects a path (relative to the root of the repository) pointing to the location of the currently executing ELF.</p><p>该想法的功劳归属 <a href="https://dom.as/2009/02/15/poor-mans-contention-profiling/" target="_blank" rel="noreferrer">Mark Callaghan and Domas Mituzas</a>。</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./poor-mans-profiler.sh</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --elf=build/px4_fmu-v4_default/px4_fmu-v4_default.elf</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --nsamples=30000</span></span></code></pre></div><p>Note that every launch of the script will overwrite the old stacks. Should you want to append to the old stacks rather than overwrite them, use the option <code>--append</code>:</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./poor-mans-profiler.sh</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --elf=build/px4_fmu-v4_default/px4_fmu-v4_default.elf</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --nsamples=30000</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --append</span></span></code></pre></div><p>As one might suspect, <code>--append</code> with <code>--nsamples=0</code> will instruct the script to only regenerate the SVG without accessing the target at all.</p><p>Please read the script for a more in depth understanding of how it works.</p>',35),l=[n];function r(p,o,d,k,c,g){return a(),s("div",null,l)}const f=i(h,[["render",r]]);export{m as __pageData,f as default};
