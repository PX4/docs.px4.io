import{_ as s,c as i,o as a,ab as e}from"./chunks/framework.CUflZczI.js";const F=JSON.parse('{"title":"STM32 Bootloader","description":"","frontmatter":{},"headers":[],"relativePath":"en/software_update/stm32_bootloader.md","filePath":"en/software_update/stm32_bootloader.md"}'),t={name:"en/software_update/stm32_bootloader.md"},l=e(`<h1 id="stm32-bootloader" tabindex="-1">STM32 Bootloader <a class="header-anchor" href="#stm32-bootloader" aria-label="Permalink to &quot;STM32 Bootloader&quot;">​</a></h1><p>The code for the PX4 bootloader is available from the Github <a href="https://github.com/px4/bootloader" target="_blank" rel="noreferrer">Bootloader</a> repository.</p><h2 id="supported-boards" tabindex="-1">Supported Boards <a class="header-anchor" href="#supported-boards" aria-label="Permalink to &quot;Supported Boards&quot;">​</a></h2><ul><li>FMUv2 (Pixhawk 1, STM32F4)</li><li>FMUv3 (Pixhawk 2, STM32F4)</li><li>FMUv4 (Pixracer 3 and Pixhawk 3 Pro, STM32F4)</li><li>FMUv5 (Pixhawk 4, STM32F7)</li><li>TAPv1 (TBA, STM32F4)</li><li>ASCv1 (TBA, STM32F4)</li></ul><h2 id="building-the-bootloader" tabindex="-1">Building the Bootloader <a class="header-anchor" href="#building-the-bootloader" aria-label="Permalink to &quot;Building the Bootloader&quot;">​</a></h2><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">git</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> clone</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> https://github.com/PX4/Bootloader.git</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">cd</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> Bootloader</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">git</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> submodule</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> init</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">git</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> submodule</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> update</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">make</span></span></code></pre></div><p>After this step a range of elf files for all supported boards are present in the Bootloader directory.</p><h2 id="flashing-the-bootloader" tabindex="-1">Flashing the Bootloader <a class="header-anchor" href="#flashing-the-bootloader" aria-label="Permalink to &quot;Flashing the Bootloader&quot;">​</a></h2><div class="warning custom-block"><p class="custom-block-title">WARNING</p><p>The right power sequence is critical for some boards to allow JTAG / SWD access. Follow these steps exactly as described.</p></div><p>The instructions below are valid for a Blackmagic / Dronecode probe. Other JTAG probes will need different but similar steps. Developers attempting to flash the bootloader should have the required knowledge. If you do not know how to do this you probably should reconsider if you really need to change anything about the bootloader.</p><p>The sequence is</p><ol><li>Disconnect the JTAG cable</li><li>Connect the USB power cable</li><li>Connect the JTAG cable</li></ol><h3 id="black-magic-dronecode-probe" tabindex="-1">Black Magic / Dronecode Probe <a class="header-anchor" href="#black-magic-dronecode-probe" aria-label="Permalink to &quot;Black Magic / Dronecode Probe&quot;">​</a></h3><h4 id="using-the-right-serial-port" tabindex="-1">Using the right serial port <a class="header-anchor" href="#using-the-right-serial-port" aria-label="Permalink to &quot;Using the right serial port&quot;">​</a></h4><ul><li>On LINUX: <code>/dev/serial/by-id/usb-Black_Sphere_XXX-if00</code></li><li>On MAC OS: Make sure to use the cu.xxx port, not the tty.xxx port: <code>tar ext /dev/tty.usbmodemDDEasdf</code></li></ul><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">arm-none-eabi-gdb</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">gdb</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tar</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ext</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /dev/serial/by-id/usb-Black_Sphere_XXX-if00</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">gdb</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mon</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> swdp_scan</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">gdb</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">attach</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">gdb</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mon</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> option</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> erase</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">gdb</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mon</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> erase_mass</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">gdb</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">load</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tapv1_bl.elf</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">        ...</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">        Transfer</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> rate:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 17</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> KB/sec,</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 828</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> bytes/write.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">gdb</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">kill</span></span></code></pre></div><h3 id="j-link" tabindex="-1">J-Link <a class="header-anchor" href="#j-link" aria-label="Permalink to &quot;J-Link&quot;">​</a></h3><p>These instructions are for the <a href="https://www.segger.com/jlink-gdb-server.html" target="_blank" rel="noreferrer">J-Link GDB server</a>.</p><h4 id="prerequisites" tabindex="-1">Prerequisites <a class="header-anchor" href="#prerequisites" aria-label="Permalink to &quot;Prerequisites&quot;">​</a></h4><p><a href="https://www.segger.com/downloads/jlink" target="_blank" rel="noreferrer">Download the J-Link software</a> from the Segger website and install it according to their instructions.</p><h4 id="run-the-jlink-gdb-server" tabindex="-1">Run the JLink GDB server <a class="header-anchor" href="#run-the-jlink-gdb-server" aria-label="Permalink to &quot;Run the JLink GDB server&quot;">​</a></h4><p>The command below is used to run the server for flight controllers that use the STM32F427VI SoC:</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">JLinkGDBServer</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -select</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> USB=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -device</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> STM32F427VI</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -if</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> SWD-DP</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -speed</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 20000</span></span></code></pre></div><p>The <code>--device</code>/SoC for common targets is:</p><ul><li><strong>FMUv2, FMUv3, FMUv4, aerofc-v1, mindpx-v2:</strong> STM32F427VI</li><li><strong>px4_fmu-v4pro:</strong> STM32F469II</li><li><strong>px4_fmu-v5:</strong> STM32F765II</li><li><strong>crazyflie:</strong> STM32F405RG</li></ul><h4 id="connect-gdb" tabindex="-1">Connect GDB <a class="header-anchor" href="#connect-gdb" aria-label="Permalink to &quot;Connect GDB&quot;">​</a></h4><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">arm-none-eabi-gdb</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">gdb</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">tar</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> ext</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> :2331</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">gdb</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">load</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> aerofcv1_bl.elf</span></span></code></pre></div><h3 id="troubleshooting" tabindex="-1">Troubleshooting <a class="header-anchor" href="#troubleshooting" aria-label="Permalink to &quot;Troubleshooting&quot;">​</a></h3><p>If any of the commands above are not found, you are either not using a Blackmagic probe or its software is outdated. Upgrade the on-probe software first.</p><p>If this error message occurs:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>Error erasing flash with vFlashErase packet</span></span></code></pre></div><p>Disconnect the target (while leaving JTAG connected) and run</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mon</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tpwr</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> disable</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">swdp_scan</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">attach</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">load</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> tapv1_bl.elf</span></span></code></pre></div><p>This will disable target powering and attempt another flash cycle.</p>`,34),n=[l];function h(r,p,o,k,d,c){return a(),i("div",null,n)}const b=s(t,[["render",h]]);export{F as __pageData,b as default};
