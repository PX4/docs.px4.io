import{_ as s,c as i,o as a,ab as n}from"./chunks/framework.CUflZczI.js";const c=JSON.parse('{"title":"uORB 消息","description":"","frontmatter":{},"headers":[],"relativePath":"zh/middleware/uorb.md","filePath":"zh/middleware/uorb.md"}'),e={name:"zh/middleware/uorb.md"},t=n(`<h1 id="uorb-消息" tabindex="-1">uORB 消息 <a class="header-anchor" href="#uorb-消息" aria-label="Permalink to &quot;uORB 消息&quot;">​</a></h1><h2 id="简介" tabindex="-1">简介 <a class="header-anchor" href="#简介" aria-label="Permalink to &quot;简介&quot;">​</a></h2><p>uORB 是一种异步 <code>publish()</code>/<code>subscribe()</code> 的消息传递 API，用于进程或者线程间通信。</p><p>查看<a href="./../modules/hello_sky.html">教程</a>以了解如何在 C++ 中使用它。</p><p>作为很多应用程序依赖的uORB，很早便会在启动过程中自动启动。 使用命令 <code>uorb start</code>启动。 单元测试可以使用<code>uorb_tests</code>启动。</p><h2 id="添加新-topic-主题" tabindex="-1">添加新 Topic（主题） <a class="header-anchor" href="#添加新-topic-主题" aria-label="Permalink to &quot;添加新 Topic（主题）&quot;">​</a></h2><p>新的uORB主题通过在主PX4/Firmware 存储库中添加，也能通过在out-of-tree消息定义中添加。 有关添加树外 uORB 消息定义的信息，请参阅<a href="./../advanced/out_of_tree_modules.html#out-of-tree-uorb-message-definitions">本节</a>。</p><p>若要添加新主题，需要在 <code>msg</code> 目录中创建一个新的 <strong>.msg</strong> 文件，并将文件名添加到<code>msg/CMakeLists.txt</code> 列表中。 由此，将自动生成所需的 C/C++ 代码。</p><p>查看支持类型的现有 <code>msg</code> 文件。 消息还可以在其他消息中嵌套使用。</p><p>对于每个生成的 C/C + 结构体，都将添加一个 <code>uint64_t timestamp</code>字段。 此用于记录日志，因此请确保在发布时填充数据。</p><p>若要在代码中使用该主题，请包括头文件：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span>#include &lt;uORB/topics/topic_name.h&gt;</span></span></code></pre></div><p>通过在 <code>.msg</code> 文件中添加如下内容的行，可以将一条消息定义用于多个独立主题：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span># TOPICS mission offboard_mission onboard_mission</span></span></code></pre></div><p>然后在代码中，将它们用作主题 id: <code>ORB_ID(offboard_mission)</code>。</p><h2 id="发布" tabindex="-1">发布 <a class="header-anchor" href="#发布" aria-label="Permalink to &quot;发布&quot;">​</a></h2><p>发布主题可以在系统中的任何位置完成，包括中断上下文（由 <code>hrt_call</code> API 调用的函数）。 However, the topic needs to be advertised and published outside of an interrupt context (at least once) before it can be published in an interrupt context.</p><h2 id="主题列表和监听-listener" tabindex="-1">主题列表和监听（Listener） <a class="header-anchor" href="#主题列表和监听-listener" aria-label="Permalink to &quot;主题列表和监听（Listener）&quot;">​</a></h2><div class="info custom-block"><p class="custom-block-title">The <code>listener</code> command is only available on Pixracer (FMUv4) and Linux / OS X.</p></div><p>列出所有主题，列出文件句柄：</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ls</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> /obj</span></span></code></pre></div><p>要监听一个主题内容中五条信息，运行监听器：</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">listener</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> sensor_accel</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 5</span></span></code></pre></div><p>输出是n次主题正文：</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">TOPIC:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> sensor_accel</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> #3</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">timestamp:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 84978861</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">integral_dt:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 4044</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">error_count:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">x:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">y:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">z:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 100</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">x_integral:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">y_integral:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">z_integral:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">temperature:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 46</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">range_m_s2:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 78</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">scaling:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">TOPIC:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> sensor_accel</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> #4</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">timestamp:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 85010833</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">integral_dt:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 3980</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">error_count:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">x:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">y:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 2</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">z:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 100</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">x_integral:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">y_integral:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">z_integral:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">temperature:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 46</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">range_m_s2:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 78</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">scaling:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span></code></pre></div><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>在 NuttX上的系统 (Pixhawk, Pixracer, 等) <code>侦听器</code> 命令可以从 <em>QGroundControl</em> MAVLink 控制台调用来查看传感器和其他主题的值。 这是一个非常实用的调试工具，应为它可以在QGC通过无线连接的时候使用（例如，当机体在飞行中）。 有关详细信息，请参阅 <a href="./../debug/sensor_uorb_topic_debugging.html">传感器/主题调试 </a>。</p></div><h3 id="uorb-top-命令" tabindex="-1">uorb top 命令 <a class="header-anchor" href="#uorb-top-命令" aria-label="Permalink to &quot;uorb top 命令&quot;">​</a></h3><p>命令 <code>uorb top</code> 实时显示每个主题的发布频率：</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">update:</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> 1s,</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> num</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> topics:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 77</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">TOPIC</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> NAME</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">                        INST</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> #SUB #MSG #LOST #QSIZE</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">actuator_armed</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                       0</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    6</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    4</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">     0</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">actuator_controls_0</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                  0</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    7</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  242</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  1044</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">battery_status</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                       0</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    6</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  500</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  2694</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">commander_state</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                      0</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    1</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   98</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    89</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">control_state</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                        0</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    4</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  242</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   433</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ekf2_innovations</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                     0</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    1</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  242</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   223</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">ekf2_timestamps</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                      0</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    1</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  242</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    23</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">estimator_status</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                     0</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    3</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  242</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   488</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">mc_att_ctrl_status</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                   0</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    0</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  242</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">     0</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sensor_accel</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                         0</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    1</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  242</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">     0</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sensor_accel</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                         1</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    1</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  249</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    43</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sensor_baro</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                          0</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    1</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   42</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">     0</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">sensor_combined</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">                      0</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    6</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  242</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">   636</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span></span></code></pre></div><p>列分别是：主题名字，多实例索引值，订阅者数量，发布频率（Hz），每秒丢失的信息数（对所有订阅者）和队列大小。</p><h2 id="多实例" tabindex="-1">多实例 <a class="header-anchor" href="#多实例" aria-label="Permalink to &quot;多实例&quot;">​</a></h2><p>uORB 提供了一种通过 <code>orb_advertise_multi</code> 发布同一主题的多个独立实例的机制。 它将返回实例索引到发布器。 然后, 订阅者必须通过<code>orb_subscribe_multi</code>选择订阅哪个实例（<code>orb_subscribe</code> 将订阅第一个实例）。 多实例是很有用的，例如，如果系统有几个同类型的传感器。</p><p>确保不要再同一个主题上弄混 <code>orb_advertise_multi</code> 和<code>orb_advertise</code></p><p>The full API is documented in <a href="https://github.com/PX4/PX4-Autopilot/blob/release/1.15/platforms/common/uORB/uORBManager.hpp" target="_blank" rel="noreferrer">platforms/common/uORB/uORBManager.hpp</a>.</p><p><a id="deprecation"></a></p><h2 id="消息-字段弃用" tabindex="-1">消息/字段弃用 <a class="header-anchor" href="#消息-字段弃用" aria-label="Permalink to &quot;消息/字段弃用&quot;">​</a></h2><p>由于有外部工具使用日志文件中的 uORB 消息，例如 <a href="https://github.com/PX4/flight_review" target="_blank" rel="noreferrer">飞行评论</a>， 在更新现有信息时需要考虑到某些方面：</p><ul><li>如果有充分理由进行更新，更改外部工具所依赖的现有字段或信息通常是可以接受的。 尤其是对于断开对 <em>航班评论</em>的更改， <em>飞行审查</em> 必须先更新才能将代码合并到 <code>主</code>。</li><li>为了使外部工具能够可靠地区分两个消息版本，必须遵循以下步骤： <ul><li>已删除或重命名的消息必须添加到 <a href="https://github.com/PX4/PX4-Autopilot/blob/c5a6a60903455c3600f47e3c45ecaa48614559c8/msg/CMakeLists.txt#L189" target="_blank" rel="noreferrer">msg/CMakeLists.txt</a> 中的 <code>deprecated_msgs</code> 同时， <strong>.msg</strong> 文件需要删除。</li><li>Removed or renamed fields must be commented and marked as deprecated. For example <code>uint8 quat_reset_counter</code> would become <code># DEPRECATED: uint8 quat_reset_counter</code>. This is to ensure that removed fields (or messages) are not re-added in future.</li><li>In case of a semantic change (e.g. the unit changes from degrees to radians), the field must be renamed as well and the previous one marked as deprecated as above.</li></ul></li></ul>`,38),h=[t];function l(p,k,r,d,F,o){return a(),i("div",null,h)}const g=s(e,[["render",l]]);export{c as __pageData,g as default};
