import{_ as e}from"./chunks/ekf2_ev_delay_tuning.Bgxz8N1S.js";import{_ as t,c as a,o,ab as i}from"./chunks/framework.CUflZczI.js";const g=JSON.parse('{"title":"Visual Inertial Odometry (VIO)","description":"","frontmatter":{},"headers":[],"relativePath":"zh/computer_vision/visual_inertial_odometry.md","filePath":"zh/computer_vision/visual_inertial_odometry.md"}'),r={name:"zh/computer_vision/visual_inertial_odometry.md"},n=i('<h1 id="visual-inertial-odometry-vio" tabindex="-1">Visual Inertial Odometry (VIO) <a class="header-anchor" href="#visual-inertial-odometry-vio" aria-label="Permalink to &quot;Visual Inertial Odometry (VIO)&quot;">​</a></h1><p><em>视觉惯性里程计测距</em>（VIO）是一种<a href="./../computer_vision/README.html">计算机视觉</a>技术，用于估算3D<em>姿态</em>（local 位置和方向），相对于 <em>local</em> 起始位置的移动的机体 <em>速度</em>。 它通常用于在GPS不存在或不可靠的情况下（例如室内或在桥下飞行时）给载具导航。</p><p>VIO使用<a href="https://en.wikipedia.org/wiki/Visual_odometry" target="_blank" rel="noreferrer">视觉测距法</a>从相机图像中估计机身<em>姿态</em>，并结合机身IMU的惯性测量（以校正因不良的图像捕获导致的机身快速移动的错误）。</p><p>This topic gives guidance on configuring PX4 and a companion computer for a VIO setup.</p><div class="info custom-block"><p class="custom-block-title">The suggested setup uses ROS for routing VIO information to PX4. However, PX4 itself does not care about the source of messages, provided they are provided via the appropriate <a href="./../ros/external_position_estimation.html#px4-mavlink-integration">MAVLink Interface</a>.</p></div><h2 id="suggested-setup" tabindex="-1">Suggested Setup <a class="header-anchor" href="#suggested-setup" aria-label="Permalink to &quot;Suggested Setup&quot;">​</a></h2><p>A hardware and software setup for VIO is suggested in the sections below as an illustration of how to interface a VIO system with PX4. It makes use of an off-the-shelf tracking camera and a companion computer running ROS. ROS is used to read odometry information from the camera and supply it to PX4.</p><p>An example of a suitable tracking camera is the <a href="./../peripherals/camera_t265_vio.html">Intel® RealSense™ Tracking Camera T265</a>.</p><h3 id="相机安装" tabindex="-1">相机安装 <a class="header-anchor" href="#相机安装" aria-label="Permalink to &quot;相机安装&quot;">​</a></h3><p>将相机连接到机载计算机并将其安装到机架上：</p><ul><li>尽可能使镜头朝下安装相机（默认）。</li><li>Cameras are typically very sensitive to vibration; a soft mounting is recommended (e.g. using vibration isolation foam).</li></ul><h3 id="companion-setup" tabindex="-1">Companion Setup <a class="header-anchor" href="#companion-setup" aria-label="Permalink to &quot;Companion Setup&quot;">​</a></h3><p>To setup ROS and PX4:</p><ul><li>在机载计算机上安装和配置 <a href="./../ros/mavros_installation.html">MAVROS</a>。</li><li>Implement and run a ROS node to read data from the camera and publish the VIO odometry using MAVROS. <ul><li>See the <a href="#vio_ros_node">VIO ROS node</a> section below for details of the requirements for this node.</li></ul></li><li>按照<a href="#ekf2_tuning">下方</a>的说明调整 PX4 EKF2 估计器。</li><li>验证与飞控的连接。</li></ul><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>您可以使用*QGroundControl * 中的<a href="https://docs.qgroundcontrol.com/master/en/analyze_view/mavlink_inspector.html" target="_blank" rel="noreferrer"> MAVLink Inspector</a>来验证是否收到<code>ODOMETRY</code>或<code>VISION_POSITION_ESTIMATE</code>消息（或检查是否存在 <code>HEARTBEAT</code>消息，其组件ID为197（<code>MAV_COMP_ID_VISUAL_INERTIAL_ODOMETRY</code>）。</p></div><ul><li><a href="#verify_estimate">Verify that VIO is set up correctly</a> before your first flight!</li></ul><p><a id="vio_ros_node"></a></p><h3 id="ros-vio-node" tabindex="-1">ROS VIO node <a class="header-anchor" href="#ros-vio-node" aria-label="Permalink to &quot;ROS VIO node&quot;">​</a></h3><p>In this suggested setup, a ROS node is required to</p><ol><li>interface with the chosen camera or sensor hardware,</li><li>produce odometry messages containing the position estimate, which will be sent to PX4 using MAVROS, and</li><li>publish messages to indicate the VIO system status.</li></ol><p>The implementation of the ROS node will be specific to the camera used and will need to be developed to use the interface and drivers appropriate for the camera.</p><p>The odometry messages should be of the type <a href="http://docs.ros.org/en/noetic/api/nav_msgs/html/msg/Odometry.html" target="_blank" rel="noreferrer"><code>nav_msgs/Odometry</code></a> and published to the topic <code>/mavros/odometry/out</code>.</p><p>System status messages of the type <a href="https://github.com/mavlink/mavros/blob/master/mavros_msgs/msg/CompanionProcessStatus.msg" target="_blank" rel="noreferrer"><code>mavros_msgs/CompanionProcessStatus</code></a> should be published to the topic <code>/mavros/companion_process/status</code>. These should identify the component as <code>MAV_COMP_ID_VISUAL_INERTIAL_ODOMETRY</code> (197) and indicate the <code>state</code> of the system. Recommended status values are:</p><ul><li><code>MAV_STATE_ACTIVE</code> when the VIO system is functioning as expected,</li><li><code>MAV_STATE_CRITICAL</code> when the VIO system is functioning, but with low confidence, and</li><li><code>MAV_STATE_FLIGHT_TERMINATION</code> when the system has failed or the estimate confidence is unacceptably low.</li></ul><p><a id="ekf2_tuning"></a></p><h3 id="px4-调试" tabindex="-1">PX4 调试 <a class="header-anchor" href="#px4-调试" aria-label="Permalink to &quot;PX4 调试&quot;">​</a></h3><p>将相机连接到机载计算机并将其安装到框架：</p><table><thead><tr><th>参数</th><th>外部位置估计的设置</th></tr></thead><tbody><tr><td><a href="./../advanced_config/parameter_reference.html#EKF2_EV_CTRL">EKF2_EV_CTRL</a></td><td>Set <em>horizontal position fusion</em>, <em>vertical vision fusion</em>, <em>velocity fusion</em>, and <em>yaw fusion</em> according to your desired fusion model.</td></tr><tr><td><a href="./../advanced_config/parameter_reference.html#EKF2_HGT_REF">EKF2_HGT_REF</a></td><td>设置为 <em>Vision</em> 以使用视觉作为高度估计的主要来源。</td></tr><tr><td><a href="./../advanced_config/parameter_reference.html#EKF2_EV_DELAY">EKF2_EV_DELAY</a></td><td>设置为测量的时间戳和 &quot;实际&quot; 捕获时间之间的差异。 有关详细信息，请参阅 <a href="#tuning-EKF2_EV_DELAY">below</a>。</td></tr><tr><td><a href="./../advanced_config/parameter_reference.html#EKF2_EV_POS_X">EKF2_EV_POS_X</a>, <a href="./../advanced_config/parameter_reference.html#EKF2_EV_POS_Y">EKF2_EV_POS_Y</a>, <a href="./../advanced_config/parameter_reference.html#EKF2_EV_POS_Z">EKF2_EV_POS_Z</a></td><td>Set the position of the vision sensor with respect to the vehicle&#39;s body frame.</td></tr></tbody></table><p>这些参数可以在<em>QGroundControl</em>&gt;<strong>Vehicle Setup &gt; Parameters &gt; EKF2</strong>中设置（切记要使参数更改生效需要重启飞控）。</p><p>更多详情/附加信息，见： <a href="./../advanced_config/tuning_the_ecl_ekf.html#external-vision-system">ECL/EKF 概述 &amp; 调试 &gt; 外部视觉系统</a>。</p><p><a id="tuning-EKF2_EV_DELAY"></a></p><h4 id="ekf2-ev-delay-调参" tabindex="-1">EKF2_EV_DELAY 调参 <a class="header-anchor" href="#ekf2-ev-delay-调参" aria-label="Permalink to &quot;EKF2_EV_DELAY 调参&quot;">​</a></h4><p><a href="./../advanced_config/parameter_reference.html#EKF2_EV_DELAY">EKF2_EV_DELAY</a> is the <em>Vision Position Estimator delay relative to IMU measurements</em>. 换而言之，这是视觉系统时间戳和 IMU 时钟（ EKF2 “时基” ）记录的“实际”捕获时间之间的差异。</p><p>Technically this can be set to 0 if there is correct timestamping (not just arrival time) and timesync (e.g. NTP) between MoCap and (for example) ROS computers. 实际应用中，这可能需要进行一些基于经验的调整，因为通信链路中的延迟与具体设置非常相关。 It is rare that a system is set up with an entirely synchronised chain!</p><p>通过检查 IMU 速率和 EV 速率之间的偏移，可以从日志中获取对延迟的粗略估计：</p><p><img src="'+e+'" alt="ekf2_ev_delay 日志"></p><div class="tip custom-block"><p class="custom-block-title">TIP</p><p>注意 可以使用 <a href="./../dev_log/flight_log_analysis.html#flightplot">FlightPlot</a> 或类似的飞行分析工具生成一组外部数据与板载估计（如上）。</p></div><p>可以通过更改参数来进一步调整该值，以找到在动态变化中最低的 EKF 更新值。</p><p><a id="verify_estimate"></a></p><h2 id="检查-校验-vio-估计" tabindex="-1">检查/校验 VIO 估计 <a class="header-anchor" href="#检查-校验-vio-估计" aria-label="Permalink to &quot;检查/校验 VIO 估计&quot;">​</a></h2><div class="info custom-block"><p class="custom-block-title">The <a href="./../advanced_config/parameter_reference.html#MAV_ODOM_LP">MAV_ODOM_LP</a> parameter mentioned below was removed in PX4 v1.14. This section needs to be updated. </p></div><p>执行以下检查，以确保在首次飞行<em>之前</em> VIO 正常运行：</p><ul><li>设置 PX4 参数 <code>MAV_ODOM_LP</code> 为1。 然后PX4将接收到的外部姿态用MAVLink<a href="https://mavlink.io/en/messages/common.html#ODOMETRY" target="_blank" rel="noreferrer">ODOMETRY</a>消息回传。 您可以使用 <em>QGroundControl</em> 中的 <a href="https://docs.qgroundcontrol.com/master/en/analyze_view/mavlink_inspector.html" target="_blank" rel="noreferrer">MAVLink Inspector</a> 查看这些MAVLink 消息。</li><li>偏航机身，直到<code>ODOMETRY</code>消息的四元数非常接近单位四元数（w = 1，x = y = z = 0）。 <ul><li>At this point, the body frame is aligned with the reference frame of the external pose system.</li><li>如果在不使横滚或俯仰的情况下无法使四元数接近单位四元数，则机架可能仍存在俯仰或滚动偏移。 这种情况下不要再检查机架坐标系。</li></ul></li><li>Once aligned, you can pick the vehicle up from the ground and you should see the position&#39;s z coordinate decrease. Moving the vehicle in the forward direction should increase the position&#39;s x coordinate. Moving the vehicle to the right should increase the y coordinate.</li><li>Check that linear velocities in the message are expressed in the <em>FRD</em> body frame reference frame.</li><li>设置 PX4 参数 <code>MAV_ODOM_LP</code> 为 0。 PX4 将停止 <code>ODOMETRY</code> 消息回传。</li></ul><p>可以通过更改参数来进一步调整该值，以找到在动态变化中最低的EKF更新值。</p><ol><li><p>将无人机放在地面上，并开始流式传输<code>ODOMETRY</code>反馈（如上所述）。 油门杆推到最低并解锁。</p><p>此时，设置为位置控制模式。 如果切换成功，飞控会闪绿灯。 绿灯代表：你的外部位置信息已经注入到飞控中，并且位置控制模式已经切换成功。</p></li><li><p>油门杆放到中间位置（死区），以便无人机保持飞行高度。 提高操控杆会增加参考高度，降低操控杆会降低参考高度。 Similarly, the other stick will change the position over the ground.</p></li><li><p>Increase the value of the throttle stick and the vehicle will take off. Move it back to the middle immediately afterwards.</p></li><li><p>确保无人机可以保持位置。</p></li></ol><h2 id="故障处理" tabindex="-1">故障处理 <a class="header-anchor" href="#故障处理" aria-label="Permalink to &quot;故障处理&quot;">​</a></h2><p>First, make sure MAVROS is able to connect successfully to the flight controller.</p><p>如果连接正确， 常见问题 / 解决方案是：</p><ul><li><p><strong>问题：</strong> 当无人机飞行时发生漂移/飞走，但是当拿掉螺旋桨时不会发生漂移。</p><ul><li>If using the <a href="./../peripherals/camera_t265_vio.html">T265</a> try soft-mounting it (this camera is very sensitive to high-frequency vibrations).</li></ul></li><li><p><strong>问题：</strong> 启用 VIO 时产生了马桶效应。</p><ul><li>确保相机的方向与启动文件中的变换匹配。 使用 <em>QGroundControl</em> 中的 <a href="https://docs.qgroundcontrol.com/master/en/analyze_view/mavlink_inspector.html" target="_blank" rel="noreferrer">MAVLink Inspector</a> 验证来自 MAVROS 的 <code>ODOMETRY</code> 消息中的速度是否与 FRD (前右下)坐标系一致。</li></ul></li><li><p><strong>问题：</strong> 想使用视觉位置来做闭环，也想运行 GPS 。</p><ul><li>这确实很困难，因为当他们不同意时，就会混淆 EKF。 通过测试，仅使用视觉速度更为可靠（如果您想出一种使该配置可靠的方法，请告诉我们）。</li></ul></li></ul><h2 id="开发人员信息" tabindex="-1">开发人员信息 <a class="header-anchor" href="#开发人员信息" aria-label="Permalink to &quot;开发人员信息&quot;">​</a></h2><p>对扩展此实现感兴趣的开发人员（或编写另一种不依赖 ROS 的实现）应该看看 <a href="./../ros/external_position_estimation.html">使用视觉或运动捕获系统进行位置估计</a>。</p><p>本主题还说明了如何配置 VIO 来配合 LPE 估计器 一起使用（不推荐）。</p><h2 id="更多信息" tabindex="-1">更多信息 <a class="header-anchor" href="#更多信息" aria-label="Permalink to &quot;更多信息&quot;">​</a></h2><ul><li><a href="./../advanced_config/tuning_the_ecl_ekf.html#external-vision-system">ECL/EKF 概述 &amp; 调试 &gt; 外部视觉系统</a></li></ul>',54),s=[n];function l(d,c,h,m,p,u){return o(),a("div",null,s)}const v=t(r,[["render",l]]);export{g as __pageData,v as default};
